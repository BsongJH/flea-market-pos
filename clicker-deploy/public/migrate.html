<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ”„ Firebase ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-8">
  <div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-2xl p-8 shadow-lg">
      <h1 class="text-2xl font-bold mb-2">ğŸ”„ Firebase ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜</h1>
      <p class="text-gray-500 mb-6">ê¸°ì¡´ ë°ì´í„° â†’ ìƒˆ í†µí•© êµ¬ì¡°ë¡œ ë³€í™˜</p>

      <div class="space-y-4">
        <!-- Step 1 -->
        <div class="border rounded-lg p-4">
          <h2 class="font-bold text-lg mb-2">Step 1: í˜„ì¬ ë°ì´í„° í™•ì¸</h2>
          <button onclick="loadCurrentData()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
            ğŸ“¥ í˜„ì¬ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
          </button>
          <div id="currentData" class="mt-4 text-sm"></div>
        </div>

        <!-- Step 2 -->
        <div class="border rounded-lg p-4">
          <h2 class="font-bold text-lg mb-2">Step 2: ë³€í™˜ ë¯¸ë¦¬ë³´ê¸°</h2>
          <button onclick="previewMigration()" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600">
            ğŸ‘€ ë³€í™˜ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°
          </button>
          <div id="previewData" class="mt-4 text-sm"></div>
        </div>

        <!-- Step 3 -->
        <div class="border rounded-lg p-4">
          <h2 class="font-bold text-lg mb-2">Step 3: ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰</h2>
          <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4 text-sm text-yellow-800">
            âš ï¸ ì£¼ì˜: ì´ ì‘ì—…ì€ Firebase ë°ì´í„°ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤. ì‹¤í–‰ ì „ Step 1, 2ë¥¼ ë¨¼ì € í™•ì¸í•˜ì„¸ìš”.
          </div>
          <button onclick="executeMigration()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
            ğŸš€ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
          </button>
          <div id="migrationResult" class="mt-4 text-sm"></div>
        </div>

        <!-- Step 4: Rollback -->
        <div class="border rounded-lg p-4 border-red-200">
          <h2 class="font-bold text-lg mb-2 text-red-600">ë¡¤ë°± (ë¬¸ì œ ë°œìƒ ì‹œ)</h2>
          <button onclick="rollback()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">
            â†©ï¸ ì´ì „ êµ¬ì¡°ë¡œ ë³µì›
          </button>
          <div id="rollbackResult" class="mt-4 text-sm"></div>
        </div>
      </div>
    </div>

    <!-- ë¡œê·¸ -->
    <div class="bg-gray-800 text-green-400 rounded-lg p-4 mt-6 font-mono text-sm">
      <div class="text-gray-400 mb-2">ğŸ“‹ ë¡œê·¸:</div>
      <div id="log" class="max-h-60 overflow-y-auto"></div>
    </div>
  </div>

  <script>
    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyBxYlNs2yX9seyk52kQPH3_x3HnfyyORMw",
      authDomain: "sales-data-23e78.firebaseapp.com",
      projectId: "sales-data-23e78",
      storageBucket: "sales-data-23e78.firebasestorage.app",
      messagingSenderId: "844253337178",
      appId: "1:844253337178:web:f484c14cba402727627ffa"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ë¡œê·¸ í•¨ìˆ˜
    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const color = type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : 'text-gray-300';
      logDiv.innerHTML += `<div class="${color}">[${new Date().toLocaleTimeString()}] ${message}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    // í˜„ì¬ ë°ì´í„° ì €ì¥ìš©
    let currentData = {};
    let backupData = {};

    // Step 1: í˜„ì¬ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    async function loadCurrentData() {
      log('í˜„ì¬ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
      try {
        const collections = ['characters', 'simpleItems', 'inventory', 'sales', 'dailyRecords', 'taxRate', 'logs'];
        
        for (const name of collections) {
          const doc = await db.collection('store').doc(name).get();
          if (doc.exists) {
            currentData[name] = doc.data().value;
            log(`âœ“ ${name}: ${JSON.stringify(currentData[name]).substring(0, 100)}...`);
          } else {
            currentData[name] = null;
            log(`âœ— ${name}: ì—†ìŒ`, 'error');
          }
        }

        // ë°±ì—… ì €ì¥
        backupData = JSON.parse(JSON.stringify(currentData));

        // í™”ë©´ì— í‘œì‹œ
        const display = document.getElementById('currentData');
        display.innerHTML = `
          <div class="bg-gray-50 rounded-lg p-4 space-y-2">
            <div><strong>Characters:</strong> ${currentData.characters?.length || 0}ê°œ</div>
            <div><strong>SimpleItems:</strong> keyring ${currentData.simpleItems?.keyring?.length || 0}ê°œ, 
              sticker ${currentData.simpleItems?.sticker?.length || 0}ê°œ, 
              blindbag ${currentData.simpleItems?.blindbag?.length || 0}ê°œ</div>
            <div><strong>Inventory:</strong> ${Object.keys(currentData.inventory || {}).length}ê°œ ì•„ì´í…œ</div>
            <div><strong>Sales:</strong> ${currentData.sales?.length || 0}ê±´</div>
            <div><strong>DailyRecords:</strong> ${currentData.dailyRecords?.length || 0}ê±´</div>
          </div>
        `;

        log('ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!', 'success');
      } catch (error) {
        log('ì—ëŸ¬: ' + error.message, 'error');
      }
    }

    // Step 2: ë³€í™˜ ë¯¸ë¦¬ë³´ê¸°
    function previewMigration() {
      if (!currentData.characters) {
        log('ë¨¼ì € Step 1ì„ ì‹¤í–‰í•˜ì„¸ìš”.', 'error');
        return;
      }

      log('ë³€í™˜ ë¯¸ë¦¬ë³´ê¸° ìƒì„± ì¤‘...');

      // ìƒˆ products ë°°ì—´ ìƒì„±
      const products = [];
      const inventory = currentData.inventory || {};

      // 1. Clicker ìºë¦­í„°ë“¤
      (currentData.characters || []).forEach(char => {
        products.push({
          id: char.id,
          name: char.name,
          category: 'clicker',
          stock: inventory[char.id] || 0
        });
      });

      // 2. SimpleItems (keyring, sticker, blindbag)
      Object.entries(currentData.simpleItems || {}).forEach(([category, items]) => {
        (items || []).forEach(item => {
          products.push({
            id: item.id,
            name: item.name,
            category: category,
            price: item.price,
            stock: inventory[item.id] || 0
          });
        });
      });

      log(`ë³€í™˜ ì™„ë£Œ: ${products.length}ê°œ ìƒí’ˆ`);

      // í™”ë©´ì— í‘œì‹œ
      const display = document.getElementById('previewData');
      display.innerHTML = `
        <div class="bg-green-50 rounded-lg p-4">
          <div class="font-bold mb-2">ìƒˆ products ë°°ì—´ (${products.length}ê°œ):</div>
          <div class="max-h-60 overflow-y-auto text-xs bg-white p-2 rounded border">
            ${products.map(p => `
              <div class="py-1 border-b">
                <span class="font-medium">${p.name}</span>
                <span class="text-gray-400">(${p.category})</span>
                ${p.price ? `<span class="text-green-600">$${p.price}</span>` : ''}
                <span class="text-blue-600">ì¬ê³ : ${p.stock}</span>
              </div>
            `).join('')}
          </div>
        </div>
      `;

      // ì„ì‹œ ì €ì¥
      window.newProducts = products;
      log('ë¯¸ë¦¬ë³´ê¸° ì™„ë£Œ!', 'success');
    }

    // Step 3: ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
    async function executeMigration() {
      if (!window.newProducts) {
        log('ë¨¼ì € Step 2ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.', 'error');
        return;
      }

      if (!confirm('ì •ë§ ë§ˆì´ê·¸ë ˆì´ì…˜ì„ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ Firebase ë°ì´í„°ë¥¼ ìˆ˜ì •í•©ë‹ˆë‹¤.')) {
        return;
      }

      log('ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘...');

      try {
        // 1. ë°±ì—… ì €ì¥
        await db.collection('store').doc('backup_old_structure').set({
          value: backupData,
          createdAt: new Date().toISOString()
        });
        log('âœ“ ë°±ì—… ì €ì¥ ì™„ë£Œ');

        // 2. ìƒˆ products ì €ì¥
        await db.collection('store').doc('products').set({
          value: window.newProducts,
          updatedAt: new Date().toISOString()
        });
        log('âœ“ ìƒˆ products ì €ì¥ ì™„ë£Œ');

        // 3. ê¸°ì¡´ ì»¬ë ‰ì…˜ ìœ ì§€ (í˜¸í™˜ì„±)
        // characters, simpleItems, inventoryëŠ” ì¼ë‹¨ ìœ ì§€
        // ìƒˆ ì•± ë²„ì „ì´ ì•ˆì •í™”ë˜ë©´ ì‚­ì œ ê°€ëŠ¥

        // 4. ë§ˆì´ê·¸ë ˆì´ì…˜ í”Œë˜ê·¸ ì„¤ì •
        await db.collection('store').doc('migrationStatus').set({
          value: {
            version: 2,
            migratedAt: new Date().toISOString(),
            productsCount: window.newProducts.length
          },
          updatedAt: new Date().toISOString()
        });
        log('âœ“ ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ ì €ì¥ ì™„ë£Œ');

        document.getElementById('migrationResult').innerHTML = `
          <div class="bg-green-100 text-green-800 p-4 rounded-lg">
            âœ… ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ!<br>
            - ${window.newProducts.length}ê°œ ìƒí’ˆ ë³€í™˜ë¨<br>
            - ë°±ì—…ì´ 'backup_old_structure'ì— ì €ì¥ë¨
          </div>
        `;

        log('ğŸ‰ ë§ˆì´ê·¸ë ˆì´ì…˜ ì™„ë£Œ!', 'success');

      } catch (error) {
        log('ì—ëŸ¬: ' + error.message, 'error');
        document.getElementById('migrationResult').innerHTML = `
          <div class="bg-red-100 text-red-800 p-4 rounded-lg">
            âŒ ì—ëŸ¬ ë°œìƒ: ${error.message}
          </div>
        `;
      }
    }

    // ë¡¤ë°±
    async function rollback() {
      if (!confirm('ì •ë§ ì´ì „ êµ¬ì¡°ë¡œ ë¡¤ë°±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      log('ë¡¤ë°± ì‹œì‘...');

      try {
        // ë°±ì—… ë¶ˆëŸ¬ì˜¤ê¸°
        const backupDoc = await db.collection('store').doc('backup_old_structure').get();
        
        if (!backupDoc.exists) {
          log('ë°±ì—… ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error');
          return;
        }

        const backup = backupDoc.data().value;

        // ë³µì›
        for (const [key, value] of Object.entries(backup)) {
          if (value !== null) {
            await db.collection('store').doc(key).set({
              value: value,
              updatedAt: new Date().toISOString()
            });
            log(`âœ“ ${key} ë³µì›ë¨`);
          }
        }

        // products ì‚­ì œ
        await db.collection('store').doc('products').delete();
        log('âœ“ products ì‚­ì œë¨');

        // ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒíƒœ ì´ˆê¸°í™”
        await db.collection('store').doc('migrationStatus').delete();

        document.getElementById('rollbackResult').innerHTML = `
          <div class="bg-blue-100 text-blue-800 p-4 rounded-lg">
            âœ… ë¡¤ë°± ì™„ë£Œ! ì´ì „ êµ¬ì¡°ë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.
          </div>
        `;

        log('ğŸ”„ ë¡¤ë°± ì™„ë£Œ!', 'success');

      } catch (error) {
        log('ì—ëŸ¬: ' + error.message, 'error');
      }
    }
  </script>
</body>
</html>
