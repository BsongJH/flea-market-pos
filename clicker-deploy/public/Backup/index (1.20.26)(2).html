<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#2563eb">
  <title>ÌîåÎ¶¨ÎßàÏºì ÌåêÎß§ Í¥ÄÎ¶¨</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    * { -webkit-tap-highlight-color: transparent; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useMemo, useReducer } = React;

    // Firebase ÏÑ§Ï†ï
    const firebaseConfig = {
      apiKey: "AIzaSyBxYlNs2yX9seyk52kQPH3_x3HnfyyORMw",
      authDomain: "sales-data-23e78.firebaseapp.com",
      projectId: "sales-data-23e78",
      storageBucket: "sales-data-23e78.firebasestorage.app",
      messagingSenderId: "844253337178",
      appId: "1:844253337178:web:f484c14cba402727627ffa"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ============ Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ§Ï†ï ============
    const DEFAULT_CATEGORIES = [
      { id: 'clicker', name: 'ÌÅ¥Î¶¨Ïª§', nameEn: 'Clicker', emoji: 'üéØ', priceType: 'algorithm' },
      { id: 'keyring', name: 'ÌÇ§ÎßÅ', nameEn: 'Keyring', emoji: 'üîë', priceType: 'fixed' },
      { id: 'sticker', name: 'Ïä§Ìã∞Ïª§', nameEn: 'Sticker', emoji: '‚ú®', priceType: 'algorithm' },
      { id: 'blindbag', name: 'Blind Bag', nameEn: 'Blind Bag', emoji: 'üéÅ', priceType: 'fixed' }
    ];

    const CARD_OPTIONS = [
      { id: 'venmo', name: 'Venmo', emoji: 'üíô', hasTax: false },
      { id: 'zelle', name: 'Zelle', emoji: 'üíú', hasTax: false },
      { id: 'square', name: 'Square', emoji: '‚¨õ', hasTax: true }
    ];

    // ============ Í∏∞Î≥∏ Îç∞Ïù¥ÌÑ∞ ============
    const DEFAULT_PRODUCTS = [
      // Clickers
      { id: 'mew', name: 'Mew', category: 'clicker', stock: 10 },
      { id: 'shiny_mew', name: 'Shiny Mew', category: 'clicker', stock: 10 },
      { id: 'ditto', name: 'Ditto', category: 'clicker', stock: 10 },
      { id: 'shiny_ditto', name: 'Shiny Ditto', category: 'clicker', stock: 10 },
      { id: 'psyduck', name: 'Psyduck', category: 'clicker', stock: 10 },
      { id: 'gengar', name: 'Gengar', category: 'clicker', stock: 10 },
      { id: 'mewtwo', name: 'Mew Two', category: 'clicker', stock: 10 },
      { id: 'cubone', name: 'Cubone', category: 'clicker', stock: 10 },
      { id: 'bulbasaur', name: 'Bulbasaur', category: 'clicker', stock: 10 },
      { id: 'flareon', name: 'Flareon', category: 'clicker', stock: 10 },
      { id: 'vaporeon', name: 'Vaporeon', category: 'clicker', stock: 10 },
      { id: 'snorlax', name: 'Snorlax', category: 'clicker', stock: 10 },
      { id: 'vulpix', name: 'Vulpix', category: 'clicker', stock: 10 },
      { id: 'pikachu', name: 'Pikachu', category: 'clicker', stock: 10 },
      { id: 'charmander', name: 'Charmander', category: 'clicker', stock: 10 },
      { id: 'blastoise', name: 'Blastoise', category: 'clicker', stock: 10 },
      { id: 'eevee', name: 'Eevee', category: 'clicker', stock: 10 },
      { id: 'jolteon', name: 'Jolteon', category: 'clicker', stock: 10 },
      { id: 'squirtle', name: 'Squirtle', category: 'clicker', stock: 10 },
      { id: 'jigglypuff', name: 'Jigglypuff', category: 'clicker', stock: 10 },
      { id: 'umbreon', name: 'Umbreon', category: 'clicker', stock: 10 },
      // Keyrings
      { id: 'keyring1', name: 'Keyring A', category: 'keyring', price: 8, stock: 10 },
      { id: 'keyring2', name: 'Keyring B', category: 'keyring', price: 8, stock: 10 },
      { id: 'keyring3', name: 'Keyring C', category: 'keyring', price: 8, stock: 10 },
      // Stickers
      { id: 'sticker1', name: 'Sticker A', category: 'sticker', price: 5, stock: 10 },
      { id: 'sticker2', name: 'Sticker B', category: 'sticker', price: 5, stock: 10 },
      { id: 'sticker3', name: 'Sticker C', category: 'sticker', price: 5, stock: 10 },
      // Blind Bags
      { id: 'blindbag1', name: 'Blind Bag S', category: 'blindbag', price: 10, stock: 10 },
      { id: 'blindbag2', name: 'Blind Bag M', category: 'blindbag', price: 15, stock: 10 },
      { id: 'blindbag3', name: 'Blind Bag L', category: 'blindbag', price: 20, stock: 10 }
    ];

    // ============ Ïú†Ìã∏ Ìï®Ïàò ============
    const calculateClickerPrice = (qty) => qty <= 0 ? 0 : Math.floor(qty / 2) * 20 + (qty % 2) * 12;
    const calculateStickerPrice = (qty) => qty <= 0 ? 0 : Math.floor(qty / 2) * 5 + (qty % 2) * 3;
    const formatCurrency = (amount) => '$' + (amount || 0).toFixed(2);
    const formatDate = (d, lang) => new Date(d).toLocaleDateString(lang === 'ko' ? 'ko-KR' : 'en-US', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' });
    const formatDateShort = (d, lang) => new Date(d).toLocaleDateString(lang === 'ko' ? 'ko-KR' : 'en-US', { month: 'short', day: 'numeric' });
    const generateId = () => 'p_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

    // ============ Î≤àÏó≠ ============
    const TRANSLATIONS = {
      ko: {
        sales: 'ÌåêÎß§', history: 'Í∏∞Î°ù', title: 'ÌîåÎ¶¨ÎßàÏºì ÌåêÎß§ Í¥ÄÎ¶¨', subtitle: 'Ïû¨Í≥† & Îß§Ï∂ú Ìä∏ÎûòÏª§',
        todaySales: 'Ïò§Îäò Îß§Ï∂ú', currentList: 'ÌòÑÏû¨ Î™©Î°ù', totalSales: 'Ï¥ù Îß§Ï∂ú', cash: 'ÌòÑÍ∏à', card: 'Ïπ¥Îìú',
        taxIncluded: 'ÏÑ∏Í∏à Ìè¨Ìï®', items: 'Í∞ú', transactions: 'Í±¥', closeDay: 'Ïû•ÏÇ¨ ÎßàÎ¨¥Î¶¨',
        salesRecord: 'ÌåêÎß§ Í∏∞Î°ù', productMgmt: 'ÏÉÅÌíà Í¥ÄÎ¶¨', inventory: 'Ïû¨Í≥†', tapToAdd: 'ÌÉ≠ÌïòÎ©¥ +1',
        selected: 'ÏÑ†ÌÉùÎê®', clearAll: 'Ï†ÑÏ≤¥ Ï∑®ÏÜå', total: 'Ï¥ù', taxAmount: 'ÏÑ∏Í∏à',
        paymentMethod: 'Í≤∞Ï†ú Î∞©Ïãù', saleComplete: 'ÌåêÎß§ ÏôÑÎ£å', selectProduct: 'ÏÉÅÌíàÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî',
        memo: 'Î©îÎ™® (ÏÑ†ÌÉùÏÇ¨Ìï≠)', edit: 'ÏàòÏ†ï', cancel: 'Ï∑®ÏÜå', delete: 'ÏÇ≠Ï†ú', save: 'Ï†ÄÏû•', close: 'Îã´Í∏∞',
        applyTax: 'ÏÑ∏Ïú® Ï†ÅÏö©', taxRate: 'ÏÑ∏Ïú®', taxSetting: 'ÏÑ∏Ïú® ÏÑ§Ï†ï', taxForSquare: 'Ïä§ÌÄòÏñ¥ Í≤∞Ï†ú Ïãú Ï†ÅÏö©ÎêòÎäî ÏÑ∏Ïú®',
        noSalesRecord: 'ÌåêÎß§ Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§', salesHistory: 'ÌåêÎß§ Í∏∞Î°ù',
        dailyRecord: 'ÏùºÎ≥Ñ ÎßàÍ∞ê Í∏∞Î°ù', popularStats: 'Ïù∏Í∏∞ ÏÉÅÌíà ÌÜµÍ≥Ñ', exportCSV: 'CSV ÎÇ¥Î≥¥ÎÇ¥Í∏∞',
        noClosedRecord: 'ÎßàÍ∞ê Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§', detail: 'ÏÉÅÏÑ∏', restore: 'Î≥µÍµ¨',
        resetAll: 'Î™®Îì† Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî', week: '1Ï£º', month: '1Îã¨', custom: 'Ïª§Ïä§ÌÖÄ',
        totalRevenue: 'Ï¥ù Îß§Ï∂ú', soldCount: 'ÌåêÎß§Îüâ', transaction: 'Í±∞Îûò', noDataPeriod: 'Ìï¥Îãπ Í∏∞Í∞Ñ ÌåêÎß§ Í∏∞Î°ùÏù¥ ÏóÜÏäµÎãàÎã§',
        productManagement: 'ÏÉÅÌíà Í¥ÄÎ¶¨', newProduct: 'ÏÉà ÏÉÅÌíà Ïù¥Î¶Ñ', add: 'Ï∂îÍ∞Ä', price: 'Í∞ÄÍ≤©',
        editSale: 'ÌåêÎß§ ÏàòÏ†ï', customInput: 'ÏßÅÏ†ë ÏûÖÎ†•', addTax: '+ ÏÑ∏Í∏à', amount: 'Í∏àÏï°',
        closeDayConfirm: 'ÌåêÎß§ Í∏∞Î°ùÏùÑ ÎßàÍ∞êÌïòÏãúÍ≤†ÏäµÎãàÍπå?', tax: 'ÏÑ∏Í∏à', finalize: 'ÎßàÍ∞ê',
        detailRecord: 'ÏÉÅÏÑ∏ ÌåêÎß§ Í∏∞Î°ù', restoreThis: 'Ïù¥ Í∏∞Î°ù Î≥µÍµ¨ÌïòÍ∏∞',
        resetConfirm: 'Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?', resetWarning1: 'ÌåêÎß§ Í∏∞Î°ù ÏÇ≠Ï†ú', resetWarning2: 'ÎßàÍ∞ê Í∏∞Î°ù ÏÇ≠Ï†ú',
        resetWarning3: 'ÏÉÅÌíà Î™©Î°ù Ï¥àÍ∏∞Ìôî', resetWarning4: 'Ïû¨Í≥† Í∏∞Î≥∏Í∞íÏúºÎ°ú Î≥µÍµ¨', reset: 'Ï¥àÍ∏∞Ìôî', loading: 'Î°úÎî© Ï§ë...',
        firebaseMode: 'üî• Firebase Ïó∞Îèô', algorithmApplied: '2Í∞ú=20Î∂à Ìï†Ïù∏ Ï†ÅÏö©', stickerDeal: '2Í∞ú=$5 Ìï†Ïù∏ Ï†ÅÏö©', cancelled: 'Ï∑®ÏÜåÎê®',
        logs: 'Î≥ÄÍ≤Ω Î°úÍ∑∏', noLogs: 'Î°úÍ∑∏Í∞Ä ÏóÜÏäµÎãàÎã§',
        saleCreated: 'ÌåêÎß§ Îì±Î°ù', saleCancelled: 'ÌåêÎß§ Ï∑®ÏÜå', saleEdited: 'ÌåêÎß§ ÏàòÏ†ï', inventoryChanged: 'Ïû¨Í≥† ÏàòÏ†ï',
        clicker: 'ÌÅ¥Î¶¨Ïª§', keyring: 'ÌÇ§ÎßÅ', sticker: 'Ïä§Ìã∞Ïª§', blindbag: 'Blind Bag', mixed: 'Î≥µÌï©',
        stock: 'Ïû¨Í≥†', addProduct: 'ÏÉÅÌíà Ï∂îÍ∞Ä', editProduct: 'ÏÉÅÌíà ÏàòÏ†ï'
      },
      en: {
        sales: 'Sales', history: 'History', title: 'Flea Market POS', subtitle: 'Inventory & Sales Tracker',
        todaySales: "Today's Sales", currentList: 'Current List', totalSales: 'Total Sales', cash: 'Cash', card: 'Card',
        taxIncluded: 'Tax included', items: '', transactions: '', closeDay: 'Close Day',
        salesRecord: 'Sales Record', productMgmt: 'Products', inventory: 'Inventory', tapToAdd: 'Tap to +1',
        selected: 'Selected', clearAll: 'Clear All', total: 'Total', taxAmount: 'Tax',
        paymentMethod: 'Payment Method', saleComplete: 'Sale Complete', selectProduct: 'Select products',
        memo: 'Memo (optional)', edit: 'Edit', cancel: 'Cancel', delete: 'Delete', save: 'Save', close: 'Close',
        applyTax: 'Apply Tax', taxRate: 'Tax Rate', taxSetting: 'Tax Settings', taxForSquare: 'Tax rate applied to Square payments',
        noSalesRecord: 'No sales records', salesHistory: 'Sales History',
        dailyRecord: 'Daily Records', popularStats: 'Popular Items', exportCSV: 'Export CSV',
        noClosedRecord: 'No closed records', detail: 'Detail', restore: 'Restore',
        resetAll: 'Reset All Data', week: '1 Week', month: '1 Month', custom: 'Custom',
        totalRevenue: 'Revenue', soldCount: 'Sold', transaction: 'Txns', noDataPeriod: 'No sales data for this period',
        productManagement: 'Manage Products', newProduct: 'New product name', add: 'Add', price: 'Price',
        editSale: 'Edit Sale', customInput: 'Custom', addTax: '+ Tax', amount: 'Amount',
        closeDayConfirm: 'Close sales for the day?', tax: 'Tax', finalize: 'Finalize',
        detailRecord: 'Sale Details', restoreThis: 'Restore this record',
        resetConfirm: 'Delete all data?', resetWarning1: 'Delete sales records', resetWarning2: 'Delete daily records',
        resetWarning3: 'Reset product list', resetWarning4: 'Reset inventory to default', reset: 'Reset', loading: 'Loading...',
        firebaseMode: 'üî• Firebase Connected', algorithmApplied: '2 for $20 deal applied', stickerDeal: '2 for $5 deal applied', cancelled: 'Cancelled',
        logs: 'Change Log', noLogs: 'No logs yet',
        saleCreated: 'Sale Created', saleCancelled: 'Sale Cancelled', saleEdited: 'Sale Edited', inventoryChanged: 'Inventory Changed',
        clicker: 'Clicker', keyring: 'Keyring', sticker: 'Sticker', blindbag: 'Blind Bag', mixed: 'Mixed',
        stock: 'Stock', addProduct: 'Add Product', editProduct: 'Edit Product'
      }
    };

    // ============ Reducers (ÏÉÅÌÉú Í∑∏Î£πÌôî) ============
    
    // ÌåêÎß§ ÏàòÏ†ï Î™®Îã¨ ÏÉÅÌÉú
    const editInitialState = {
      sale: null,
      items: {},
      paymentMethod: 'cash',
      cardType: 'venmo',
      price: 0,
      memo: '',
      useCustomPrice: false
    };

    function editReducer(state, action) {
      switch (action.type) {
        case 'START_EDIT':
          const sale = action.sale;
          // ÏÉà/Íµ¨ Íµ¨Ï°∞ Ìò∏Ìôò
          let items = {};
          if (sale.itemDetails) {
            sale.itemDetails.forEach(item => { items[item.id] = item.qty; });
          } else if (sale.items) {
            items = { ...sale.items };
          }
          const payment = sale.payment || {};
          return {
            sale: sale,
            items: items,
            paymentMethod: payment.method || sale.paymentMethod || 'cash',
            cardType: payment.type || sale.cardType || 'venmo',
            price: sale.price || 0,
            memo: sale.memo || '',
            useCustomPrice: false
          };
        case 'UPDATE_ITEM':
          const newQty = (state.items[action.id] || 0) + action.delta;
          if (newQty <= 0) {
            const { [action.id]: removed, ...rest } = state.items;
            return { ...state, items: rest };
          }
          return { ...state, items: { ...state.items, [action.id]: newQty } };
        case 'SET_PAYMENT_METHOD':
          return { ...state, paymentMethod: action.value };
        case 'SET_CARD_TYPE':
          return { ...state, cardType: action.value };
        case 'SET_PRICE':
          return { ...state, price: action.value };
        case 'SET_MEMO':
          return { ...state, memo: action.value };
        case 'SET_USE_CUSTOM_PRICE':
          return { ...state, useCustomPrice: action.value };
        case 'CLOSE_EDIT':
          return editInitialState;
        default:
          return state;
      }
    }

    // ÏÉà ÌåêÎß§ ÏûÖÎ†• ÏÉÅÌÉú
    const saleInputInitialState = {
      selectedItems: {},
      paymentMethod: 'cash',
      cardType: 'venmo',
      memo: '',
      useCustomPrice: false,
      customPrice: 0,
      addTaxToCustom: false
    };

    function saleInputReducer(state, action) {
      switch (action.type) {
        case 'ADD_ITEM':
          const catItems = state.selectedItems[action.category] || {};
          return {
            ...state,
            selectedItems: {
              ...state.selectedItems,
              [action.category]: { ...catItems, [action.id]: (catItems[action.id] || 0) + 1 }
            }
          };
        case 'DECREASE_ITEM':
          const cat = action.category;
          const currentCatItems = state.selectedItems[cat] || {};
          const currentQty = currentCatItems[action.id] || 0;
          if (currentQty <= 1) {
            const { [action.id]: removed, ...restItems } = currentCatItems;
            if (Object.keys(restItems).length === 0) {
              const { [cat]: removedCat, ...restCats } = state.selectedItems;
              return { ...state, selectedItems: restCats };
            }
            return { ...state, selectedItems: { ...state.selectedItems, [cat]: restItems } };
          }
          return {
            ...state,
            selectedItems: {
              ...state.selectedItems,
              [cat]: { ...currentCatItems, [action.id]: currentQty - 1 }
            }
          };
        case 'SET_PAYMENT_METHOD':
          return { ...state, paymentMethod: action.value };
        case 'SET_CARD_TYPE':
          return { ...state, cardType: action.value };
        case 'SET_MEMO':
          return { ...state, memo: action.value };
        case 'SET_USE_CUSTOM_PRICE':
          return { ...state, useCustomPrice: action.value };
        case 'SET_CUSTOM_PRICE':
          return { ...state, customPrice: action.value };
        case 'SET_ADD_TAX':
          return { ...state, addTaxToCustom: action.value };
        case 'CLEAR':
          return saleInputInitialState;
        default:
          return state;
      }
    }

    // ============ Firebase ÌõÖ ============
    function useFirebaseData(collectionName, defaultValue) {
      const [data, setData] = useState(defaultValue);
      const [loading, setLoading] = useState(true);
      
      useEffect(() => {
        const unsubscribe = db.collection('store').doc(collectionName).onSnapshot((doc) => {
          if (doc.exists) setData(doc.data().value);
          else setData(defaultValue);
          setLoading(false);
        }, (error) => { console.error('Firebase error:', error); setLoading(false); });
        return () => unsubscribe();
      }, [collectionName]);

      const saveData = async (newData) => {
        try { 
          await db.collection('store').doc(collectionName).set({ 
            value: newData, 
            updatedAt: new Date().toISOString() 
          }); 
          setData(newData); 
        }
        catch (error) { console.error('Save error:', error); }
      };

      return [data, saveData, loading];
    }

    // ============ Î©îÏù∏ Ïï± ============
    function App() {
      const [lang, setLang] = useState('en');
      const t = TRANSLATIONS[lang];
      const [activeTab, setActiveTab] = useState('sales');
      const [selectedCategory, setSelectedCategory] = useState('clicker');
      
      // ÌåêÎß§ ÏûÖÎ†• ÏÉÅÌÉú (Í∑∏Î£πÌôî)
      const [saleInput, saleDispatch] = useReducer(saleInputReducer, saleInputInitialState);
      const { selectedItems, paymentMethod, cardType, memo: saleMemo, useCustomPrice: useCustomSalePrice, customPrice: customSalePrice, addTaxToCustom } = saleInput;
      
      // Î™®Îã¨ ÏÉÅÌÉúÎì§
      const [showTaxModal, setShowTaxModal] = useState(false);
      const [tempTaxRate, setTempTaxRate] = useState(9.5);
      const [showProductModal, setShowProductModal] = useState(false);
      const [editingProduct, setEditingProduct] = useState(null);
      const [newProductName, setNewProductName] = useState('');
      const [newProductPrice, setNewProductPrice] = useState(10);
      const [showSalesHistory, setShowSalesHistory] = useState(false);
      
      // ÌåêÎß§ ÏàòÏ†ï ÏÉÅÌÉú (Í∑∏Î£πÌôî)
      const [editState, editDispatch] = useReducer(editReducer, editInitialState);
      const { sale: editingSale, items: editItems, paymentMethod: editPaymentMethod, cardType: editCardType, price: editPrice, memo: editMemo, useCustomPrice } = editState;
      
      const [showCloseModal, setShowCloseModal] = useState(false);
      const [viewingRecord, setViewingRecord] = useState(null);
      const [showResetModal, setShowResetModal] = useState(false);
      const [showStatsModal, setShowStatsModal] = useState(false);
      const [statsPeriod, setStatsPeriod] = useState('week');
      const [customStartDate, setCustomStartDate] = useState('');
      const [customEndDate, setCustomEndDate] = useState('');
      const [showLogsModal, setShowLogsModal] = useState(false);
      
      // Ïπ¥ÌÖåÍ≥†Î¶¨ Î™®Îã¨ ÏÉÅÌÉú
      const [showCategoryModal, setShowCategoryModal] = useState(false);
      const [editingCategory, setEditingCategory] = useState(null);
      const [newCategoryName, setNewCategoryName] = useState('');
      const [newCategoryNameEn, setNewCategoryNameEn] = useState('');
      const [newCategoryEmoji, setNewCategoryEmoji] = useState('üì¶');
      const [newCategoryPriceType, setNewCategoryPriceType] = useState('fixed');

      // Firebase Îç∞Ïù¥ÌÑ∞ - ÏÉà ÌÜµÌï© Íµ¨Ï°∞
      const [products, saveProducts, productsLoading] = useFirebaseData('products', DEFAULT_PRODUCTS);
      const [sales, saveSales, salesLoading] = useFirebaseData('sales', []);
      const [dailyRecords, saveDailyRecords, recordsLoading] = useFirebaseData('dailyRecords', []);
      const [taxRate, saveTaxRate, taxLoading] = useFirebaseData('taxRate', 9.5);
      const [logs, saveLogs, logsLoading] = useFirebaseData('logs', []);
      const [categories, saveCategories, categoriesLoading] = useFirebaseData('categories', DEFAULT_CATEGORIES);

      const loading = productsLoading || salesLoading || recordsLoading || taxLoading || logsLoading || categoriesLoading;

      // ============ Î©îÎ™®Ïù¥Ï†úÏù¥ÏÖò (ÏÑ±Îä• ÏµúÏ†ÅÌôî) ============
      
      // Ïπ¥ÌÖåÍ≥†Î¶¨ Map - O(1) Ï°∞Ìöå
      const categoriesMap = useMemo(() => {
        const map = new Map();
        categories.forEach(c => map.set(c.id, c));
        return map;
      }, [categories]);

      // ÏÉÅÌíà Map - O(1) Ï°∞Ìöå (Í∏∞Ï°¥: Îß§Î≤à 60Í∞ú Í≤ÄÏÉâ ‚Üí Í∞úÏÑ†: Ï¶âÏãú Ï∞æÍ∏∞)
      const productsMap = useMemo(() => {
        const map = new Map();
        products.forEach(p => map.set(p.id, p));
        return map;
      }, [products]);

      // Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ ÏÉÅÌíà ÌïÑÌÑ∞ÎßÅ
      const productsByCategory = useMemo(() => {
        const result = {};
        categories.forEach(cat => {
          result[cat.id] = products.filter(p => p.category === cat.id);
        });
        return result;
      }, [products, categories]);

      // ÌòÑÏû¨ Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÉÅÌíà
      const currentProducts = productsByCategory[selectedCategory] || [];

      // Î°úÍ∑∏ Ï∂îÍ∞Ä
      const addLog = async (action, details) => {
        const newLog = { id: Date.now(), timestamp: new Date().toISOString(), action, ...details };
        await saveLogs([newLog, ...logs]);
      };

      // ÏÉÅÌíà Ï∞æÍ∏∞ Ìó¨Ìçº (Map ÏÇ¨Ïö©ÏúºÎ°ú Ï¶âÏãú Ï°∞Ìöå)
      const getProduct = (id) => productsMap.get(id);
      const getProductName = (id) => productsMap.get(id)?.name || id;
      const getProductPrice = (id) => productsMap.get(id)?.price;
      const getProductCategory = (id) => productsMap.get(id)?.category;

      // ÏÉÅÌíà Ïû¨Í≥† ÏóÖÎç∞Ïù¥Ìä∏
      const updateStock = async (itemId, delta) => {
        const updated = products.map(p => 
          p.id === itemId ? { ...p, stock: Math.max(0, (p.stock || 0) + delta) } : p
        );
        await saveProducts(updated);
      };

      // Îã§Ï§ë Ïû¨Í≥† ÏóÖÎç∞Ïù¥Ìä∏
      const updateMultipleStock = async (changes) => {
        // changes: { itemId: delta, ... }
        const updated = products.map(p => {
          if (changes[p.id] !== undefined) {
            return { ...p, stock: Math.max(0, (p.stock || 0) + changes[p.id]) };
          }
          return p;
        });
        await saveProducts(updated);
      };

      // ============ Í∞ÄÍ≤© Í≥ÑÏÇ∞ ============
      const calculateCategoryPrice = (items, categoryId) => {
        const category = categories.find(c => c.id === categoryId);
        if (category?.priceType === 'algorithm') {
          const totalQty = Object.values(items).reduce((s, q) => s + q, 0);
          // Ïπ¥ÌÖåÍ≥†Î¶¨Î≥Ñ Îã§Î•∏ ÏïåÍ≥†Î¶¨Ï¶ò Ï†ÅÏö©
          if (categoryId === 'clicker') {
            return calculateClickerPrice(totalQty);
          } else if (categoryId === 'sticker') {
            return calculateStickerPrice(totalQty);
          }
          return 0;
        } else {
          let total = 0;
          Object.entries(items).forEach(([id, qty]) => {
            const product = getProduct(id);
            if (product?.price) total += product.price * qty;
          });
          return total;
        }
      };

      const calculateTotalPrice = () => {
        let total = 0;
        Object.entries(selectedItems).forEach(([catId, items]) => {
          total += calculateCategoryPrice(items, catId);
        });
        return total;
      };

      const calculateTax = (basePrice, method, cType) => 
        (method === 'card' && cType === 'square') ? basePrice * (taxRate / 100) : 0;

      // ============ ÏïÑÏù¥ÌÖú ÏÑ†ÌÉù ============
      const handleItemTap = (itemId) => {
        const product = getProduct(itemId);
        if (!product || product.stock <= 0) return;
        
        const catItems = selectedItems[selectedCategory] || {};
        const cur = catItems[itemId] || 0;
        
        if (cur < product.stock) {
          saleDispatch({ type: 'ADD_ITEM', category: selectedCategory, id: itemId });
        }
      };

      const handleItemDecrease = (itemId, categoryId = selectedCategory) => {
        saleDispatch({ type: 'DECREASE_ITEM', category: categoryId, id: itemId });
      };

      const clearSelection = () => { 
        saleDispatch({ type: 'CLEAR' });
      };

      const getTotalQuantity = () => {
        return Object.values(selectedItems).reduce((total, catItems) => 
          total + Object.values(catItems).reduce((s, q) => s + q, 0), 0);
      };

      // ============ ÌåêÎß§ Ï≤òÎ¶¨ ============
      const handleSale = async () => {
        const totalQty = getTotalQuantity();
        if (totalQty === 0) return;

        const calcPrice = calculateTotalPrice();
        const finalBase = useCustomSalePrice ? customSalePrice : calcPrice;
        const rawTax = useCustomSalePrice 
          ? (addTaxToCustom ? calculateTax(customSalePrice, paymentMethod, cardType) : 0) 
          : calculateTax(calcPrice, paymentMethod, cardType);
        const tax = Math.round(rawTax * 100) / 100; // ÏÜåÏàòÏ†ê 2ÏûêÎ¶¨ Ï†ïÎ¶¨
        const finalPrice = Math.round((finalBase + tax) * 100) / 100;

        const includedCategories = Object.keys(selectedItems);
        const isMixed = includedCategories.length > 1;

        // üÜï ÏùΩÍ∏∞ Ïâ¨Ïö¥ ÏïÑÏù¥ÌÖú ÏÉÅÏÑ∏ Î∞∞Ïó¥
        const itemDetails = [];
        const stockChanges = {};
        
        Object.entries(selectedItems).forEach(([catId, catItems]) => {
          Object.entries(catItems).forEach(([id, qty]) => {
            const product = getProduct(id);
            const category = categories.find(c => c.id === catId);
            
            itemDetails.push({
              id,
              name: product?.name || id,
              category: catId,
              categoryName: category?.name || catId,
              qty,
              ...(product?.price && { unitPrice: product.price, subtotal: product.price * qty })
            });
            
            stockChanges[id] = -qty;
          });
        });

        // Ïπ¥ÌÖåÍ≥†Î¶¨Î™Ö (Î≥µÌï©Ïù∏ Í≤ΩÏö∞)
        const categoryNames = includedCategories
          .map(c => categories.find(cat => cat.id === c)?.name)
          .join(' + ');

        // üÜï Í∞úÏÑ†Îêú ÌåêÎß§ Í∏∞Î°ù Íµ¨Ï°∞
        const newSale = {
          id: Date.now(),
          timestamp: new Date().toISOString(),
          status: 'active',
          
          // Ïπ¥ÌÖåÍ≥†Î¶¨ Ï†ïÎ≥¥
          category: {
            id: isMixed ? 'mixed' : includedCategories[0],
            name: isMixed ? categoryNames : categories.find(c => c.id === includedCategories[0])?.name,
            isMixed
          },
          
          // üÜï ÏùΩÍ∏∞ Ïâ¨Ïö¥ ÏïÑÏù¥ÌÖú Î™©Î°ù
          itemDetails,
          
          // Í∏àÏï° Ï†ïÎ≥¥
          totalQty,
          basePrice: Math.round(finalBase * 100) / 100,
          tax,
          price: finalPrice,
          
          // üÜï Í≤∞Ï†ú Ï†ïÎ≥¥ Í∑∏Î£πÌôî
          payment: {
            method: paymentMethod,
            ...(paymentMethod === 'card' && { type: cardType })
          },
          
          // Î©îÎ™® (Í∞íÏù¥ ÏûàÏùÑ ÎïåÎßå)
          ...(saleMemo.trim() && { memo: saleMemo.trim() })
        };

        await updateMultipleStock(stockChanges);
        await saveSales([newSale, ...sales]);
        await addLog('sale_created', {
          saleId: newSale.id,
          categories: includedCategories,
          itemDetails: itemDetails.map(i => ({ name: i.name, qty: i.qty })),
          price: finalPrice,
          payment: newSale.payment
        });

        saleDispatch({ type: 'CLEAR' });
      };

      // ============ ÌåêÎß§ Ï∑®ÏÜå ============
      const handleCancelSale = async (sale) => {
        const stockChanges = {};
        
        // ÏÉà Íµ¨Ï°∞ (itemDetails Î∞∞Ïó¥) ÎòêÎäî Í∏∞Ï°¥ Íµ¨Ï°∞ (items Í∞ùÏ≤¥) Ìò∏Ìôò
        if (sale.itemDetails) {
          sale.itemDetails.forEach(item => {
            stockChanges[item.id] = item.qty;
          });
        } else if (sale.items) {
          Object.entries(sale.items).forEach(([id, q]) => {
            stockChanges[id] = q;
          });
        }
        
        await updateMultipleStock(stockChanges);
        await saveSales(sales.map(s => 
          s.id === sale.id ? { ...sale, status: 'cancelled', cancelledAt: new Date().toISOString() } : s
        ));
        await addLog('sale_cancelled', {
          saleId: sale.id,
          itemDetails: sale.itemDetails?.map(i => ({ name: i.name, qty: i.qty })) || Object.entries(sale.items || {}).map(([id, qty]) => ({ name: getProductName(id), qty })),
          price: sale.price,
          originalTimestamp: sale.timestamp
        });
      };

      // ============ ÌåêÎß§ ÏàòÏ†ï ============
      // Ìó¨Ìçº: saleÏóêÏÑú items Í∞ùÏ≤¥ Ï∂îÏ∂ú (ÏÉà/Íµ¨ Íµ¨Ï°∞ Ìò∏Ìôò)
      const getSaleItems = (sale) => {
        if (sale.itemDetails) {
          const items = {};
          sale.itemDetails.forEach(item => {
            items[item.id] = item.qty;
          });
          return items;
        }
        return sale.items || {};
      };

      // Ìó¨Ìçº: saleÏóêÏÑú Í≤∞Ï†ú Ï†ïÎ≥¥ Ï∂îÏ∂ú (ÏÉà/Íµ¨ Íµ¨Ï°∞ Ìò∏Ìôò)
      const getSalePayment = (sale) => {
        if (sale.payment) {
          return { method: sale.payment.method, cardType: sale.payment.type };
        }
        return { method: sale.paymentMethod, cardType: sale.cardType };
      };

      const startEditSale = (sale) => {
        editDispatch({ type: 'START_EDIT', sale: sale });
      };

      const handleEditItemChange = (id, delta) => {
        editDispatch({ type: 'UPDATE_ITEM', id: id, delta: delta });
      };

      const handleSaveEdit = async () => {
        const totalQty = Object.values(editItems).reduce((s, q) => s + q, 0);
        if (totalQty === 0) return;

        const oldSale = editingSale;
        const oldItems = getSaleItems(oldSale);
        
        // Í∞ÄÍ≤© Í≥ÑÏÇ∞
        let calcPrice = 0;
        const newItemDetails = [];
        
        Object.entries(editItems).forEach(([id, qty]) => {
          const product = getProduct(id);
          if (product) {
            if (product.category !== 'clicker') {
              calcPrice += (product.price || 0) * qty;
            }
            newItemDetails.push({
              id,
              name: product.name,
              category: product.category,
              categoryName: categories.find(c => c.id === product.category)?.name,
              qty,
              ...(product.price && { unitPrice: product.price, subtotal: product.price * qty })
            });
          }
        });
        
        // ÌÅ¥Î¶¨Ïª§ Í∞ÄÍ≤© Í≥ÑÏÇ∞
        const clickerQty = Object.entries(editItems).reduce((sum, [id, qty]) => {
          const p = getProduct(id);
          return p?.category === 'clicker' ? sum + qty : sum;
        }, 0);
        calcPrice += calculateClickerPrice(clickerQty);

        // Ïä§Ìã∞Ïª§ Í∞ÄÍ≤© Í≥ÑÏÇ∞
        const stickerQty = Object.entries(editItems).reduce((sum, [id, qty]) => {
          const p = getProduct(id);
          return p?.category === 'sticker' ? sum + qty : sum;
        }, 0);
        calcPrice += calculateStickerPrice(stickerQty);

        const basePriceVal = useCustomPrice ? editPrice : calcPrice;
        const rawTax = useCustomPrice ? 0 : calculateTax(calcPrice, editPaymentMethod, editCardType);
        const tax = Math.round(rawTax * 100) / 100;
        const finalPrice = Math.round((basePriceVal + tax) * 100) / 100;

        // Ïû¨Í≥† Ï°∞Ï†ï
        const stockChanges = {};
        Object.entries(oldItems).forEach(([id, q]) => {
          stockChanges[id] = (stockChanges[id] || 0) + q;
        });
        Object.entries(editItems).forEach(([id, q]) => {
          stockChanges[id] = (stockChanges[id] || 0) - q;
        });

        // Ïπ¥ÌÖåÍ≥†Î¶¨ Ï†ïÎ≥¥
        const categories = [...new Set(newItemDetails.map(i => i.category))];
        const isMixed = categories.length > 1;
        const categoryNames = categories.map(c => categories.find(cat => cat.id === c)?.name).join(' + ');

        // üÜï Í∞úÏÑ†Îêú Íµ¨Ï°∞Î°ú Ï†ÄÏû•
        const updatedSale = {
          id: oldSale.id,
          timestamp: oldSale.timestamp,
          status: oldSale.status,
          
          category: {
            id: isMixed ? 'mixed' : categories[0],
            name: isMixed ? categoryNames : categories.find(c => c.id === categories[0])?.name,
            isMixed
          },
          
          itemDetails: newItemDetails,
          
          totalQty,
          basePrice: Math.round(basePriceVal * 100) / 100,
          tax,
          price: finalPrice,
          
          payment: {
            method: editPaymentMethod,
            ...(editPaymentMethod === 'card' && { type: editCardType })
          },
          
          ...(editMemo.trim() && { memo: editMemo.trim() }),
          modifiedAt: new Date().toISOString()
        };

        await updateMultipleStock(stockChanges);
        await saveSales(sales.map(s => s.id === oldSale.id ? updatedSale : s));
        await addLog('sale_edited', {
          saleId: oldSale.id,
          before: { 
            items: oldSale.itemDetails?.map(i => ({ name: i.name, qty: i.qty })) || Object.entries(oldItems).map(([id, qty]) => ({ name: getProductName(id), qty })),
            price: oldSale.price 
          },
          after: { 
            items: newItemDetails.map(i => ({ name: i.name, qty: i.qty })),
            price: finalPrice 
          }
        });

        editDispatch({ type: 'CLOSE_EDIT' });
      };

      // ============ Ïπ¥ÌÖåÍ≥†Î¶¨ Í¥ÄÎ¶¨ ============
      const handleAddCategory = async () => {
        if (!newCategoryName.trim() || !newCategoryNameEn.trim()) return;
        
        const newId = 'cat_' + Date.now();
        const newCategory = {
          id: newId,
          name: newCategoryName.trim(),
          nameEn: newCategoryNameEn.trim(),
          emoji: newCategoryEmoji || 'üì¶',
          priceType: 'fixed'  // ÏÉà Ïπ¥ÌÖåÍ≥†Î¶¨Îäî Î¨¥Ï°∞Í±¥ Í≥†Ï†ï Í∞ÄÍ≤©
        };
        
        await saveCategories([...categories, newCategory]);
        resetCategoryForm();
        setShowCategoryModal(false);
      };

      const handleEditCategory = async () => {
        if (!editingCategory || !newCategoryName.trim() || !newCategoryNameEn.trim()) return;
        
        const updated = categories.map(c => {
          if (c.id === editingCategory.id) {
            return {
              ...c,
              name: newCategoryName.trim(),
              nameEn: newCategoryNameEn.trim(),
              emoji: newCategoryEmoji || 'üì¶'
              // priceTypeÏùÄ Í∏∞Ï°¥ Í∞í Ïú†ÏßÄ (clicker/sticker ÏïåÍ≥†Î¶¨Ï¶ò Î≥¥Ìò∏)
            };
          }
          return c;
        });
        
        await saveCategories(updated);
        resetCategoryForm();
        setShowCategoryModal(false);
      };

      const handleDeleteCategory = async (categoryId) => {
        // Ìï¥Îãπ Ïπ¥ÌÖåÍ≥†Î¶¨Ïùò ÏÉÅÌíàÏù¥ ÏûàÎäîÏßÄ ÌôïÏù∏
        const hasProducts = products.some(p => p.category === categoryId);
        if (hasProducts) {
          alert(lang === 'ko' ? 'Ïù¥ Ïπ¥ÌÖåÍ≥†Î¶¨Ïóê ÏÉÅÌíàÏù¥ ÏûàÏñ¥ÏÑú ÏÇ≠Ï†úÌï† Ïàò ÏóÜÏäµÎãàÎã§.' : 'Cannot delete category with products.');
          return;
        }
        
        await saveCategories(categories.filter(c => c.id !== categoryId));
        if (selectedCategory === categoryId && categories.length > 1) {
          setSelectedCategory(categories[0].id);
        }
        setShowCategoryModal(false);
      };

      const resetCategoryForm = () => {
        setNewCategoryName('');
        setNewCategoryNameEn('');
        setNewCategoryEmoji('üì¶');
        setNewCategoryPriceType('fixed');
        setEditingCategory(null);
      };

      const startEditCategory = (category) => {
        setEditingCategory(category);
        setNewCategoryName(category.name);
        setNewCategoryNameEn(category.nameEn || category.name);
        setNewCategoryEmoji(category.emoji);
        setNewCategoryPriceType(category.priceType);
        setShowCategoryModal(true);
      };

      // ============ ÏÉÅÌíà Í¥ÄÎ¶¨ ============
      const handleAddProduct = async () => {
        if (!newProductName.trim()) return;
        
        const category = categories.find(c => c.id === selectedCategory);
        const newProduct = {
          id: generateId(),
          name: newProductName.trim(),
          category: selectedCategory,
          stock: 10
        };
        
        if (category?.priceType === 'fixed') {
          newProduct.price = newProductPrice;
        }

        await saveProducts([...products, newProduct]);
        setNewProductName('');
        setNewProductPrice(10);
      };

      const handleEditProduct = async (product, newName, newPrice) => {
        if (!newName.trim()) return;
        
        const updated = products.map(p => {
          if (p.id === product.id) {
            const result = { ...p, name: newName.trim() };
            if (newPrice !== undefined && p.price !== undefined) {
              result.price = newPrice;
            }
            return result;
          }
          return p;
        });
        
        await saveProducts(updated);
        setEditingProduct(null);
      };

      const handleDeleteProduct = async (product) => {
        await saveProducts(products.filter(p => p.id !== product.id));
      };

      const handleUpdateStock = async (productId, newStock) => {
        const updated = products.map(p => 
          p.id === productId ? { ...p, stock: parseInt(newStock) || 0 } : p
        );
        await saveProducts(updated);
      };

      // ============ ÎßàÍ∞ê Ï≤òÎ¶¨ ============
      const handleDayClose = async () => {
        if (sales.length === 0) { setShowCloseModal(false); return; }
        
        const activeSales = sales.filter(s => s.status !== 'cancelled');
        const getPaymentMethod = (x) => x.payment?.method || x.paymentMethod;
        const summary = {
          totalRevenue: activeSales.reduce((s, x) => s + x.price, 0),
          totalTax: activeSales.reduce((s, x) => s + (x.tax || 0), 0),
          cashRevenue: activeSales.filter(x => getPaymentMethod(x) === 'cash').reduce((s, x) => s + x.price, 0),
          cardRevenue: activeSales.filter(x => getPaymentMethod(x) === 'card').reduce((s, x) => s + x.price, 0),
          totalItems: activeSales.reduce((s, x) => s + (x.totalQty || x.totalQuantity || 0), 0),
          transactionCount: activeSales.length
        };

        const newRecord = {
          id: Date.now(),
          date: new Date().toISOString(),
          dateString: new Date(sales[0].timestamp).toDateString(),
          sales: [...sales],
          summary,
          productsSnapshot: products.map(p => ({ id: p.id, name: p.name, stock: p.stock }))
        };

        await saveDailyRecords([newRecord, ...dailyRecords]);
        await saveSales([]);
        setShowCloseModal(false);
      };

      const handleRestoreSales = async (record) => {
        if (sales.length > 0) {
          const activeSales = sales.filter(s => s.status !== 'cancelled');
          const getPaymentMethod = (x) => x.payment?.method || x.paymentMethod;
          const cr = {
            id: Date.now(),
            date: new Date(sales[0].timestamp).toISOString(),
            dateString: new Date(sales[0].timestamp).toDateString(),
            sales: [...sales],
            summary: {
              totalRevenue: activeSales.reduce((s, x) => s + x.price, 0),
              totalTax: activeSales.reduce((s, x) => s + (x.tax || 0), 0),
              cashRevenue: activeSales.filter(x => getPaymentMethod(x) === 'cash').reduce((s, x) => s + x.price, 0),
              cardRevenue: activeSales.filter(x => getPaymentMethod(x) === 'card').reduce((s, x) => s + x.price, 0),
              totalItems: activeSales.reduce((s, x) => s + (x.totalQty || x.totalQuantity || 0), 0),
              transactionCount: activeSales.length
            }
          };
          let ur = [...dailyRecords];
          const idx = ur.findIndex(r => r.dateString === cr.dateString);
          if (idx >= 0) ur[idx] = cr;
          else ur = [cr, ...ur];
          ur = ur.filter(r => r.id !== record.id);
          await saveDailyRecords(ur);
        } else {
          await saveDailyRecords(dailyRecords.filter(r => r.id !== record.id));
        }
        
        await saveSales([...record.sales]);
        setViewingRecord(null);
        setActiveTab('sales');
        setShowSalesHistory(true);
      };

      // ============ Í∏∞Î°ù Ïû¨Í≥ÑÏÇ∞ ============
      const recalculateAllRecords = async () => {
        if (dailyRecords.length === 0) return;
        
        const updatedRecords = dailyRecords.map(record => {
          const salesList = record.sales || [];
          const activeSales = salesList.filter(s => s.status !== 'cancelled');
          
          // Í≤∞Ï†ú Î∞©Î≤ï Í∞ÄÏ†∏Ïò§Í∏∞ (ÏÉà/Íµ¨ Íµ¨Ï°∞ Ìò∏Ìôò)
          const getPaymentMethod = (x) => x.payment?.method || x.paymentMethod;
          
          // Îã§Ïãú Í≥ÑÏÇ∞
          const newSummary = {
            totalRevenue: activeSales.reduce((s, x) => s + (x.price || 0), 0),
            totalTax: activeSales.reduce((s, x) => s + (x.tax || 0), 0),
            cashRevenue: activeSales.filter(x => getPaymentMethod(x) === 'cash').reduce((s, x) => s + (x.price || 0), 0),
            cardRevenue: activeSales.filter(x => getPaymentMethod(x) === 'card').reduce((s, x) => s + (x.price || 0), 0),
            totalItems: activeSales.reduce((s, x) => s + (x.totalQty || x.totalQuantity || 0), 0),
            transactionCount: activeSales.length
          };
          
          return { ...record, summary: newSummary };
        });
        
        await saveDailyRecords(updatedRecords);
        alert(lang === 'ko' ? 'Í∏∞Î°ùÏù¥ Ïû¨Í≥ÑÏÇ∞ÎêòÏóàÏäµÎãàÎã§!' : 'Records recalculated!');
      };

      // ============ Î¶¨ÏÖã ============
      const handleResetAllData = async () => {
        await saveProducts(DEFAULT_PRODUCTS);
        await saveSales([]);
        await saveDailyRecords([]);
        await saveTaxRate(9.5);
        await saveLogs([]);
        setShowResetModal(false);
        setActiveTab('sales');
      };

      // ============ ÏÑ∏Í∏à ============
      const handleApplyTaxRate = async () => {
        const updatedSales = sales.map(sale => {
          if (sale.paymentMethod === 'card' && sale.cardType === 'square') {
            const basePrice = sale.basePrice || sale.price;
            const newTax = basePrice * (taxRate / 100);
            return { ...sale, basePrice, tax: newTax, price: basePrice + newTax };
          }
          return sale;
        });
        await saveSales(updatedSales);
      };

      // ============ ÌÜµÍ≥Ñ ============
      const getCurrentStats = () => {
        const activeSales = sales.filter(s => s.status !== 'cancelled');
        const totalRevenue = activeSales.reduce((s, x) => s + x.price, 0);
        const totalTax = activeSales.reduce((s, x) => s + (x.tax || 0), 0);
        
        // ÏÉà/Íµ¨ Íµ¨Ï°∞ Ìò∏Ìôò
        const cashRevenue = activeSales.filter(x => {
          const payment = x.payment?.method || x.paymentMethod;
          return payment === 'cash';
        }).reduce((s, x) => s + x.price, 0);
        
        const cardRevenue = activeSales.filter(x => {
          const payment = x.payment?.method || x.paymentMethod;
          return payment === 'card';
        }).reduce((s, x) => s + x.price, 0);
        
        const totalItems = activeSales.reduce((s, x) => s + (x.totalQty || x.totalQuantity || 0), 0);
        
        let dateLabel = lang === 'ko' ? 'Ïò§Îäò' : 'Today';
        if (activeSales.length > 0) {
          const dates = [...new Set(activeSales.map(s => new Date(s.timestamp).toDateString()))];
          const today = new Date().toDateString();
          if (dates.length === 1 && dates[0] === today) dateLabel = lang === 'ko' ? 'Ïò§Îäò' : 'Today';
          else if (dates.length === 1) dateLabel = new Date(activeSales[0].timestamp).toLocaleDateString(lang === 'ko' ? 'ko-KR' : 'en-US', { month: 'short', day: 'numeric' });
          else dateLabel = t.currentList;
        }
        
        return { totalRevenue, totalTax, cashRevenue, cardRevenue, totalItems, count: activeSales.length, dateLabel };
      };

      const getStatsData = () => {
        let startDate, endDate = new Date();
        endDate.setHours(23, 59, 59, 999);
        
        if (statsPeriod === 'week') {
          startDate = new Date();
          startDate.setDate(startDate.getDate() - 7);
        } else if (statsPeriod === 'month') {
          startDate = new Date();
          startDate.setMonth(startDate.getMonth() - 1);
        } else {
          startDate = customStartDate ? new Date(customStartDate) : new Date();
          endDate = customEndDate ? new Date(customEndDate) : new Date();
          endDate.setHours(23, 59, 59, 999);
        }
        startDate.setHours(0, 0, 0, 0);

        let allSales = [...sales.filter(s => s.status !== 'cancelled')];
        dailyRecords.forEach(r => {
          allSales = allSales.concat((r.sales || []).filter(s => s.status !== 'cancelled'));
        });

        const filteredSales = allSales.filter(s => {
          const d = new Date(s.timestamp);
          return d >= startDate && d <= endDate;
        });

        const itemStats = {};
        filteredSales.forEach(sale => {
          // ÏÉà Íµ¨Ï°∞ (itemDetails) ÎòêÎäî Í∏∞Ï°¥ Íµ¨Ï°∞ (items) Ìò∏Ìôò
          if (sale.itemDetails) {
            sale.itemDetails.forEach(item => {
              if (!itemStats[item.id]) itemStats[item.id] = { qty: 0, name: item.name };
              itemStats[item.id].qty += item.qty;
            });
          } else if (sale.items) {
            Object.entries(sale.items).forEach(([itemId, qty]) => {
              if (!itemStats[itemId]) itemStats[itemId] = { qty: 0 };
              itemStats[itemId].qty += qty;
            });
          }
        });

        const totalRevenue = filteredSales.reduce((s, x) => s + x.price, 0);
        const totalQty = filteredSales.reduce((s, x) => s + (x.totalQty || x.totalQuantity || 0), 0);
        const sorted = Object.entries(itemStats)
          .map(([id, data]) => ({ id, name: data.name || getProductName(id), qty: data.qty }))
          .sort((a, b) => b.qty - a.qty);

        return { items: sorted, totalRevenue, totalQty, salesCount: filteredSales.length, startDate, endDate };
      };

      // ============ CSV ÎÇ¥Î≥¥ÎÇ¥Í∏∞ ============
      const exportCSV = () => {
        let allSales = [...sales];
        dailyRecords.forEach(r => { allSales = allSales.concat(r.sales || []); });
        allSales.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

        const headers = ['Date', 'Time', 'Category', 'Items', 'Qty', 'Base', 'Tax', 'Total', 'Payment', 'Type', 'Status', 'Memo'];
        const rows = allSales.map(sale => {
          const d = new Date(sale.timestamp);
          
          // ÏÉà/Íµ¨ Íµ¨Ï°∞ Ìò∏Ìôò
          let itemList;
          if (sale.itemDetails) {
            itemList = sale.itemDetails.map(item => item.name + 'x' + item.qty).join(', ');
          } else if (sale.items) {
            itemList = Object.entries(sale.items).map(([id, qty]) => getProductName(id) + 'x' + qty).join(', ');
          } else {
            itemList = '';
          }
          
          const catName = sale.category?.name || sale.categoryName || '';
          const totalQty = sale.totalQty || sale.totalQuantity || 0;
          const paymentMethod = sale.payment?.method || sale.paymentMethod;
          const cardType = sale.payment?.type || sale.cardType;
          
          return [
            d.toLocaleDateString('en-US'),
            d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
            catName,
            itemList,
            totalQty,
            sale.basePrice || sale.price,
            sale.tax || 0,
            sale.price,
            paymentMethod === 'cash' ? 'Cash' : 'Card',
            cardType ? CARD_OPTIONS.find(o => o.id === cardType)?.name : '',
            sale.status === 'cancelled' ? 'CANCELLED' : 'Active',
            sale.memo || ''
          ];
        });

        const csvContent = [headers, ...rows].map(row => row.map(cell => '"' + cell + '"').join(',')).join('\n');
        const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'sales_' + new Date().toISOString().split('T')[0] + '.csv';
        link.click();
        URL.revokeObjectURL(url);
      };

      // ============ Ìó¨Ìçº ============
      // ÏÉà/Íµ¨ Íµ¨Ï°∞ Ìò∏Ìôò Ìó¨Ìçº
      const getPaymentLabel = (sale) => {
        const method = sale.payment?.method || sale.paymentMethod;
        const type = sale.payment?.type || sale.cardType;
        if (method === 'cash') return 'üíµ';
        const opt = CARD_OPTIONS.find(o => o.id === type);
        return opt ? opt.emoji : 'üí≥';
      };

      const getPaymentTypeName = (sale) => {
        const type = sale.payment?.type || sale.cardType;
        if (!type) return '';
        return CARD_OPTIONS.find(o => o.id === type)?.name || '';
      };

      const getSaleCategoryInfo = (sale) => {
        if (sale.category) {
          return { id: sale.category.id, name: sale.category.name };
        }
        return { id: sale.categoryId, name: sale.categoryName };
      };

      const getSaleTotalQty = (sale) => sale.totalQty || sale.totalQuantity || 0;

      const getSaleItemsList = (sale) => {
        if (sale.itemDetails) {
          return sale.itemDetails.map(item => ({ id: item.id, name: item.name, qty: item.qty }));
        }
        if (sale.items) {
          return Object.entries(sale.items).map(([id, qty]) => ({ id, name: getProductName(id), qty }));
        }
        return [];
      };

      const getCategoryEmoji = (catId) => {
        if (catId === 'mixed') return 'üõí';
        return categories.find(c => c.id === catId)?.emoji || 'üì¶';
      };

      // ============ Í≥ÑÏÇ∞Îêú Í∞íÎì§ (Î©îÎ™®Ïù¥Ï†úÏù¥ÏÖò) ============
      
      // ÌòÑÏû¨ ÌÜµÍ≥Ñ - salesÎÇò langÏù¥ Î∞îÎÄî ÎïåÎßå Îã§Ïãú Í≥ÑÏÇ∞
      const currentStats = useMemo(() => getCurrentStats(), [sales, lang]);
      
      // Ï¥ù ÏàòÎüâ - selectedItemsÍ∞Ä Î∞îÎÄî ÎïåÎßå Îã§Ïãú Í≥ÑÏÇ∞
      const totalQuantity = useMemo(() => getTotalQuantity(), [selectedItems]);
      
      // Í∏∞Î≥∏ Í∞ÄÍ≤© - selectedItemsÍ∞Ä Î∞îÎÄî ÎïåÎßå Îã§Ïãú Í≥ÑÏÇ∞
      const basePrice = useMemo(() => calculateTotalPrice(), [selectedItems, productsMap]);
      
      // ÏÑ∏Í∏à - Í¥ÄÎ†® Í∞íÏù¥ Î∞îÎÄî ÎïåÎßå Îã§Ïãú Í≥ÑÏÇ∞
      const currentTax = useMemo(() => 
        calculateTax(basePrice, paymentMethod, cardType), 
        [basePrice, paymentMethod, cardType, taxRate]
      );
      
      // ÏµúÏ¢Ö Í∞ÄÍ≤©
      const totalPrice = useMemo(() => basePrice + currentTax, [basePrice, currentTax]);

      useEffect(() => { setTempTaxRate(taxRate); }, [taxRate]);

      if (loading) return (
        <div className="min-h-screen bg-gray-100 flex items-center justify-center">
          <div className="text-xl text-gray-600">{t.loading}</div>
        </div>
      );

      // ============ UI Î†åÎçîÎßÅ ============
      return (
        <div className="min-h-screen bg-gray-100">
          {/* ÏÉÅÌÉú Î∞î */}
          <div className="text-center text-xs py-1 bg-green-100 text-green-800">{t.firebaseMode}</div>
          
          {/* ÌÉ≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò */}
          <div className="bg-white border-b sticky top-0 z-40">
            <div className="max-w-lg mx-auto flex">
              <button onClick={() => setActiveTab('sales')} className={`flex-1 py-4 text-center font-medium ${activeTab === 'sales' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'}`}>üí∞ {t.sales}</button>
              <button onClick={() => setActiveTab('history')} className={`flex-1 py-4 text-center font-medium ${activeTab === 'history' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'}`}>üìä {t.history}</button>
              <button onClick={() => setLang(lang === 'ko' ? 'en' : 'ko')} className="px-4 py-4 text-gray-500 hover:text-blue-600 font-medium text-sm">{lang === 'ko' ? 'EN' : 'Ìïú'}</button>
            </div>
          </div>

          <div className="p-4"><div className="max-w-lg mx-auto">
            
            {/* ========== ÌåêÎß§ ÌÉ≠ ========== */}
            {activeTab === 'sales' && (<>
              {/* Ìó§Îçî */}
              <div className="bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl p-6 text-white mb-4 shadow-lg">
                <h1 className="text-2xl font-bold mb-1">üéØ {t.title}</h1>
                <p className="text-blue-100 text-sm">{t.subtitle}</p>
              </div>

              {/* Ïò§Îäò ÌÜµÍ≥Ñ */}
              <div className="bg-white rounded-xl p-4 mb-4 shadow-sm">
                <div className="flex justify-between items-center mb-3">
                  <h2 className="text-sm font-semibold text-gray-500">üìä {currentStats.dateLabel}</h2>
                  <button onClick={() => { setTempTaxRate(taxRate); setShowTaxModal(true); }} className="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded-full">‚öôÔ∏è {t.taxRate} {taxRate}%</button>
                </div>
                <div className="grid grid-cols-3 gap-3">
                  <div className="text-center"><div className="text-2xl font-bold text-green-600">{formatCurrency(currentStats.totalRevenue)}</div><div className="text-xs text-gray-500">{t.totalSales}</div></div>
                  <div className="text-center"><div className="text-lg font-semibold text-blue-600">{formatCurrency(currentStats.cashRevenue)}</div><div className="text-xs text-gray-500">üíµ {t.cash}</div></div>
                  <div className="text-center"><div className="text-lg font-semibold text-purple-600">{formatCurrency(currentStats.cardRevenue)}</div><div className="text-xs text-gray-500">üí≥ {t.card}</div></div>
                </div>
                {currentStats.totalTax > 0 && <div className="mt-2 text-center text-xs text-gray-500">{t.taxIncluded}: {formatCurrency(currentStats.totalTax)}</div>}
                <div className="mt-3 pt-3 border-t flex justify-between items-center">
                  <span className="text-sm text-gray-500">{currentStats.count}{t.transactions} / {currentStats.totalItems}{t.items}</span>
                  <button onClick={() => setShowCloseModal(true)} className="text-sm bg-orange-100 hover:bg-orange-200 text-orange-700 px-3 py-1 rounded-full">üåô {t.closeDay}</button>
                </div>
              </div>

              {/* ÏÉÅÌíà ÏÑ†ÌÉù ÏòÅÏó≠ */}
              <div className="bg-white rounded-xl p-4 mb-4 shadow-sm">
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-sm font-semibold text-gray-500">üí∞ {t.salesRecord}</h2>
                  <button onClick={() => setShowProductModal(true)} className="text-xs bg-purple-100 hover:bg-purple-200 text-purple-700 px-3 py-1 rounded-full">‚úèÔ∏è {t.productMgmt}</button>
                </div>

                {/* Ïπ¥ÌÖåÍ≥†Î¶¨ ÌÉ≠ */}
                <div className="mb-4 flex gap-1 overflow-x-auto pb-1">
                  {categories.map(cat => {
                    const catItems = selectedItems[cat.id] || {};
                    const catQty = Object.values(catItems).reduce((s, q) => s + q, 0);
                    const displayName = lang === 'ko' ? cat.name : (cat.nameEn || cat.name);
                    return (
                      <button 
                        key={cat.id} 
                        onClick={() => setSelectedCategory(cat.id)} 
                        onDoubleClick={() => startEditCategory(cat)}
                        className={`flex-shrink-0 p-2 rounded-lg border-2 text-xs relative ${selectedCategory === cat.id ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}`}
                      >
                        {cat.emoji} {displayName}
                        {catQty > 0 && <span className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white rounded-full text-[10px] flex items-center justify-center">{catQty}</span>}
                      </button>
                    );
                  })}
                  <button 
                    onClick={() => { resetCategoryForm(); setShowCategoryModal(true); }}
                    className="flex-shrink-0 p-2 rounded-lg border-2 border-dashed border-gray-300 text-xs text-gray-500 hover:border-blue-400 hover:text-blue-500"
                  >
                    ‚ûï
                  </button>
                </div>

                {/* Í∞ÄÍ≤© ÏïåÍ≥†Î¶¨Ï¶ò ÏïàÎÇ¥ */}
                {selectedCategory === 'clicker' && <div className="mb-3 p-2 bg-blue-50 rounded-lg text-xs text-blue-700 text-center">üí° {t.algorithmApplied} (1=$12, 2=$20, 3=$32...)</div>}
                {selectedCategory === 'sticker' && <div className="mb-3 p-2 bg-pink-50 rounded-lg text-xs text-pink-700 text-center">üí° {t.stickerDeal} (1=$3, 2=$5, 3=$8...)</div>}

                {/* ÏÉÅÌíà Í∑∏Î¶¨Îìú */}
                <div className="mb-4">
                  <label className="text-xs text-gray-500 mb-2 block">{t.tapToAdd}</label>
                  <div className="grid grid-cols-4 gap-2">
                    {currentProducts.map(product => {
                      const catItems = selectedItems[selectedCategory] || {};
                      const qty = catItems[product.id] || 0;
                      const stock = product.stock || 0;
                      return (
                        <button key={product.id} onClick={() => handleItemTap(product.id)} disabled={stock <= 0} className={`relative p-2 rounded-lg border-2 text-xs font-medium ${stock <= 0 ? 'border-gray-200 bg-gray-100 text-gray-400' : qty > 0 ? 'border-blue-500 bg-blue-100 text-blue-700' : 'border-gray-200 hover:border-blue-300'}`}>
                          <div className="truncate">{product.name}</div>
                          <div className="text-[10px] text-gray-400">{stock}{lang === 'ko' ? 'Í∞ú' : ''}{product.price !== undefined && ` ¬∑ $${product.price}`}</div>
                          {qty > 0 && <div className="absolute -top-2 -right-2 w-5 h-5 bg-blue-600 text-white rounded-full text-xs flex items-center justify-center font-bold">{qty}</div>}
                        </button>
                      );
                    })}
                  </div>
                </div>

                {/* ÏÑ†ÌÉùÎêú ÏÉÅÌíà Î™©Î°ù */}
                {Object.keys(selectedItems).length > 0 && (
                  <div className="mb-4 p-3 bg-gray-50 rounded-lg">
                    <div className="flex justify-between items-center mb-2">
                      <span className="text-xs text-gray-500">{t.selected}:</span>
                      <button onClick={clearSelection} className="text-xs text-red-500">{t.clearAll}</button>
                    </div>
                    <div className="space-y-2">
                      {Object.entries(selectedItems).map(([catId, catItems]) => {
                        const cat = categories.find(c => c.id === catId);
                        return (
                          <div key={catId}>
                            <div className="text-xs text-gray-400 mb-1">{cat?.emoji} {t[catId]}</div>
                            <div className="flex flex-wrap gap-2">
                              {Object.entries(catItems).map(([id, qty]) => {
                                const product = getProduct(id);
                                return (
                                  <div key={id} className="flex items-center gap-1 bg-white px-2 py-1 rounded-full border text-sm">
                                    <span className="font-medium">{product?.name || id}</span>
                                    <span className="text-blue-600">√ó{qty}</span>
                                    {product?.price && <span className="text-gray-400 text-xs">(${product.price * qty})</span>}
                                    <button onClick={() => handleItemDecrease(id, catId)} className="ml-1 w-5 h-5 bg-gray-200 hover:bg-red-200 rounded-full text-xs font-bold">‚àí</button>
                                  </div>
                                );
                              })}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                    <div className="mt-2 pt-2 border-t text-center text-sm text-gray-600">{t.total} {totalQuantity}{t.items}</div>
                  </div>
                )}

                {/* Î©îÎ™® */}
                <div className="mb-4">
                  <input type="text" value={saleMemo} onChange={e => saleDispatch({ type: 'SET_MEMO', value: e.target.value })} placeholder={`üìù ${t.memo}`} className="w-full p-2 border rounded-lg text-sm"/>
                </div>

                {/* Í≤∞Ï†ú Î∞©Ïãù */}
                <div className="mb-4">
                  <label className="text-xs text-gray-500 mb-2 block">{t.paymentMethod}</label>
                  <div className="grid grid-cols-2 gap-2">
                    <button onClick={() => saleDispatch({ type: 'SET_PAYMENT_METHOD', value: 'cash' })} className={`p-3 rounded-lg border-2 flex items-center justify-center gap-2 ${paymentMethod === 'cash' ? 'border-green-500 bg-green-50' : 'border-gray-200'}`}>üíµ {t.cash}</button>
                    <button onClick={() => saleDispatch({ type: 'SET_PAYMENT_METHOD', value: 'card' })} className={`p-3 rounded-lg border-2 flex items-center justify-center gap-2 ${paymentMethod === 'card' ? 'border-purple-500 bg-purple-50' : 'border-gray-200'}`}>üí≥ {t.card}</button>
                  </div>
                  {paymentMethod === 'card' && (
                    <div className="mt-2 grid grid-cols-3 gap-2">
                      {CARD_OPTIONS.map(opt => (
                        <button key={opt.id} onClick={() => saleDispatch({ type: 'SET_CARD_TYPE', value: opt.id })} className={`p-2 rounded-lg border-2 text-sm flex flex-col items-center ${cardType === opt.id ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}`}>
                          <span>{opt.emoji}</span>
                          <span className="text-xs">{opt.name}</span>
                          {opt.hasTax && <span className="text-[10px] text-orange-500">+{t.tax}</span>}
                        </button>
                      ))}
                    </div>
                  )}
                </div>

                {/* Í∞ÄÍ≤© ÌëúÏãú */}
                {totalQuantity > 0 && (
                  <div className="mb-4 p-3 bg-gray-50 rounded-lg">
                    <div className="flex justify-between items-center">
                      <span className="text-sm font-medium">{t.total}:</span>
                      <label className="flex items-center gap-2 text-sm">
                        <input type="checkbox" checked={useCustomSalePrice} onChange={e => { 
                          saleDispatch({ type: 'SET_USE_CUSTOM_PRICE', value: e.target.checked }); 
                          if (!e.target.checked) { 
                            saleDispatch({ type: 'SET_CUSTOM_PRICE', value: basePrice }); 
                            saleDispatch({ type: 'SET_ADD_TAX', value: false }); 
                          } 
                        }} className="w-4 h-4"/>
                        {t.customInput}
                      </label>
                    </div>
                    {useCustomSalePrice ? (
                      <div className="mt-2">
                        <div className="flex items-center justify-center gap-2">
                          <span className="text-2xl">$</span>
                          <input type="number" min="0" step="0.01" value={customSalePrice} onChange={e => saleDispatch({ type: 'SET_CUSTOM_PRICE', value: parseFloat(e.target.value) || 0 })} className="w-28 p-2 text-2xl font-bold text-center border rounded-lg"/>
                        </div>
                        <div className="flex justify-center mt-2">
                          <button onClick={() => saleDispatch({ type: 'SET_ADD_TAX', value: !addTaxToCustom })} className={`px-3 py-1 rounded-full text-sm font-medium ${addTaxToCustom ? 'bg-orange-500 text-white' : 'bg-orange-100 text-orange-700'}`}>
                            {addTaxToCustom ? `‚úì ${t.tax} ${taxRate}%` : t.addTax}
                          </button>
                        </div>
                        {addTaxToCustom && paymentMethod === 'card' && cardType === 'square' && (
                          <div className="text-center mt-2">
                            <span className="text-lg font-bold text-green-600">{formatCurrency(customSalePrice + customSalePrice * (taxRate / 100))}</span>
                            <div className="text-xs text-orange-500">{t.tax} {formatCurrency(customSalePrice * (taxRate / 100))} {lang === 'ko' ? 'Ìè¨Ìï®' : 'incl.'}</div>
                          </div>
                        )}
                        {addTaxToCustom && !(paymentMethod === 'card' && cardType === 'square') && (
                          <div className="text-center mt-2 text-xs text-gray-500">
                            {lang === 'ko' ? 'Square Ïπ¥Îìú Í≤∞Ï†ú ÏãúÏóêÎßå ÏÑ∏Í∏àÏù¥ Ï†ÅÏö©Îê©ÎãàÎã§' : 'Tax only applies to Square card payments'}
                          </div>
                        )}
                      </div>
                    ) : (
                      <div className="text-center mt-2">
                        <span className="text-2xl font-bold text-green-600">{formatCurrency(totalPrice)}</span>
                        {currentTax > 0 && <div className="text-xs text-orange-500">{t.tax} {formatCurrency(currentTax)} {lang === 'ko' ? 'Ìè¨Ìï®' : 'incl.'}</div>}
                      </div>
                    )}
                  </div>
                )}

                {/* ÌåêÎß§ Î≤ÑÌäº */}
                <button onClick={handleSale} disabled={totalQuantity === 0} className={`w-full py-4 rounded-xl text-white font-bold text-lg ${totalQuantity === 0 ? 'bg-gray-300' : 'bg-gradient-to-r from-green-500 to-emerald-600 shadow-lg'}`}>
                  {totalQuantity === 0 ? t.selectProduct : formatCurrency(
                    useCustomSalePrice 
                      ? (addTaxToCustom && paymentMethod === 'card' && cardType === 'square' 
                          ? customSalePrice + customSalePrice * (taxRate / 100) 
                          : customSalePrice)
                      : totalPrice
                  ) + ' ' + t.saleComplete + ' ‚úì'}
                </button>
              </div>

              {/* ÌåêÎß§ Í∏∞Î°ù ÌÜ†Í∏Ä */}
              <div className="flex gap-2 mb-4">
                <button onClick={() => setShowSalesHistory(!showSalesHistory)} className="flex-1 bg-white rounded-xl p-4 shadow-sm text-left flex justify-between items-center">
                  <span className="text-sm font-semibold text-gray-500">üìã {t.salesHistory} ({sales.length}{t.transactions})</span>
                  <span className="text-gray-400">{showSalesHistory ? '‚ñ≤' : '‚ñº'}</span>
                </button>
                <button onClick={handleApplyTaxRate} className="bg-orange-100 hover:bg-orange-200 text-orange-700 rounded-xl px-4 shadow-sm text-sm font-medium">üìê {t.applyTax}</button>
              </div>

              {/* ÌåêÎß§ Í∏∞Î°ù Î™©Î°ù */}
              {showSalesHistory && (
                <div className="bg-white rounded-xl p-4 shadow-sm mb-4">
                  {sales.length === 0 ? (
                    <p className="text-gray-500 text-center py-4">{t.noSalesRecord}</p>
                  ) : (
                    <div className="space-y-2 max-h-96 overflow-y-auto">
                      {sales.slice(0, 50).map(sale => {
                        const catInfo = getSaleCategoryInfo(sale);
                        const totalQty = getSaleTotalQty(sale);
                        const itemsList = getSaleItemsList(sale);
                        return (
                          <div key={sale.id} className={`p-3 rounded-lg ${sale.status === 'cancelled' ? 'bg-red-50 opacity-60' : 'bg-gray-50'}`}>
                            <div className="flex justify-between mb-2">
                              <div>
                                <div className="font-medium text-sm">
                                  {getCategoryEmoji(catInfo.id)} {t[catInfo.id] || catInfo.name} √ó{totalQty}
                                  {sale.status === 'cancelled' && <span className="ml-2 text-xs bg-red-200 text-red-700 px-1 rounded">{t.cancelled}</span>}
                                </div>
                                <div className={`text-xs ${sale.status === 'cancelled' ? 'line-through text-gray-400' : 'text-gray-500'}`}>
                                  {itemsList.map(item => <span key={item.id} className="mr-2">{item.name} √ó{item.qty}</span>)}
                                </div>
                                <div className="text-xs text-gray-400">{new Date(sale.timestamp).toLocaleString(lang === 'ko' ? 'ko-KR' : 'en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</div>
                                {sale.memo && <div className="text-xs text-blue-600 mt-1">üìù {sale.memo}</div>}
                              </div>
                              <div className="text-right">
                                <div className={`font-bold ${sale.status === 'cancelled' ? 'line-through text-gray-400' : 'text-green-600'}`}>{formatCurrency(sale.price)}</div>
                                {sale.tax > 0 && <div className="text-[10px] text-orange-500">{t.tax} {formatCurrency(sale.tax)}</div>}
                                <div className="text-xs">{getPaymentLabel(sale)} {getPaymentTypeName(sale)}</div>
                              </div>
                            </div>
                            {sale.status !== 'cancelled' && (
                              <div className="flex gap-2 pt-2 border-t">
                                <button onClick={() => startEditSale(sale)} className="flex-1 text-xs py-1 bg-blue-100 text-blue-700 rounded">‚úèÔ∏è {t.edit}</button>
                                <button onClick={() => handleCancelSale(sale)} className="flex-1 text-xs py-1 bg-red-100 text-red-700 rounded">üóëÔ∏è {t.cancel}</button>
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>
              )}
            </>)}

            {/* ========== Í∏∞Î°ù ÌÉ≠ ========== */}
            {activeTab === 'history' && (<>
              <div className="bg-gradient-to-r from-purple-600 to-pink-600 rounded-2xl p-6 text-white mb-4 shadow-lg">
                <h1 className="text-2xl font-bold mb-1">üìä {t.history}</h1>
                <p className="text-purple-100 text-sm">{t.dailyRecord}</p>
              </div>

              <div className="grid grid-cols-4 gap-2 mb-4">
                <button onClick={() => setShowStatsModal(true)} className="bg-white rounded-xl p-3 shadow-sm text-center">
                  <span className="text-xl">üìà</span>
                  <div className="text-xs font-medium text-gray-700 mt-1">{t.popularStats}</div>
                </button>
                <button onClick={exportCSV} className="bg-white rounded-xl p-3 shadow-sm text-center">
                  <span className="text-xl">üì•</span>
                  <div className="text-xs font-medium text-gray-700 mt-1">{t.exportCSV}</div>
                </button>
                <button onClick={() => setShowLogsModal(true)} className="bg-white rounded-xl p-3 shadow-sm text-center">
                  <span className="text-xl">üìú</span>
                  <div className="text-xs font-medium text-gray-700 mt-1">{t.logs}</div>
                </button>
                <button onClick={recalculateAllRecords} className="bg-white rounded-xl p-3 shadow-sm text-center">
                  <span className="text-xl">üîÑ</span>
                  <div className="text-xs font-medium text-gray-700 mt-1">{lang === 'ko' ? 'Ïû¨Í≥ÑÏÇ∞' : 'Recalc'}</div>
                </button>
              </div>

              {dailyRecords.length === 0 ? (
                <div className="bg-white rounded-xl p-8 text-center shadow-sm">
                  <div className="text-4xl mb-4">üì≠</div>
                  <p className="text-gray-500">{t.noClosedRecord}</p>
                </div>
              ) : (
                <div className="space-y-3">
                  {dailyRecords.map(record => (
                    <div key={record.id} className="bg-white rounded-xl p-4 shadow-sm">
                      <div className="flex justify-between mb-3">
                        <div>
                          <div className="font-bold text-lg">{formatDate(record.date, lang)}</div>
                          <div className="text-sm text-gray-500">{record.summary.transactionCount}{t.transactions} / {record.summary.totalItems || 0}{t.items}</div>
                        </div>
                        <div className="text-right">
                          <div className="text-2xl font-bold text-green-600">{formatCurrency(record.summary.totalRevenue)}</div>
                          {record.summary.totalTax > 0 && <div className="text-xs text-orange-500">{t.tax} {formatCurrency(record.summary.totalTax)}</div>}
                        </div>
                      </div>
                      <div className="grid grid-cols-2 gap-2 mb-3">
                        <div className="bg-blue-50 rounded-lg p-2 text-center">
                          <div className="text-xs text-gray-500">üíµ {t.cash}</div>
                          <div className="font-semibold text-blue-600">{formatCurrency(record.summary.cashRevenue)}</div>
                        </div>
                        <div className="bg-purple-50 rounded-lg p-2 text-center">
                          <div className="text-xs text-gray-500">üí≥ {t.card}</div>
                          <div className="font-semibold text-purple-600">{formatCurrency(record.summary.cardRevenue)}</div>
                        </div>
                      </div>
                      <div className="flex gap-2">
                        <button onClick={() => setViewingRecord(record)} className="flex-1 text-sm py-2 bg-gray-100 rounded-lg">üìã {t.detail}</button>
                        <button onClick={() => handleRestoreSales(record)} className="flex-1 text-sm py-2 bg-orange-100 text-orange-700 rounded-lg">‚Ü©Ô∏è {t.restore}</button>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              <div className="mt-8 pt-4 border-t">
                <button onClick={() => setShowResetModal(true)} className="w-full py-3 text-sm text-red-500 hover:bg-red-50 rounded-lg">üóëÔ∏è {t.resetAll}</button>
              </div>
            </>)}
          </div></div>

          {/* ========== Î™®Îã¨Îì§ ========== */}
          
          {/* ÌÜµÍ≥Ñ Î™®Îã¨ */}
          {showStatsModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 w-full max-w-md max-h-[85vh] overflow-y-auto">
                <div className="flex justify-between items-center mb-4">
                  <h3 className="text-lg font-bold">üìà {t.popularStats}</h3>
                  <button onClick={() => setShowStatsModal(false)} className="text-gray-400 text-xl">√ó</button>
                </div>
                <div className="mb-4">
                  <div className="flex gap-2 mb-2">
                    <button onClick={() => setStatsPeriod('week')} className={`flex-1 p-2 rounded-lg border-2 text-sm ${statsPeriod === 'week' ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}`}>{t.week}</button>
                    <button onClick={() => setStatsPeriod('month')} className={`flex-1 p-2 rounded-lg border-2 text-sm ${statsPeriod === 'month' ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}`}>{t.month}</button>
                    <button onClick={() => setStatsPeriod('custom')} className={`flex-1 p-2 rounded-lg border-2 text-sm ${statsPeriod === 'custom' ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}`}>{t.custom}</button>
                  </div>
                  {statsPeriod === 'custom' && (
                    <div className="flex gap-2">
                      <input type="date" value={customStartDate} onChange={e => setCustomStartDate(e.target.value)} className="flex-1 p-2 border rounded-lg text-sm"/>
                      <span className="self-center">~</span>
                      <input type="date" value={customEndDate} onChange={e => setCustomEndDate(e.target.value)} className="flex-1 p-2 border rounded-lg text-sm"/>
                    </div>
                  )}
                </div>
                {(() => {
                  const stats = getStatsData();
                  return (<>
                    <div className="bg-gradient-to-r from-green-100 to-blue-100 rounded-xl p-4 mb-4">
                      <div className="text-xs text-gray-500 mb-1">{formatDateShort(stats.startDate, lang)} ~ {formatDateShort(stats.endDate, lang)}</div>
                      <div className="grid grid-cols-3 gap-2 text-center">
                        <div><div className="text-xl font-bold text-green-600">{formatCurrency(stats.totalRevenue)}</div><div className="text-xs text-gray-500">{t.totalRevenue}</div></div>
                        <div><div className="text-xl font-bold text-blue-600">{stats.totalQty}{t.items}</div><div className="text-xs text-gray-500">{t.soldCount}</div></div>
                        <div><div className="text-xl font-bold text-purple-600">{stats.salesCount}{t.transactions}</div><div className="text-xs text-gray-500">{t.transaction}</div></div>
                      </div>
                    </div>
                    <div className="space-y-2">
                      {stats.items.length === 0 ? (
                        <p className="text-gray-500 text-center py-4">{t.noDataPeriod}</p>
                      ) : stats.items.slice(0, 20).map((item, idx) => (
                        <div key={item.id} className="flex items-center gap-3 p-2 bg-gray-50 rounded-lg">
                          <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-white ${idx === 0 ? 'bg-yellow-500' : idx === 1 ? 'bg-gray-400' : idx === 2 ? 'bg-orange-400' : 'bg-gray-300'}`}>{idx + 1}</div>
                          <div className="flex-1">
                            <div className="font-medium text-sm">{item.name}</div>
                            <div className="text-xs text-gray-500">{item.qty}{t.items} {lang === 'ko' ? 'ÌåêÎß§' : 'sold'}</div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </>);
                })()}
                <button onClick={() => setShowStatsModal(false)} className="w-full mt-4 py-3 bg-gray-200 rounded-xl font-medium">{t.close}</button>
              </div>
            </div>
          )}

          {/* Ïπ¥ÌÖåÍ≥†Î¶¨ Í¥ÄÎ¶¨ Î™®Îã¨ */}
          {showCategoryModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 w-full max-w-sm">
                <h3 className="text-lg font-bold mb-4">
                  {editingCategory ? '‚úèÔ∏è ' + (lang === 'ko' ? 'Ïπ¥ÌÖåÍ≥†Î¶¨ ÏàòÏ†ï' : 'Edit Category') : '‚ûï ' + (lang === 'ko' ? 'Ïπ¥ÌÖåÍ≥†Î¶¨ Ï∂îÍ∞Ä' : 'Add Category')}
                </h3>
                
                <div className="space-y-4">
                  <div>
                    <label className="text-xs text-gray-500 block mb-1">{lang === 'ko' ? 'Ïù¥Î™®ÏßÄ' : 'Emoji'}</label>
                    <input 
                      type="text" 
                      value={newCategoryEmoji} 
                      onChange={e => setNewCategoryEmoji(e.target.value)}
                      className="w-full p-3 text-2xl text-center border rounded-lg"
                      maxLength="2"
                    />
                  </div>
                  
                  <div>
                    <label className="text-xs text-gray-500 block mb-1">{lang === 'ko' ? 'ÌïúÍµ≠Ïñ¥ Ïù¥Î¶Ñ' : 'Korean Name'}</label>
                    <input 
                      type="text" 
                      value={newCategoryName} 
                      onChange={e => setNewCategoryName(e.target.value)}
                      placeholder={lang === 'ko' ? 'Ïòà: Ìè¨Ïä§ÌÑ∞' : 'e.g. Ìè¨Ïä§ÌÑ∞'}
                      className="w-full p-3 border rounded-lg"
                    />
                  </div>
                  
                  <div>
                    <label className="text-xs text-gray-500 block mb-1">{lang === 'ko' ? 'ÏòÅÏñ¥ Ïù¥Î¶Ñ' : 'English Name'}</label>
                    <input 
                      type="text" 
                      value={newCategoryNameEn} 
                      onChange={e => setNewCategoryNameEn(e.target.value)}
                      placeholder={lang === 'ko' ? 'Ïòà: Poster' : 'e.g. Poster'}
                      className="w-full p-3 border rounded-lg"
                    />
                  </div>
                  
                  {editingCategory && (editingCategory.id === 'clicker' || editingCategory.id === 'sticker') && (
                    <div className="p-3 bg-blue-50 rounded-lg text-xs text-blue-700">
                      üí° {lang === 'ko' ? 'Ïù¥ Ïπ¥ÌÖåÍ≥†Î¶¨Îäî 2+1 Ìï†Ïù∏Ïù¥ Ï†ÅÏö©Îê©ÎãàÎã§' : 'This category has 2+1 deal applied'}
                    </div>
                  )}
                </div>
                
                <div className="flex gap-2 mt-6">
                  <button onClick={() => { resetCategoryForm(); setShowCategoryModal(false); }} className="flex-1 py-3 rounded-xl bg-gray-200 font-medium">{t.cancel}</button>
                  {editingCategory && editingCategory.id !== 'clicker' && editingCategory.id !== 'sticker' && editingCategory.id !== 'keyring' && editingCategory.id !== 'blindbag' && (
                    <button onClick={() => handleDeleteCategory(editingCategory.id)} className="py-3 px-4 rounded-xl bg-red-100 text-red-600 font-medium">üóëÔ∏è</button>
                  )}
                  <button 
                    onClick={editingCategory ? handleEditCategory : handleAddCategory} 
                    disabled={!newCategoryName.trim() || !newCategoryNameEn.trim()}
                    className={`flex-1 py-3 rounded-xl font-medium ${!newCategoryName.trim() || !newCategoryNameEn.trim() ? 'bg-gray-300 text-gray-500' : 'bg-blue-600 text-white'}`}
                  >
                    {editingCategory ? t.save : t.add}
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* ÏÑ∏Í∏à ÏÑ§Ï†ï Î™®Îã¨ */}
          {showTaxModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 w-full max-w-sm">
                <h3 className="text-lg font-bold mb-4">‚öôÔ∏è {t.taxSetting}</h3>
                <p className="text-sm text-gray-500 mb-4">{t.taxForSquare}</p>
                <div className="flex items-center justify-center gap-2 mb-4">
                  <input type="number" min="0" max="20" step="0.1" value={tempTaxRate} onChange={e => setTempTaxRate(parseFloat(e.target.value) || 0)} className="w-24 p-3 text-xl font-bold text-center border rounded-lg"/>
                  <span className="text-xl font-bold">%</span>
                </div>
                <div className="flex gap-2">
                  <button onClick={() => setShowTaxModal(false)} className="flex-1 py-3 rounded-xl bg-gray-200 font-medium">{t.cancel}</button>
                  <button onClick={() => { saveTaxRate(tempTaxRate); setShowTaxModal(false); }} className="flex-1 py-3 rounded-xl bg-blue-600 text-white font-medium">{t.save}</button>
                </div>
              </div>
            </div>
          )}

          {/* ÏÉÅÌíà Í¥ÄÎ¶¨ Î™®Îã¨ */}
          {showProductModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 w-full max-w-md max-h-[80vh] overflow-y-auto">
                <div className="flex justify-between items-center mb-4">
                  <h3 className="text-lg font-bold">‚úèÔ∏è {t.productManagement}</h3>
                  <button onClick={() => setShowProductModal(false)} className="text-gray-400 text-xl">√ó</button>
                </div>

                {/* Ïπ¥ÌÖåÍ≥†Î¶¨ ÏÑ†ÌÉù */}
                <div className="flex gap-1 mb-4 overflow-x-auto pb-1">
                  {categories.map(cat => {
                    const displayName = lang === 'ko' ? cat.name : (cat.nameEn || cat.name);
                    return (
                      <button key={cat.id} onClick={() => setSelectedCategory(cat.id)} className={`flex-shrink-0 p-2 rounded-lg border-2 text-xs ${selectedCategory === cat.id ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}`}>
                        {cat.emoji} {displayName}
                      </button>
                    );
                  })}
                </div>

                {/* ÏÉà ÏÉÅÌíà Ï∂îÍ∞Ä */}
                <div className="flex gap-2 mb-4">
                  <input type="text" value={newProductName} onChange={e => setNewProductName(e.target.value)} placeholder={t.newProduct} className="flex-1 p-2 border rounded-lg text-sm"/>
                  {categories.find(c => c.id === selectedCategory)?.priceType === 'fixed' && (
                    <input type="number" value={newProductPrice} onChange={e => setNewProductPrice(parseFloat(e.target.value) || 0)} placeholder="$" className="w-16 p-2 border rounded-lg text-sm text-center"/>
                  )}
                  <button onClick={handleAddProduct} disabled={!newProductName.trim()} className="px-4 py-2 bg-green-500 text-white rounded-lg text-sm font-medium disabled:bg-gray-300">+</button>
                </div>

                {/* ÏÉÅÌíà Î™©Î°ù */}
                <div className="space-y-2">
                  {currentProducts.map(product => (
                    <div key={product.id} className="flex items-center gap-2 p-2 bg-gray-50 rounded-lg">
                      {editingProduct?.id === product.id ? (
                        <>
                          <input type="text" defaultValue={product.name} autoFocus id={`edit-name-${product.id}`} className="flex-1 p-1 border rounded text-sm"/>
                          {product.price !== undefined && (
                            <input type="number" defaultValue={product.price} id={`edit-price-${product.id}`} className="w-16 p-1 border rounded text-sm text-center"/>
                          )}
                          <input type="number" defaultValue={product.stock} id={`edit-stock-${product.id}`} className="w-16 p-1 border rounded text-sm text-center"/>
                          <button onClick={() => {
                            const name = document.getElementById(`edit-name-${product.id}`).value;
                            const price = document.getElementById(`edit-price-${product.id}`)?.value;
                            const stock = document.getElementById(`edit-stock-${product.id}`).value;
                            const updated = products.map(p => {
                              if (p.id === product.id) {
                                const result = { ...p, name, stock: parseInt(stock) || 0 };
                                if (price !== undefined) result.price = parseFloat(price) || 0;
                                return result;
                              }
                              return p;
                            });
                            saveProducts(updated);
                            setEditingProduct(null);
                          }} className="p-1 text-green-500">‚úì</button>
                          <button onClick={() => setEditingProduct(null)} className="p-1 text-gray-500">‚úï</button>
                        </>
                      ) : (
                        <>
                          <span className="flex-1 text-sm font-medium">{product.name}</span>
                          {product.price !== undefined && <span className="text-sm text-green-600 font-medium">${product.price}</span>}
                          <span className="text-sm text-blue-600">{product.stock}</span>
                          <button onClick={() => setEditingProduct(product)} className="p-1 text-blue-500">‚úèÔ∏è</button>
                          <button onClick={() => handleDeleteProduct(product)} className="p-1 text-red-500">üóëÔ∏è</button>
                        </>
                      )}
                    </div>
                  ))}
                </div>

                <button onClick={() => setShowProductModal(false)} className="w-full mt-4 py-3 bg-gray-200 rounded-xl font-medium">{t.close}</button>
              </div>
            </div>
          )}

          {/* ÌåêÎß§ ÏàòÏ†ï Î™®Îã¨ */}
          {editingSale && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 w-full max-w-md max-h-[80vh] overflow-y-auto">
                <h3 className="text-lg font-bold mb-4">‚úèÔ∏è {t.editSale}</h3>
                <div className="mb-4 space-y-2">
                  {Object.entries(editItems).map(([id, qty]) => (
                    <div key={id} className="flex items-center justify-between p-2 bg-gray-50 rounded">
                      <span className="font-medium">{getProductName(id)}</span>
                      <div className="flex items-center gap-2">
                        <button onClick={() => handleEditItemChange(id, -1)} className="w-8 h-8 bg-gray-200 rounded-full font-bold">‚àí</button>
                        <span className="w-8 text-center font-bold">{qty}</span>
                        <button onClick={() => handleEditItemChange(id, 1)} className="w-8 h-8 bg-gray-200 rounded-full font-bold">+</button>
                      </div>
                    </div>
                  ))}
                </div>
                <div className="mb-4">
                  <input type="text" value={editMemo} onChange={e => editDispatch({ type: 'SET_MEMO', value: e.target.value })} placeholder={`üìù ${t.memo}`} className="w-full p-2 border rounded-lg text-sm"/>
                </div>
                <div className="mb-4 p-3 bg-blue-50 rounded-lg">
                  <div className="flex justify-between mb-2">
                    <span className="text-sm">{t.amount}:</span>
                    <label className="flex items-center gap-2 text-xs">
                      <input type="checkbox" checked={useCustomPrice} onChange={e => editDispatch({ type: 'SET_USE_CUSTOM_PRICE', value: e.target.checked })}/>
                      {t.customInput}
                    </label>
                  </div>
                  {useCustomPrice ? (
                    <div className="flex items-center justify-center gap-2">
                      <span className="text-xl">$</span>
                      <input type="number" min="0" value={editPrice} onChange={e => editDispatch({ type: 'SET_PRICE', value: parseFloat(e.target.value) || 0 })} className="w-24 p-2 text-xl font-bold text-center border rounded-lg"/>
                    </div>
                  ) : (
                    <div className="text-center">
                      <span className="text-xl font-bold text-green-600">{formatCurrency(editPrice)}</span>
                    </div>
                  )}
                </div>
                <div className="mb-4">
                  <label className="text-xs text-gray-500 mb-2 block">{t.paymentMethod}</label>
                  <div className="grid grid-cols-2 gap-2 mb-2">
                    <button onClick={() => editDispatch({ type: 'SET_PAYMENT_METHOD', value: 'cash' })} className={`p-2 rounded-lg border-2 ${editPaymentMethod === 'cash' ? 'border-green-500 bg-green-50' : 'border-gray-200'}`}>üíµ {t.cash}</button>
                    <button onClick={() => editDispatch({ type: 'SET_PAYMENT_METHOD', value: 'card' })} className={`p-2 rounded-lg border-2 ${editPaymentMethod === 'card' ? 'border-purple-500 bg-purple-50' : 'border-gray-200'}`}>üí≥ {t.card}</button>
                  </div>
                  {editPaymentMethod === 'card' && (
                    <div className="grid grid-cols-3 gap-2">
                      {CARD_OPTIONS.map(opt => (
                        <button key={opt.id} onClick={() => editDispatch({ type: 'SET_CARD_TYPE', value: opt.id })} className={`p-2 rounded-lg border-2 text-sm ${editCardType === opt.id ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}`}>
                          {opt.emoji} {opt.name}
                        </button>
                      ))}
                    </div>
                  )}
                </div>
                <div className="flex gap-2">
                  <button onClick={() => editDispatch({ type: 'CLOSE_EDIT' })} className="flex-1 py-3 rounded-xl bg-gray-200 font-medium">{t.cancel}</button>
                  <button onClick={handleSaveEdit} disabled={Object.keys(editItems).length === 0} className={`flex-1 py-3 rounded-xl font-medium ${Object.keys(editItems).length === 0 ? 'bg-gray-300' : 'bg-blue-600 text-white'}`}>{t.save}</button>
                </div>
              </div>
            </div>
          )}

          {/* ÎßàÍ∞ê ÌôïÏù∏ Î™®Îã¨ */}
          {showCloseModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 w-full max-w-sm">
                <h3 className="text-lg font-bold mb-2">üåô {t.closeDay}</h3>
                <p className="text-gray-600 text-sm mb-4">{t.closeDayConfirm}</p>
                <div className="bg-gray-50 rounded-lg p-3 mb-4">
                  <div className="flex justify-between text-sm mb-1"><span>{t.totalSales}</span><span className="font-bold text-green-600">{formatCurrency(currentStats.totalRevenue)}</span></div>
                  {currentStats.totalTax > 0 && <div className="flex justify-between text-sm mb-1"><span>{t.tax}</span><span className="text-orange-500">{formatCurrency(currentStats.totalTax)}</span></div>}
                  <div className="flex justify-between text-sm mb-1"><span>üíµ {t.cash}</span><span>{formatCurrency(currentStats.cashRevenue)}</span></div>
                  <div className="flex justify-between text-sm"><span>üí≥ {t.card}</span><span>{formatCurrency(currentStats.cardRevenue)}</span></div>
                </div>
                <div className="flex gap-2">
                  <button onClick={() => setShowCloseModal(false)} className="flex-1 py-3 rounded-xl bg-gray-200 font-medium">{t.cancel}</button>
                  <button onClick={handleDayClose} className="flex-1 py-3 rounded-xl bg-orange-500 text-white font-medium">{t.finalize}</button>
                </div>
              </div>
            </div>
          )}

          {/* ÏÉÅÏÑ∏ Í∏∞Î°ù Î™®Îã¨ */}
          {viewingRecord && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 w-full max-w-md max-h-[80vh] overflow-y-auto">
                <div className="flex justify-between items-start mb-4">
                  <div>
                    <h3 className="text-lg font-bold">{formatDate(viewingRecord.date, lang)}</h3>
                    <p className="text-sm text-gray-500">{t.detailRecord}</p>
                  </div>
                  <button onClick={() => setViewingRecord(null)} className="text-gray-400 text-xl">√ó</button>
                </div>
                <div className="bg-green-50 rounded-lg p-3 mb-4 text-center">
                  <div className="text-2xl font-bold text-green-600">{formatCurrency(viewingRecord.summary.totalRevenue)}</div>
                  {viewingRecord.summary.totalTax > 0 && <div className="text-xs text-orange-500">{t.tax} {formatCurrency(viewingRecord.summary.totalTax)}</div>}
                  <div className="text-sm text-gray-500">{viewingRecord.summary.transactionCount}{t.transactions} / {viewingRecord.summary.totalItems || 0}{t.items}</div>
                </div>
                <div className="space-y-2 mb-4">
                  {viewingRecord.sales.map(sale => {
                    const catInfo = getSaleCategoryInfo(sale);
                    const totalQty = getSaleTotalQty(sale);
                    const itemsList = getSaleItemsList(sale);
                    return (
                      <div key={sale.id} className={`p-3 rounded-lg ${sale.status === 'cancelled' ? 'bg-red-50 opacity-60' : 'bg-gray-50'}`}>
                        <div className="flex justify-between">
                          <div>
                            <div className="font-medium text-sm">
                              {getCategoryEmoji(catInfo.id)} {t[catInfo.id] || catInfo.name} √ó{totalQty}
                              {sale.status === 'cancelled' && <span className="ml-2 text-xs bg-red-200 text-red-700 px-1 rounded">{t.cancelled}</span>}
                            </div>
                            <div className="text-xs text-gray-500">
                              {itemsList.map(item => <span key={item.id} className="mr-2">{item.name} √ó{item.qty}</span>)}
                            </div>
                            {sale.memo && <div className="text-xs text-blue-600 mt-1">üìù {sale.memo}</div>}
                          </div>
                          <div className="text-right">
                            <div className={`font-bold ${sale.status === 'cancelled' ? 'line-through text-gray-400' : 'text-green-600'}`}>{formatCurrency(sale.price)}</div>
                            {sale.tax > 0 && <div className="text-[10px] text-orange-500">{t.tax} {formatCurrency(sale.tax)}</div>}
                            <div className="text-xs">{getPaymentLabel(sale)} {getPaymentTypeName(sale)}</div>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
                <button onClick={() => handleRestoreSales(viewingRecord)} className="w-full py-3 bg-orange-100 text-orange-700 rounded-xl font-medium">‚Ü©Ô∏è {t.restore}</button>
              </div>
            </div>
          )}

          {/* Î¶¨ÏÖã ÌôïÏù∏ Î™®Îã¨ */}
          {showResetModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 w-full max-w-sm">
                <h3 className="text-lg font-bold mb-2 text-red-600">‚ö†Ô∏è {t.resetAll}</h3>
                <p className="text-gray-600 text-sm mb-4">{t.resetConfirm}</p>
                <div className="bg-red-50 rounded-lg p-3 mb-4 text-sm text-red-700">
                  <div>‚Ä¢ {t.resetWarning1}</div>
                  <div>‚Ä¢ {t.resetWarning2}</div>
                  <div>‚Ä¢ {t.resetWarning3}</div>
                  <div>‚Ä¢ {t.resetWarning4}</div>
                </div>
                <div className="flex gap-2">
                  <button onClick={() => setShowResetModal(false)} className="flex-1 py-3 rounded-xl bg-gray-200 font-medium">{t.cancel}</button>
                  <button onClick={handleResetAllData} className="flex-1 py-3 rounded-xl bg-red-500 text-white font-medium">{t.reset}</button>
                </div>
              </div>
            </div>
          )}

          {/* Î°úÍ∑∏ Î™®Îã¨ */}
          {showLogsModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 w-full max-w-md max-h-[85vh] overflow-y-auto">
                <div className="flex justify-between items-center mb-4">
                  <h3 className="text-lg font-bold">üìú {t.logs}</h3>
                  <button onClick={() => setShowLogsModal(false)} className="text-gray-400 text-xl">√ó</button>
                </div>
                {logs.length === 0 ? (
                  <p className="text-gray-500 text-center py-8">{t.noLogs}</p>
                ) : (
                  <div className="space-y-2">
                    {logs.slice(0, 100).map(log => {
                      const time = new Date(log.timestamp).toLocaleString(lang === 'ko' ? 'ko-KR' : 'en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                      let icon, label, details, bgColor;
                      switch(log.action) {
                        case 'sale_created': icon = 'üí∞'; label = t.saleCreated; details = formatCurrency(log.price); bgColor = 'bg-green-50'; break;
                        case 'sale_cancelled': icon = 'üóëÔ∏è'; label = t.saleCancelled; details = formatCurrency(log.price); bgColor = 'bg-red-50'; break;
                        case 'sale_edited': icon = '‚úèÔ∏è'; label = t.saleEdited; details = `${formatCurrency(log.before?.price || 0)} ‚Üí ${formatCurrency(log.after?.price || 0)}`; bgColor = 'bg-blue-50'; break;
                        case 'inventory_changed': icon = 'üì¶'; label = t.inventoryChanged; details = ''; bgColor = 'bg-yellow-50'; break;
                        default: icon = 'üìù'; label = log.action; details = ''; bgColor = 'bg-gray-50';
                      }
                      return (
                        <div key={log.id} className={`p-3 rounded-lg ${bgColor}`}>
                          <div className="flex justify-between items-start">
                            <div>
                              <div className="font-medium text-sm">{icon} {label}</div>
                              {details && <div className="text-xs text-gray-600">{details}</div>}
                              {log.items && (
                                <div className="text-xs text-gray-500">
                                  {Object.entries(log.items).map(([id, qty]) => <span key={id} className="mr-2">{getProductName(id)} √ó{qty}</span>)}
                                </div>
                              )}
                            </div>
                            <div className="text-xs text-gray-400">{time}</div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                )}
                <button onClick={() => setShowLogsModal(false)} className="w-full mt-4 py-3 bg-gray-200 rounded-xl font-medium">{t.close}</button>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
