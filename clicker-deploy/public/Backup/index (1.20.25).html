<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#2563eb">
  <title>í”Œë¦¬ë§ˆì¼“ íŒë§¤ ê´€ë¦¬</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    * { -webkit-tap-highlight-color: transparent; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useMemo, useReducer } = React;

    // Firebase ì„¤ì •
    const firebaseConfig = {
      apiKey: "AIzaSyBxYlNs2yX9seyk52kQPH3_x3HnfyyORMw",
      authDomain: "sales-data-23e78.firebaseapp.com",
      projectId: "sales-data-23e78",
      storageBucket: "sales-data-23e78.firebasestorage.app",
      messagingSenderId: "844253337178",
      appId: "1:844253337178:web:f484c14cba402727627ffa"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ============ ì¹´í…Œê³ ë¦¬ ì„¤ì • ============
    const CATEGORIES = [
      { id: 'clicker', name: 'í´ë¦¬ì»¤', emoji: 'ğŸ¯', priceType: 'algorithm' },
      { id: 'keyring', name: 'í‚¤ë§', emoji: 'ğŸ”‘', priceType: 'fixed' },
      { id: 'sticker', name: 'ìŠ¤í‹°ì»¤', emoji: 'âœ¨', priceType: 'algorithm' },
      { id: 'blindbag', name: 'Blind Bag', emoji: 'ğŸ', priceType: 'fixed' }
    ];

    const CARD_OPTIONS = [
      { id: 'venmo', name: 'Venmo', emoji: 'ğŸ’™', hasTax: false },
      { id: 'zelle', name: 'Zelle', emoji: 'ğŸ’œ', hasTax: false },
      { id: 'square', name: 'Square', emoji: 'â¬›', hasTax: true }
    ];

    // ============ ê¸°ë³¸ ë°ì´í„° ============
    const DEFAULT_PRODUCTS = [
      // Clickers
      { id: 'mew', name: 'Mew', category: 'clicker', stock: 10 },
      { id: 'shiny_mew', name: 'Shiny Mew', category: 'clicker', stock: 10 },
      { id: 'ditto', name: 'Ditto', category: 'clicker', stock: 10 },
      { id: 'shiny_ditto', name: 'Shiny Ditto', category: 'clicker', stock: 10 },
      { id: 'psyduck', name: 'Psyduck', category: 'clicker', stock: 10 },
      { id: 'gengar', name: 'Gengar', category: 'clicker', stock: 10 },
      { id: 'mewtwo', name: 'Mew Two', category: 'clicker', stock: 10 },
      { id: 'cubone', name: 'Cubone', category: 'clicker', stock: 10 },
      { id: 'bulbasaur', name: 'Bulbasaur', category: 'clicker', stock: 10 },
      { id: 'flareon', name: 'Flareon', category: 'clicker', stock: 10 },
      { id: 'vaporeon', name: 'Vaporeon', category: 'clicker', stock: 10 },
      { id: 'snorlax', name: 'Snorlax', category: 'clicker', stock: 10 },
      { id: 'vulpix', name: 'Vulpix', category: 'clicker', stock: 10 },
      { id: 'pikachu', name: 'Pikachu', category: 'clicker', stock: 10 },
      { id: 'charmander', name: 'Charmander', category: 'clicker', stock: 10 },
      { id: 'blastoise', name: 'Blastoise', category: 'clicker', stock: 10 },
      { id: 'eevee', name: 'Eevee', category: 'clicker', stock: 10 },
      { id: 'jolteon', name: 'Jolteon', category: 'clicker', stock: 10 },
      { id: 'squirtle', name: 'Squirtle', category: 'clicker', stock: 10 },
      { id: 'jigglypuff', name: 'Jigglypuff', category: 'clicker', stock: 10 },
      { id: 'umbreon', name: 'Umbreon', category: 'clicker', stock: 10 },
      // Keyrings
      { id: 'keyring1', name: 'Keyring A', category: 'keyring', price: 8, stock: 10 },
      { id: 'keyring2', name: 'Keyring B', category: 'keyring', price: 8, stock: 10 },
      { id: 'keyring3', name: 'Keyring C', category: 'keyring', price: 8, stock: 10 },
      // Stickers
      { id: 'sticker1', name: 'Sticker A', category: 'sticker', price: 5, stock: 10 },
      { id: 'sticker2', name: 'Sticker B', category: 'sticker', price: 5, stock: 10 },
      { id: 'sticker3', name: 'Sticker C', category: 'sticker', price: 5, stock: 10 },
      // Blind Bags
      { id: 'blindbag1', name: 'Blind Bag S', category: 'blindbag', price: 10, stock: 10 },
      { id: 'blindbag2', name: 'Blind Bag M', category: 'blindbag', price: 15, stock: 10 },
      { id: 'blindbag3', name: 'Blind Bag L', category: 'blindbag', price: 20, stock: 10 }
    ];

    // ============ ìœ í‹¸ í•¨ìˆ˜ ============
    const calculateClickerPrice = (qty) => qty <= 0 ? 0 : Math.floor(qty / 2) * 20 + (qty % 2) * 12;
    const calculateStickerPrice = (qty) => qty <= 0 ? 0 : Math.floor(qty / 2) * 5 + (qty % 2) * 3;
    const formatCurrency = (amount) => '$' + (amount || 0).toFixed(2);
    const formatDate = (d, lang) => new Date(d).toLocaleDateString(lang === 'ko' ? 'ko-KR' : 'en-US', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' });
    const formatDateShort = (d, lang) => new Date(d).toLocaleDateString(lang === 'ko' ? 'ko-KR' : 'en-US', { month: 'short', day: 'numeric' });
    const generateId = () => 'p_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

    // ============ ë²ˆì—­ ============
    const TRANSLATIONS = {
      ko: {
        sales: 'íŒë§¤', history: 'ê¸°ë¡', title: 'í”Œë¦¬ë§ˆì¼“ íŒë§¤ ê´€ë¦¬', subtitle: 'ì¬ê³  & ë§¤ì¶œ íŠ¸ë˜ì»¤',
        todaySales: 'ì˜¤ëŠ˜ ë§¤ì¶œ', currentList: 'í˜„ì¬ ëª©ë¡', totalSales: 'ì´ ë§¤ì¶œ', cash: 'í˜„ê¸ˆ', card: 'ì¹´ë“œ',
        taxIncluded: 'ì„¸ê¸ˆ í¬í•¨', items: 'ê°œ', transactions: 'ê±´', closeDay: 'ì¥ì‚¬ ë§ˆë¬´ë¦¬',
        salesRecord: 'íŒë§¤ ê¸°ë¡', productMgmt: 'ìƒí’ˆ ê´€ë¦¬', inventory: 'ì¬ê³ ', tapToAdd: 'íƒ­í•˜ë©´ +1',
        selected: 'ì„ íƒë¨', clearAll: 'ì „ì²´ ì·¨ì†Œ', total: 'ì´', taxAmount: 'ì„¸ê¸ˆ',
        paymentMethod: 'ê²°ì œ ë°©ì‹', saleComplete: 'íŒë§¤ ì™„ë£Œ', selectProduct: 'ìƒí’ˆì„ ì„ íƒí•˜ì„¸ìš”',
        memo: 'ë©”ëª¨ (ì„ íƒì‚¬í•­)', edit: 'ìˆ˜ì •', cancel: 'ì·¨ì†Œ', delete: 'ì‚­ì œ', save: 'ì €ì¥', close: 'ë‹«ê¸°',
        applyTax: 'ì„¸ìœ¨ ì ìš©', taxRate: 'ì„¸ìœ¨', taxSetting: 'ì„¸ìœ¨ ì„¤ì •', taxForSquare: 'ìŠ¤í€˜ì–´ ê²°ì œ ì‹œ ì ìš©ë˜ëŠ” ì„¸ìœ¨',
        noSalesRecord: 'íŒë§¤ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤', salesHistory: 'íŒë§¤ ê¸°ë¡',
        dailyRecord: 'ì¼ë³„ ë§ˆê° ê¸°ë¡', popularStats: 'ì¸ê¸° ìƒí’ˆ í†µê³„', exportCSV: 'CSV ë‚´ë³´ë‚´ê¸°',
        noClosedRecord: 'ë§ˆê° ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤', detail: 'ìƒì„¸', restore: 'ë³µêµ¬',
        resetAll: 'ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”', week: '1ì£¼', month: '1ë‹¬', custom: 'ì»¤ìŠ¤í…€',
        totalRevenue: 'ì´ ë§¤ì¶œ', soldCount: 'íŒë§¤ëŸ‰', transaction: 'ê±°ë˜', noDataPeriod: 'í•´ë‹¹ ê¸°ê°„ íŒë§¤ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤',
        productManagement: 'ìƒí’ˆ ê´€ë¦¬', newProduct: 'ìƒˆ ìƒí’ˆ ì´ë¦„', add: 'ì¶”ê°€', price: 'ê°€ê²©',
        editSale: 'íŒë§¤ ìˆ˜ì •', customInput: 'ì§ì ‘ ì…ë ¥', addTax: '+ ì„¸ê¸ˆ', amount: 'ê¸ˆì•¡',
        closeDayConfirm: 'íŒë§¤ ê¸°ë¡ì„ ë§ˆê°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', tax: 'ì„¸ê¸ˆ', finalize: 'ë§ˆê°',
        detailRecord: 'ìƒì„¸ íŒë§¤ ê¸°ë¡', restoreThis: 'ì´ ê¸°ë¡ ë³µêµ¬í•˜ê¸°',
        resetConfirm: 'ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', resetWarning1: 'íŒë§¤ ê¸°ë¡ ì‚­ì œ', resetWarning2: 'ë§ˆê° ê¸°ë¡ ì‚­ì œ',
        resetWarning3: 'ìƒí’ˆ ëª©ë¡ ì´ˆê¸°í™”', resetWarning4: 'ì¬ê³  ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µêµ¬', reset: 'ì´ˆê¸°í™”', loading: 'ë¡œë”© ì¤‘...',
        firebaseMode: 'ğŸ”¥ Firebase ì—°ë™', algorithmApplied: '2ê°œ=20ë¶ˆ í• ì¸ ì ìš©', stickerDeal: '2ê°œ=$5 í• ì¸ ì ìš©', cancelled: 'ì·¨ì†Œë¨',
        logs: 'ë³€ê²½ ë¡œê·¸', noLogs: 'ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤',
        saleCreated: 'íŒë§¤ ë“±ë¡', saleCancelled: 'íŒë§¤ ì·¨ì†Œ', saleEdited: 'íŒë§¤ ìˆ˜ì •', inventoryChanged: 'ì¬ê³  ìˆ˜ì •',
        clicker: 'í´ë¦¬ì»¤', keyring: 'í‚¤ë§', sticker: 'ìŠ¤í‹°ì»¤', blindbag: 'Blind Bag', mixed: 'ë³µí•©',
        stock: 'ì¬ê³ ', addProduct: 'ìƒí’ˆ ì¶”ê°€', editProduct: 'ìƒí’ˆ ìˆ˜ì •'
      },
      en: {
        sales: 'Sales', history: 'History', title: 'Flea Market POS', subtitle: 'Inventory & Sales Tracker',
        todaySales: "Today's Sales", currentList: 'Current List', totalSales: 'Total Sales', cash: 'Cash', card: 'Card',
        taxIncluded: 'Tax included', items: '', transactions: '', closeDay: 'Close Day',
        salesRecord: 'Sales Record', productMgmt: 'Products', inventory: 'Inventory', tapToAdd: 'Tap to +1',
        selected: 'Selected', clearAll: 'Clear All', total: 'Total', taxAmount: 'Tax',
        paymentMethod: 'Payment Method', saleComplete: 'Sale Complete', selectProduct: 'Select products',
        memo: 'Memo (optional)', edit: 'Edit', cancel: 'Cancel', delete: 'Delete', save: 'Save', close: 'Close',
        applyTax: 'Apply Tax', taxRate: 'Tax Rate', taxSetting: 'Tax Settings', taxForSquare: 'Tax rate applied to Square payments',
        noSalesRecord: 'No sales records', salesHistory: 'Sales History',
        dailyRecord: 'Daily Records', popularStats: 'Popular Items', exportCSV: 'Export CSV',
        noClosedRecord: 'No closed records', detail: 'Detail', restore: 'Restore',
        resetAll: 'Reset All Data', week: '1 Week', month: '1 Month', custom: 'Custom',
        totalRevenue: 'Revenue', soldCount: 'Sold', transaction: 'Txns', noDataPeriod: 'No sales data for this period',
        productManagement: 'Manage Products', newProduct: 'New product name', add: 'Add', price: 'Price',
        editSale: 'Edit Sale', customInput: 'Custom', addTax: '+ Tax', amount: 'Amount',
        closeDayConfirm: 'Close sales for the day?', tax: 'Tax', finalize: 'Finalize',
        detailRecord: 'Sale Details', restoreThis: 'Restore this record',
        resetConfirm: 'Delete all data?', resetWarning1: 'Delete sales records', resetWarning2: 'Delete daily records',
        resetWarning3: 'Reset product list', resetWarning4: 'Reset inventory to default', reset: 'Reset', loading: 'Loading...',
        firebaseMode: 'ğŸ”¥ Firebase Connected', algorithmApplied: '2 for $20 deal applied', stickerDeal: '2 for $5 deal applied', cancelled: 'Cancelled',
        logs: 'Change Log', noLogs: 'No logs yet',
        saleCreated: 'Sale Created', saleCancelled: 'Sale Cancelled', saleEdited: 'Sale Edited', inventoryChanged: 'Inventory Changed',
        clicker: 'Clicker', keyring: 'Keyring', sticker: 'Sticker', blindbag: 'Blind Bag', mixed: 'Mixed',
        stock: 'Stock', addProduct: 'Add Product', editProduct: 'Edit Product'
      }
    };

    // ============ Reducers (ìƒíƒœ ê·¸ë£¹í™”) ============
    
    // íŒë§¤ ìˆ˜ì • ëª¨ë‹¬ ìƒíƒœ
    const editInitialState = {
      sale: null,
      items: {},
      paymentMethod: 'cash',
      cardType: 'venmo',
      price: 0,
      memo: '',
      useCustomPrice: false
    };

    function editReducer(state, action) {
      switch (action.type) {
        case 'START_EDIT':
          const sale = action.sale;
          // ìƒˆ/êµ¬ êµ¬ì¡° í˜¸í™˜
          let items = {};
          if (sale.itemDetails) {
            sale.itemDetails.forEach(item => { items[item.id] = item.qty; });
          } else if (sale.items) {
            items = { ...sale.items };
          }
          const payment = sale.payment || {};
          return {
            sale: sale,
            items: items,
            paymentMethod: payment.method || sale.paymentMethod || 'cash',
            cardType: payment.type || sale.cardType || 'venmo',
            price: sale.price || 0,
            memo: sale.memo || '',
            useCustomPrice: false
          };
        case 'UPDATE_ITEM':
          const newQty = (state.items[action.id] || 0) + action.delta;
          if (newQty <= 0) {
            const { [action.id]: removed, ...rest } = state.items;
            return { ...state, items: rest };
          }
          return { ...state, items: { ...state.items, [action.id]: newQty } };
        case 'SET_PAYMENT_METHOD':
          return { ...state, paymentMethod: action.value };
        case 'SET_CARD_TYPE':
          return { ...state, cardType: action.value };
        case 'SET_PRICE':
          return { ...state, price: action.value };
        case 'SET_MEMO':
          return { ...state, memo: action.value };
        case 'SET_USE_CUSTOM_PRICE':
          return { ...state, useCustomPrice: action.value };
        case 'CLOSE_EDIT':
          return editInitialState;
        default:
          return state;
      }
    }

    // ìƒˆ íŒë§¤ ì…ë ¥ ìƒíƒœ
    const saleInputInitialState = {
      selectedItems: {},
      paymentMethod: 'cash',
      cardType: 'venmo',
      memo: '',
      useCustomPrice: false,
      customPrice: 0,
      addTaxToCustom: false
    };

    function saleInputReducer(state, action) {
      switch (action.type) {
        case 'ADD_ITEM':
          const catItems = state.selectedItems[action.category] || {};
          return {
            ...state,
            selectedItems: {
              ...state.selectedItems,
              [action.category]: { ...catItems, [action.id]: (catItems[action.id] || 0) + 1 }
            }
          };
        case 'DECREASE_ITEM':
          const cat = action.category;
          const currentCatItems = state.selectedItems[cat] || {};
          const currentQty = currentCatItems[action.id] || 0;
          if (currentQty <= 1) {
            const { [action.id]: removed, ...restItems } = currentCatItems;
            if (Object.keys(restItems).length === 0) {
              const { [cat]: removedCat, ...restCats } = state.selectedItems;
              return { ...state, selectedItems: restCats };
            }
            return { ...state, selectedItems: { ...state.selectedItems, [cat]: restItems } };
          }
          return {
            ...state,
            selectedItems: {
              ...state.selectedItems,
              [cat]: { ...currentCatItems, [action.id]: currentQty - 1 }
            }
          };
        case 'SET_PAYMENT_METHOD':
          return { ...state, paymentMethod: action.value };
        case 'SET_CARD_TYPE':
          return { ...state, cardType: action.value };
        case 'SET_MEMO':
          return { ...state, memo: action.value };
        case 'SET_USE_CUSTOM_PRICE':
          return { ...state, useCustomPrice: action.value };
        case 'SET_CUSTOM_PRICE':
          return { ...state, customPrice: action.value };
        case 'SET_ADD_TAX':
          return { ...state, addTaxToCustom: action.value };
        case 'CLEAR':
          return saleInputInitialState;
        default:
          return state;
      }
    }

    // ============ Firebase í›… ============
    function useFirebaseData(collectionName, defaultValue) {
      const [data, setData] = useState(defaultValue);
      const [loading, setLoading] = useState(true);
      
      useEffect(() => {
        const unsubscribe = db.collection('store').doc(collectionName).onSnapshot((doc) => {
          if (doc.exists) setData(doc.data().value);
          else setData(defaultValue);
          setLoading(false);
        }, (error) => { console.error('Firebase error:', error); setLoading(false); });
        return () => unsubscribe();
      }, [collectionName]);

      const saveData = async (newData) => {
        try { 
          await db.collection('store').doc(collectionName).set({ 
            value: newData, 
            updatedAt: new Date().toISOString() 
          }); 
          setData(newData); 
        }
        catch (error) { console.error('Save error:', error); }
      };

      return [data, saveData, loading];
    }

    // ============ ë©”ì¸ ì•± ============
    function App() {
      const [lang, setLang] = useState('en');
      const t = TRANSLATIONS[lang];
      const [activeTab, setActiveTab] = useState('sales');
      const [selectedCategory, setSelectedCategory] = useState('clicker');
      
      // íŒë§¤ ì…ë ¥ ìƒíƒœ (ê·¸ë£¹í™”)
      const [saleInput, saleDispatch] = useReducer(saleInputReducer, saleInputInitialState);
      const { selectedItems, paymentMethod, cardType, memo: saleMemo, useCustomPrice: useCustomSalePrice, customPrice: customSalePrice, addTaxToCustom } = saleInput;
      
      // ëª¨ë‹¬ ìƒíƒœë“¤
      const [showTaxModal, setShowTaxModal] = useState(false);
      const [tempTaxRate, setTempTaxRate] = useState(9.5);
      const [showProductModal, setShowProductModal] = useState(false);
      const [editingProduct, setEditingProduct] = useState(null);
      const [newProductName, setNewProductName] = useState('');
      const [newProductPrice, setNewProductPrice] = useState(10);
      const [showSalesHistory, setShowSalesHistory] = useState(false);
      
      // íŒë§¤ ìˆ˜ì • ìƒíƒœ (ê·¸ë£¹í™”)
      const [editState, editDispatch] = useReducer(editReducer, editInitialState);
      const { sale: editingSale, items: editItems, paymentMethod: editPaymentMethod, cardType: editCardType, price: editPrice, memo: editMemo, useCustomPrice } = editState;
      
      const [showCloseModal, setShowCloseModal] = useState(false);
      const [viewingRecord, setViewingRecord] = useState(null);
      const [showResetModal, setShowResetModal] = useState(false);
      const [showStatsModal, setShowStatsModal] = useState(false);
      const [statsPeriod, setStatsPeriod] = useState('week');
      const [customStartDate, setCustomStartDate] = useState('');
      const [customEndDate, setCustomEndDate] = useState('');
      const [showLogsModal, setShowLogsModal] = useState(false);

      // Firebase ë°ì´í„° - ìƒˆ í†µí•© êµ¬ì¡°
      const [products, saveProducts, productsLoading] = useFirebaseData('products', DEFAULT_PRODUCTS);
      const [sales, saveSales, salesLoading] = useFirebaseData('sales', []);
      const [dailyRecords, saveDailyRecords, recordsLoading] = useFirebaseData('dailyRecords', []);
      const [taxRate, saveTaxRate, taxLoading] = useFirebaseData('taxRate', 9.5);
      const [logs, saveLogs, logsLoading] = useFirebaseData('logs', []);

      const loading = productsLoading || salesLoading || recordsLoading || taxLoading || logsLoading;

      // ============ ë©”ëª¨ì´ì œì´ì…˜ (ì„±ëŠ¥ ìµœì í™”) ============
      
      // ì¹´í…Œê³ ë¦¬ Map - O(1) ì¡°íšŒ
      const categoriesMap = useMemo(() => {
        const map = new Map();
        CATEGORIES.forEach(c => map.set(c.id, c));
        return map;
      }, []);

      // ìƒí’ˆ Map - O(1) ì¡°íšŒ (ê¸°ì¡´: ë§¤ë²ˆ 60ê°œ ê²€ìƒ‰ â†’ ê°œì„ : ì¦‰ì‹œ ì°¾ê¸°)
      const productsMap = useMemo(() => {
        const map = new Map();
        products.forEach(p => map.set(p.id, p));
        return map;
      }, [products]);

      // ì¹´í…Œê³ ë¦¬ë³„ ìƒí’ˆ í•„í„°ë§
      const productsByCategory = useMemo(() => {
        const result = {};
        CATEGORIES.forEach(cat => {
          result[cat.id] = products.filter(p => p.category === cat.id);
        });
        return result;
      }, [products]);

      // í˜„ì¬ ì¹´í…Œê³ ë¦¬ ìƒí’ˆ
      const currentProducts = productsByCategory[selectedCategory] || [];

      // ë¡œê·¸ ì¶”ê°€
      const addLog = async (action, details) => {
        const newLog = { id: Date.now(), timestamp: new Date().toISOString(), action, ...details };
        await saveLogs([newLog, ...logs]);
      };

      // ìƒí’ˆ ì°¾ê¸° í—¬í¼ (Map ì‚¬ìš©ìœ¼ë¡œ ì¦‰ì‹œ ì¡°íšŒ)
      const getProduct = (id) => productsMap.get(id);
      const getProductName = (id) => productsMap.get(id)?.name || id;
      const getProductPrice = (id) => productsMap.get(id)?.price;
      const getProductCategory = (id) => productsMap.get(id)?.category;

      // ìƒí’ˆ ì¬ê³  ì—…ë°ì´íŠ¸
      const updateStock = async (itemId, delta) => {
        const updated = products.map(p => 
          p.id === itemId ? { ...p, stock: Math.max(0, (p.stock || 0) + delta) } : p
        );
        await saveProducts(updated);
      };

      // ë‹¤ì¤‘ ì¬ê³  ì—…ë°ì´íŠ¸
      const updateMultipleStock = async (changes) => {
        // changes: { itemId: delta, ... }
        const updated = products.map(p => {
          if (changes[p.id] !== undefined) {
            return { ...p, stock: Math.max(0, (p.stock || 0) + changes[p.id]) };
          }
          return p;
        });
        await saveProducts(updated);
      };

      // ============ ê°€ê²© ê³„ì‚° ============
      const calculateCategoryPrice = (items, categoryId) => {
        const category = CATEGORIES.find(c => c.id === categoryId);
        if (category?.priceType === 'algorithm') {
          const totalQty = Object.values(items).reduce((s, q) => s + q, 0);
          // ì¹´í…Œê³ ë¦¬ë³„ ë‹¤ë¥¸ ì•Œê³ ë¦¬ì¦˜ ì ìš©
          if (categoryId === 'clicker') {
            return calculateClickerPrice(totalQty);
          } else if (categoryId === 'sticker') {
            return calculateStickerPrice(totalQty);
          }
          return 0;
        } else {
          let total = 0;
          Object.entries(items).forEach(([id, qty]) => {
            const product = getProduct(id);
            if (product?.price) total += product.price * qty;
          });
          return total;
        }
      };

      const calculateTotalPrice = () => {
        let total = 0;
        Object.entries(selectedItems).forEach(([catId, items]) => {
          total += calculateCategoryPrice(items, catId);
        });
        return total;
      };

      const calculateTax = (basePrice, method, cType) => 
        (method === 'card' && cType === 'square') ? basePrice * (taxRate / 100) : 0;

      // ============ ì•„ì´í…œ ì„ íƒ ============
      const handleItemTap = (itemId) => {
        const product = getProduct(itemId);
        if (!product || product.stock <= 0) return;
        
        const catItems = selectedItems[selectedCategory] || {};
        const cur = catItems[itemId] || 0;
        
        if (cur < product.stock) {
          saleDispatch({ type: 'ADD_ITEM', category: selectedCategory, id: itemId });
        }
      };

      const handleItemDecrease = (itemId, categoryId = selectedCategory) => {
        saleDispatch({ type: 'DECREASE_ITEM', category: categoryId, id: itemId });
      };

      const clearSelection = () => { 
        saleDispatch({ type: 'CLEAR' });
      };

      const getTotalQuantity = () => {
        return Object.values(selectedItems).reduce((total, catItems) => 
          total + Object.values(catItems).reduce((s, q) => s + q, 0), 0);
      };

      // ============ íŒë§¤ ì²˜ë¦¬ ============
      const handleSale = async () => {
        const totalQty = getTotalQuantity();
        if (totalQty === 0) return;

        const calcPrice = calculateTotalPrice();
        const finalBase = useCustomSalePrice ? customSalePrice : calcPrice;
        const rawTax = useCustomSalePrice 
          ? (addTaxToCustom ? calculateTax(customSalePrice, paymentMethod, cardType) : 0) 
          : calculateTax(calcPrice, paymentMethod, cardType);
        const tax = Math.round(rawTax * 100) / 100; // ì†Œìˆ˜ì  2ìë¦¬ ì •ë¦¬
        const finalPrice = Math.round((finalBase + tax) * 100) / 100;

        const includedCategories = Object.keys(selectedItems);
        const isMixed = includedCategories.length > 1;

        // ğŸ†• ì½ê¸° ì‰¬ìš´ ì•„ì´í…œ ìƒì„¸ ë°°ì—´
        const itemDetails = [];
        const stockChanges = {};
        
        Object.entries(selectedItems).forEach(([catId, catItems]) => {
          Object.entries(catItems).forEach(([id, qty]) => {
            const product = getProduct(id);
            const category = CATEGORIES.find(c => c.id === catId);
            
            itemDetails.push({
              id,
              name: product?.name || id,
              category: catId,
              categoryName: category?.name || catId,
              qty,
              ...(product?.price && { unitPrice: product.price, subtotal: product.price * qty })
            });
            
            stockChanges[id] = -qty;
          });
        });

        // ì¹´í…Œê³ ë¦¬ëª… (ë³µí•©ì¸ ê²½ìš°)
        const categoryNames = includedCategories
          .map(c => CATEGORIES.find(cat => cat.id === c)?.name)
          .join(' + ');

        // ğŸ†• ê°œì„ ëœ íŒë§¤ ê¸°ë¡ êµ¬ì¡°
        const newSale = {
          id: Date.now(),
          timestamp: new Date().toISOString(),
          status: 'active',
          
          // ì¹´í…Œê³ ë¦¬ ì •ë³´
          category: {
            id: isMixed ? 'mixed' : includedCategories[0],
            name: isMixed ? categoryNames : CATEGORIES.find(c => c.id === includedCategories[0])?.name,
            isMixed
          },
          
          // ğŸ†• ì½ê¸° ì‰¬ìš´ ì•„ì´í…œ ëª©ë¡
          itemDetails,
          
          // ê¸ˆì•¡ ì •ë³´
          totalQty,
          basePrice: Math.round(finalBase * 100) / 100,
          tax,
          price: finalPrice,
          
          // ğŸ†• ê²°ì œ ì •ë³´ ê·¸ë£¹í™”
          payment: {
            method: paymentMethod,
            ...(paymentMethod === 'card' && { type: cardType })
          },
          
          // ë©”ëª¨ (ê°’ì´ ìˆì„ ë•Œë§Œ)
          ...(saleMemo.trim() && { memo: saleMemo.trim() })
        };

        await updateMultipleStock(stockChanges);
        await saveSales([newSale, ...sales]);
        await addLog('sale_created', {
          saleId: newSale.id,
          categories: includedCategories,
          itemDetails: itemDetails.map(i => ({ name: i.name, qty: i.qty })),
          price: finalPrice,
          payment: newSale.payment
        });

        saleDispatch({ type: 'CLEAR' });
      };

      // ============ íŒë§¤ ì·¨ì†Œ ============
      const handleCancelSale = async (sale) => {
        const stockChanges = {};
        
        // ìƒˆ êµ¬ì¡° (itemDetails ë°°ì—´) ë˜ëŠ” ê¸°ì¡´ êµ¬ì¡° (items ê°ì²´) í˜¸í™˜
        if (sale.itemDetails) {
          sale.itemDetails.forEach(item => {
            stockChanges[item.id] = item.qty;
          });
        } else if (sale.items) {
          Object.entries(sale.items).forEach(([id, q]) => {
            stockChanges[id] = q;
          });
        }
        
        await updateMultipleStock(stockChanges);
        await saveSales(sales.map(s => 
          s.id === sale.id ? { ...sale, status: 'cancelled', cancelledAt: new Date().toISOString() } : s
        ));
        await addLog('sale_cancelled', {
          saleId: sale.id,
          itemDetails: sale.itemDetails?.map(i => ({ name: i.name, qty: i.qty })) || Object.entries(sale.items || {}).map(([id, qty]) => ({ name: getProductName(id), qty })),
          price: sale.price,
          originalTimestamp: sale.timestamp
        });
      };

      // ============ íŒë§¤ ìˆ˜ì • ============
      // í—¬í¼: saleì—ì„œ items ê°ì²´ ì¶”ì¶œ (ìƒˆ/êµ¬ êµ¬ì¡° í˜¸í™˜)
      const getSaleItems = (sale) => {
        if (sale.itemDetails) {
          const items = {};
          sale.itemDetails.forEach(item => {
            items[item.id] = item.qty;
          });
          return items;
        }
        return sale.items || {};
      };

      // í—¬í¼: saleì—ì„œ ê²°ì œ ì •ë³´ ì¶”ì¶œ (ìƒˆ/êµ¬ êµ¬ì¡° í˜¸í™˜)
      const getSalePayment = (sale) => {
        if (sale.payment) {
          return { method: sale.payment.method, cardType: sale.payment.type };
        }
        return { method: sale.paymentMethod, cardType: sale.cardType };
      };

      const startEditSale = (sale) => {
        editDispatch({ type: 'START_EDIT', sale: sale });
      };

      const handleEditItemChange = (id, delta) => {
        editDispatch({ type: 'UPDATE_ITEM', id: id, delta: delta });
      };

      const handleSaveEdit = async () => {
        const totalQty = Object.values(editItems).reduce((s, q) => s + q, 0);
        if (totalQty === 0) return;

        const oldSale = editingSale;
        const oldItems = getSaleItems(oldSale);
        
        // ê°€ê²© ê³„ì‚°
        let calcPrice = 0;
        const newItemDetails = [];
        
        Object.entries(editItems).forEach(([id, qty]) => {
          const product = getProduct(id);
          if (product) {
            if (product.category !== 'clicker') {
              calcPrice += (product.price || 0) * qty;
            }
            newItemDetails.push({
              id,
              name: product.name,
              category: product.category,
              categoryName: CATEGORIES.find(c => c.id === product.category)?.name,
              qty,
              ...(product.price && { unitPrice: product.price, subtotal: product.price * qty })
            });
          }
        });
        
        // í´ë¦¬ì»¤ ê°€ê²© ê³„ì‚°
        const clickerQty = Object.entries(editItems).reduce((sum, [id, qty]) => {
          const p = getProduct(id);
          return p?.category === 'clicker' ? sum + qty : sum;
        }, 0);
        calcPrice += calculateClickerPrice(clickerQty);

        // ìŠ¤í‹°ì»¤ ê°€ê²© ê³„ì‚°
        const stickerQty = Object.entries(editItems).reduce((sum, [id, qty]) => {
          const p = getProduct(id);
          return p?.category === 'sticker' ? sum + qty : sum;
        }, 0);
        calcPrice += calculateStickerPrice(stickerQty);

        const basePriceVal = useCustomPrice ? editPrice : calcPrice;
        const rawTax = useCustomPrice ? 0 : calculateTax(calcPrice, editPaymentMethod, editCardType);
        const tax = Math.round(rawTax * 100) / 100;
        const finalPrice = Math.round((basePriceVal + tax) * 100) / 100;

        // ì¬ê³  ì¡°ì •
        const stockChanges = {};
        Object.entries(oldItems).forEach(([id, q]) => {
          stockChanges[id] = (stockChanges[id] || 0) + q;
        });
        Object.entries(editItems).forEach(([id, q]) => {
          stockChanges[id] = (stockChanges[id] || 0) - q;
        });

        // ì¹´í…Œê³ ë¦¬ ì •ë³´
        const categories = [...new Set(newItemDetails.map(i => i.category))];
        const isMixed = categories.length > 1;
        const categoryNames = categories.map(c => CATEGORIES.find(cat => cat.id === c)?.name).join(' + ');

        // ğŸ†• ê°œì„ ëœ êµ¬ì¡°ë¡œ ì €ì¥
        const updatedSale = {
          id: oldSale.id,
          timestamp: oldSale.timestamp,
          status: oldSale.status,
          
          category: {
            id: isMixed ? 'mixed' : categories[0],
            name: isMixed ? categoryNames : CATEGORIES.find(c => c.id === categories[0])?.name,
            isMixed
          },
          
          itemDetails: newItemDetails,
          
          totalQty,
          basePrice: Math.round(basePriceVal * 100) / 100,
          tax,
          price: finalPrice,
          
          payment: {
            method: editPaymentMethod,
            ...(editPaymentMethod === 'card' && { type: editCardType })
          },
          
          ...(editMemo.trim() && { memo: editMemo.trim() }),
          modifiedAt: new Date().toISOString()
        };

        await updateMultipleStock(stockChanges);
        await saveSales(sales.map(s => s.id === oldSale.id ? updatedSale : s));
        await addLog('sale_edited', {
          saleId: oldSale.id,
          before: { 
            items: oldSale.itemDetails?.map(i => ({ name: i.name, qty: i.qty })) || Object.entries(oldItems).map(([id, qty]) => ({ name: getProductName(id), qty })),
            price: oldSale.price 
          },
          after: { 
            items: newItemDetails.map(i => ({ name: i.name, qty: i.qty })),
            price: finalPrice 
          }
        });

        editDispatch({ type: 'CLOSE_EDIT' });
      };

      // ============ ìƒí’ˆ ê´€ë¦¬ ============
      const handleAddProduct = async () => {
        if (!newProductName.trim()) return;
        
        const category = CATEGORIES.find(c => c.id === selectedCategory);
        const newProduct = {
          id: generateId(),
          name: newProductName.trim(),
          category: selectedCategory,
          stock: 10
        };
        
        if (category?.priceType === 'fixed') {
          newProduct.price = newProductPrice;
        }

        await saveProducts([...products, newProduct]);
        setNewProductName('');
        setNewProductPrice(10);
      };

      const handleEditProduct = async (product, newName, newPrice) => {
        if (!newName.trim()) return;
        
        const updated = products.map(p => {
          if (p.id === product.id) {
            const result = { ...p, name: newName.trim() };
            if (newPrice !== undefined && p.price !== undefined) {
              result.price = newPrice;
            }
            return result;
          }
          return p;
        });
        
        await saveProducts(updated);
        setEditingProduct(null);
      };

      const handleDeleteProduct = async (product) => {
        await saveProducts(products.filter(p => p.id !== product.id));
      };

      const handleUpdateStock = async (productId, newStock) => {
        const updated = products.map(p => 
          p.id === productId ? { ...p, stock: parseInt(newStock) || 0 } : p
        );
        await saveProducts(updated);
      };

      // ============ ë§ˆê° ì²˜ë¦¬ ============
      const handleDayClose = async () => {
        if (sales.length === 0) { setShowCloseModal(false); return; }
        
        const activeSales = sales.filter(s => s.status !== 'cancelled');
        const getPaymentMethod = (x) => x.payment?.method || x.paymentMethod;
        const summary = {
          totalRevenue: activeSales.reduce((s, x) => s + x.price, 0),
          totalTax: activeSales.reduce((s, x) => s + (x.tax || 0), 0),
          cashRevenue: activeSales.filter(x => getPaymentMethod(x) === 'cash').reduce((s, x) => s + x.price, 0),
          cardRevenue: activeSales.filter(x => getPaymentMethod(x) === 'card').reduce((s, x) => s + x.price, 0),
          totalItems: activeSales.reduce((s, x) => s + (x.totalQty || x.totalQuantity || 0), 0),
          transactionCount: activeSales.length
        };

        const newRecord = {
          id: Date.now(),
          date: new Date().toISOString(),
          dateString: new Date(sales[0].timestamp).toDateString(),
          sales: [...sales],
          summary,
          productsSnapshot: products.map(p => ({ id: p.id, name: p.name, stock: p.stock }))
        };

        await saveDailyRecords([newRecord, ...dailyRecords]);
        await saveSales([]);
        setShowCloseModal(false);
      };

      const handleRestoreSales = async (record) => {
        if (sales.length > 0) {
          const activeSales = sales.filter(s => s.status !== 'cancelled');
          const getPaymentMethod = (x) => x.payment?.method || x.paymentMethod;
          const cr = {
            id: Date.now(),
            date: new Date(sales[0].timestamp).toISOString(),
            dateString: new Date(sales[0].timestamp).toDateString(),
            sales: [...sales],
            summary: {
              totalRevenue: activeSales.reduce((s, x) => s + x.price, 0),
              totalTax: activeSales.reduce((s, x) => s + (x.tax || 0), 0),
              cashRevenue: activeSales.filter(x => getPaymentMethod(x) === 'cash').reduce((s, x) => s + x.price, 0),
              cardRevenue: activeSales.filter(x => getPaymentMethod(x) === 'card').reduce((s, x) => s + x.price, 0),
              totalItems: activeSales.reduce((s, x) => s + (x.totalQty || x.totalQuantity || 0), 0),
              transactionCount: activeSales.length
            }
          };
          let ur = [...dailyRecords];
          const idx = ur.findIndex(r => r.dateString === cr.dateString);
          if (idx >= 0) ur[idx] = cr;
          else ur = [cr, ...ur];
          ur = ur.filter(r => r.id !== record.id);
          await saveDailyRecords(ur);
        } else {
          await saveDailyRecords(dailyRecords.filter(r => r.id !== record.id));
        }
        
        await saveSales([...record.sales]);
        setViewingRecord(null);
        setActiveTab('sales');
        setShowSalesHistory(true);
      };

      // ============ ë¦¬ì…‹ ============
      const handleResetAllData = async () => {
        await saveProducts(DEFAULT_PRODUCTS);
        await saveSales([]);
        await saveDailyRecords([]);
        await saveTaxRate(9.5);
        await saveLogs([]);
        setShowResetModal(false);
        setActiveTab('sales');
      };

      // ============ ì„¸ê¸ˆ ============
      const handleApplyTaxRate = async () => {
        const updatedSales = sales.map(sale => {
          if (sale.paymentMethod === 'card' && sale.cardType === 'square') {
            const basePrice = sale.basePrice || sale.price;
            const newTax = basePrice * (taxRate / 100);
            return { ...sale, basePrice, tax: newTax, price: basePrice + newTax };
          }
          return sale;
        });
        await saveSales(updatedSales);
      };

      // ============ í†µê³„ ============
      const getCurrentStats = () => {
        const activeSales = sales.filter(s => s.status !== 'cancelled');
        const totalRevenue = activeSales.reduce((s, x) => s + x.price, 0);
        const totalTax = activeSales.reduce((s, x) => s + (x.tax || 0), 0);
        
        // ìƒˆ/êµ¬ êµ¬ì¡° í˜¸í™˜
        const cashRevenue = activeSales.filter(x => {
          const payment = x.payment?.method || x.paymentMethod;
          return payment === 'cash';
        }).reduce((s, x) => s + x.price, 0);
        
        const cardRevenue = activeSales.filter(x => {
          const payment = x.payment?.method || x.paymentMethod;
          return payment === 'card';
        }).reduce((s, x) => s + x.price, 0);
        
        const totalItems = activeSales.reduce((s, x) => s + (x.totalQty || x.totalQuantity || 0), 0);
        
        let dateLabel = lang === 'ko' ? 'ì˜¤ëŠ˜' : 'Today';
        if (activeSales.length > 0) {
          const dates = [...new Set(activeSales.map(s => new Date(s.timestamp).toDateString()))];
          const today = new Date().toDateString();
          if (dates.length === 1 && dates[0] === today) dateLabel = lang === 'ko' ? 'ì˜¤ëŠ˜' : 'Today';
          else if (dates.length === 1) dateLabel = new Date(activeSales[0].timestamp).toLocaleDateString(lang === 'ko' ? 'ko-KR' : 'en-US', { month: 'short', day: 'numeric' });
          else dateLabel = t.currentList;
        }
        
        return { totalRevenue, totalTax, cashRevenue, cardRevenue, totalItems, count: activeSales.length, dateLabel };
      };

      const getStatsData = () => {
        let startDate, endDate = new Date();
        endDate.setHours(23, 59, 59, 999);
        
        if (statsPeriod === 'week') {
          startDate = new Date();
          startDate.setDate(startDate.getDate() - 7);
        } else if (statsPeriod === 'month') {
          startDate = new Date();
          startDate.setMonth(startDate.getMonth() - 1);
        } else {
          startDate = customStartDate ? new Date(customStartDate) : new Date();
          endDate = customEndDate ? new Date(customEndDate) : new Date();
          endDate.setHours(23, 59, 59, 999);
        }
        startDate.setHours(0, 0, 0, 0);

        let allSales = [...sales.filter(s => s.status !== 'cancelled')];
        dailyRecords.forEach(r => {
          allSales = allSales.concat((r.sales || []).filter(s => s.status !== 'cancelled'));
        });

        const filteredSales = allSales.filter(s => {
          const d = new Date(s.timestamp);
          return d >= startDate && d <= endDate;
        });

        const itemStats = {};
        filteredSales.forEach(sale => {
          // ìƒˆ êµ¬ì¡° (itemDetails) ë˜ëŠ” ê¸°ì¡´ êµ¬ì¡° (items) í˜¸í™˜
          if (sale.itemDetails) {
            sale.itemDetails.forEach(item => {
              if (!itemStats[item.id]) itemStats[item.id] = { qty: 0, name: item.name };
              itemStats[item.id].qty += item.qty;
            });
          } else if (sale.items) {
            Object.entries(sale.items).forEach(([itemId, qty]) => {
              if (!itemStats[itemId]) itemStats[itemId] = { qty: 0 };
              itemStats[itemId].qty += qty;
            });
          }
        });

        const totalRevenue = filteredSales.reduce((s, x) => s + x.price, 0);
        const totalQty = filteredSales.reduce((s, x) => s + (x.totalQty || x.totalQuantity || 0), 0);
        const sorted = Object.entries(itemStats)
          .map(([id, data]) => ({ id, name: data.name || getProductName(id), qty: data.qty }))
          .sort((a, b) => b.qty - a.qty);

        return { items: sorted, totalRevenue, totalQty, salesCount: filteredSales.length, startDate, endDate };
      };

      // ============ CSV ë‚´ë³´ë‚´ê¸° ============
      const exportCSV = () => {
        let allSales = [...sales];
        dailyRecords.forEach(r => { allSales = allSales.concat(r.sales || []); });
        allSales.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

        const headers = ['Date', 'Time', 'Category', 'Items', 'Qty', 'Base', 'Tax', 'Total', 'Payment', 'Type', 'Status', 'Memo'];
        const rows = allSales.map(sale => {
          const d = new Date(sale.timestamp);
          
          // ìƒˆ/êµ¬ êµ¬ì¡° í˜¸í™˜
          let itemList;
          if (sale.itemDetails) {
            itemList = sale.itemDetails.map(item => item.name + 'x' + item.qty).join(', ');
          } else if (sale.items) {
            itemList = Object.entries(sale.items).map(([id, qty]) => getProductName(id) + 'x' + qty).join(', ');
          } else {
            itemList = '';
          }
          
          const catName = sale.category?.name || sale.categoryName || '';
          const totalQty = sale.totalQty || sale.totalQuantity || 0;
          const paymentMethod = sale.payment?.method || sale.paymentMethod;
          const cardType = sale.payment?.type || sale.cardType;
          
          return [
            d.toLocaleDateString('en-US'),
            d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }),
            catName,
            itemList,
            totalQty,
            sale.basePrice || sale.price,
            sale.tax || 0,
            sale.price,
            paymentMethod === 'cash' ? 'Cash' : 'Card',
            cardType ? CARD_OPTIONS.find(o => o.id === cardType)?.name : '',
            sale.status === 'cancelled' ? 'CANCELLED' : 'Active',
            sale.memo || ''
          ];
        });

        const csvContent = [headers, ...rows].map(row => row.map(cell => '"' + cell + '"').join(',')).join('\n');
        const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'sales_' + new Date().toISOString().split('T')[0] + '.csv';
        link.click();
        URL.revokeObjectURL(url);
      };

      // ============ í—¬í¼ ============
      // ìƒˆ/êµ¬ êµ¬ì¡° í˜¸í™˜ í—¬í¼
      const getPaymentLabel = (sale) => {
        const method = sale.payment?.method || sale.paymentMethod;
        const type = sale.payment?.type || sale.cardType;
        if (method === 'cash') return 'ğŸ’µ';
        const opt = CARD_OPTIONS.find(o => o.id === type);
        return opt ? opt.emoji : 'ğŸ’³';
      };

      const getPaymentTypeName = (sale) => {
        const type = sale.payment?.type || sale.cardType;
        if (!type) return '';
        return CARD_OPTIONS.find(o => o.id === type)?.name || '';
      };

      const getSaleCategoryInfo = (sale) => {
        if (sale.category) {
          return { id: sale.category.id, name: sale.category.name };
        }
        return { id: sale.categoryId, name: sale.categoryName };
      };

      const getSaleTotalQty = (sale) => sale.totalQty || sale.totalQuantity || 0;

      const getSaleItemsList = (sale) => {
        if (sale.itemDetails) {
          return sale.itemDetails.map(item => ({ id: item.id, name: item.name, qty: item.qty }));
        }
        if (sale.items) {
          return Object.entries(sale.items).map(([id, qty]) => ({ id, name: getProductName(id), qty }));
        }
        return [];
      };

      const getCategoryEmoji = (catId) => {
        if (catId === 'mixed') return 'ğŸ›’';
        return CATEGORIES.find(c => c.id === catId)?.emoji || 'ğŸ“¦';
      };

      // ============ ê³„ì‚°ëœ ê°’ë“¤ (ë©”ëª¨ì´ì œì´ì…˜) ============
      
      // í˜„ì¬ í†µê³„ - salesë‚˜ langì´ ë°”ë€” ë•Œë§Œ ë‹¤ì‹œ ê³„ì‚°
      const currentStats = useMemo(() => getCurrentStats(), [sales, lang]);
      
      // ì´ ìˆ˜ëŸ‰ - selectedItemsê°€ ë°”ë€” ë•Œë§Œ ë‹¤ì‹œ ê³„ì‚°
      const totalQuantity = useMemo(() => getTotalQuantity(), [selectedItems]);
      
      // ê¸°ë³¸ ê°€ê²© - selectedItemsê°€ ë°”ë€” ë•Œë§Œ ë‹¤ì‹œ ê³„ì‚°
      const basePrice = useMemo(() => calculateTotalPrice(), [selectedItems, productsMap]);
      
      // ì„¸ê¸ˆ - ê´€ë ¨ ê°’ì´ ë°”ë€” ë•Œë§Œ ë‹¤ì‹œ ê³„ì‚°
      const currentTax = useMemo(() => 
        calculateTax(basePrice, paymentMethod, cardType), 
        [basePrice, paymentMethod, cardType, taxRate]
      );
      
      // ìµœì¢… ê°€ê²©
      const totalPrice = useMemo(() => basePrice + currentTax, [basePrice, currentTax]);

      useEffect(() => { setTempTaxRate(taxRate); }, [taxRate]);

      if (loading) return (
        <div className="min-h-screen bg-gray-100 flex items-center justify-center">
          <div className="text-xl text-gray-600">{t.loading}</div>
        </div>
      );

      // ============ UI ë Œë”ë§ ============
      return (
        <div className="min-h-screen bg-gray-100">
          {/* ìƒíƒœ ë°” */}
          <div className="text-center text-xs py-1 bg-green-100 text-green-800">{t.firebaseMode}</div>
          
          {/* íƒ­ ë„¤ë¹„ê²Œì´ì…˜ */}
          <div className="bg-white border-b sticky top-0 z-40">
            <div className="max-w-lg mx-auto flex">
              <button onClick={() => setActiveTab('sales')} className={`flex-1 py-4 text-center font-medium ${activeTab === 'sales' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'}`}>ğŸ’° {t.sales}</button>
              <button onClick={() => setActiveTab('history')} className={`flex-1 py-4 text-center font-medium ${activeTab === 'history' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'}`}>ğŸ“Š {t.history}</button>
              <button onClick={() => setLang(lang === 'ko' ? 'en' : 'ko')} className="px-4 py-4 text-gray-500 hover:text-blue-600 font-medium text-sm">{lang === 'ko' ? 'EN' : 'í•œ'}</button>
            </div>
          </div>

          <div className="p-4"><div className="max-w-lg mx-auto">
            
            {/* ========== íŒë§¤ íƒ­ ========== */}
            {activeTab === 'sales' && (<>
              {/* í—¤ë” */}
              <div className="bg-gradient-to-r from-blue-600 to-purple-600 rounded-2xl p-6 text-white mb-4 shadow-lg">
                <h1 className="text-2xl font-bold mb-1">ğŸ¯ {t.title}</h1>
                <p className="text-blue-100 text-sm">{t.subtitle}</p>
              </div>

              {/* ì˜¤ëŠ˜ í†µê³„ */}
              <div className="bg-white rounded-xl p-4 mb-4 shadow-sm">
                <div className="flex justify-between items-center mb-3">
                  <h2 className="text-sm font-semibold text-gray-500">ğŸ“Š {currentStats.dateLabel}</h2>
                  <button onClick={() => { setTempTaxRate(taxRate); setShowTaxModal(true); }} className="text-xs bg-gray-100 hover:bg-gray-200 px-2 py-1 rounded-full">âš™ï¸ {t.taxRate} {taxRate}%</button>
                </div>
                <div className="grid grid-cols-3 gap-3">
                  <div className="text-center"><div className="text-2xl font-bold text-green-600">{formatCurrency(currentStats.totalRevenue)}</div><div className="text-xs text-gray-500">{t.totalSales}</div></div>
                  <div className="text-center"><div className="text-lg font-semibold text-blue-600">{formatCurrency(currentStats.cashRevenue)}</div><div className="text-xs text-gray-500">ğŸ’µ {t.cash}</div></div>
                  <div className="text-center"><div className="text-lg font-semibold text-purple-600">{formatCurrency(currentStats.cardRevenue)}</div><div className="text-xs text-gray-500">ğŸ’³ {t.card}</div></div>
                </div>
                {currentStats.totalTax > 0 && <div className="mt-2 text-center text-xs text-gray-500">{t.taxIncluded}: {formatCurrency(currentStats.totalTax)}</div>}
                <div className="mt-3 pt-3 border-t flex justify-between items-center">
                  <span className="text-sm text-gray-500">{currentStats.count}{t.transactions} / {currentStats.totalItems}{t.items}</span>
                  <button onClick={() => setShowCloseModal(true)} className="text-sm bg-orange-100 hover:bg-orange-200 text-orange-700 px-3 py-1 rounded-full">ğŸŒ™ {t.closeDay}</button>
                </div>
              </div>

              {/* ìƒí’ˆ ì„ íƒ ì˜ì—­ */}
              <div className="bg-white rounded-xl p-4 mb-4 shadow-sm">
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-sm font-semibold text-gray-500">ğŸ’° {t.salesRecord}</h2>
                  <button onClick={() => setShowProductModal(true)} className="text-xs bg-purple-100 hover:bg-purple-200 text-purple-700 px-3 py-1 rounded-full">âœï¸ {t.productMgmt}</button>
                </div>

                {/* ì¹´í…Œê³ ë¦¬ íƒ­ */}
                <div className="mb-4 grid grid-cols-4 gap-1">
                  {CATEGORIES.map(cat => {
                    const catItems = selectedItems[cat.id] || {};
                    const catQty = Object.values(catItems).reduce((s, q) => s + q, 0);
                    return (
                      <button key={cat.id} onClick={() => setSelectedCategory(cat.id)} className={`p-2 rounded-lg border-2 text-xs relative ${selectedCategory === cat.id ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}`}>
                        {cat.emoji} {t[cat.id]}
                        {catQty > 0 && <span className="absolute -top-1 -right-1 w-4 h-4 bg-red-500 text-white rounded-full text-[10px] flex items-center justify-center">{catQty}</span>}
                      </button>
                    );
                  })}
                </div>

                {/* ê°€ê²© ì•Œê³ ë¦¬ì¦˜ ì•ˆë‚´ */}
                {selectedCategory === 'clicker' && <div className="mb-3 p-2 bg-blue-50 rounded-lg text-xs text-blue-700 text-center">ğŸ’¡ {t.algorithmApplied} (1=$12, 2=$20, 3=$32...)</div>}
                {selectedCategory === 'sticker' && <div className="mb-3 p-2 bg-pink-50 rounded-lg text-xs text-pink-700 text-center">ğŸ’¡ {t.stickerDeal} (1=$3, 2=$5, 3=$8...)</div>}

                {/* ìƒí’ˆ ê·¸ë¦¬ë“œ */}
                <div className="mb-4">
                  <label className="text-xs text-gray-500 mb-2 block">{t.tapToAdd}</label>
                  <div className="grid grid-cols-4 gap-2">
                    {currentProducts.map(product => {
                      const catItems = selectedItems[selectedCategory] || {};
                      const qty = catItems[product.id] || 0;
                      const stock = product.stock || 0;
                      return (
                        <button key={product.id} onClick={() => handleItemTap(product.id)} disabled={stock <= 0} className={`relative p-2 rounded-lg border-2 text-xs font-medium ${stock <= 0 ? 'border-gray-200 bg-gray-100 text-gray-400' : qty > 0 ? 'border-blue-500 bg-blue-100 text-blue-700' : 'border-gray-200 hover:border-blue-300'}`}>
                          <div className="truncate">{product.name}</div>
                          <div className="text-[10px] text-gray-400">{stock}{lang === 'ko' ? 'ê°œ' : ''}{product.price !== undefined && ` Â· $${product.price}`}</div>
                          {qty > 0 && <div className="absolute -top-2 -right-2 w-5 h-5 bg-blue-600 text-white rounded-full text-xs flex items-center justify-center font-bold">{qty}</div>}
                        </button>
                      );
                    })}
                  </div>
                </div>

                {/* ì„ íƒëœ ìƒí’ˆ ëª©ë¡ */}
                {Object.keys(selectedItems).length > 0 && (
                  <div className="mb-4 p-3 bg-gray-50 rounded-lg">
                    <div className="flex justify-between items-center mb-2">
                      <span className="text-xs text-gray-500">{t.selected}:</span>
                      <button onClick={clearSelection} className="text-xs text-red-500">{t.clearAll}</button>
                    </div>
                    <div className="space-y-2">
                      {Object.entries(selectedItems).map(([catId, catItems]) => {
                        const cat = CATEGORIES.find(c => c.id === catId);
                        return (
                          <div key={catId}>
                            <div className="text-xs text-gray-400 mb-1">{cat?.emoji} {t[catId]}</div>
                            <div className="flex flex-wrap gap-2">
                              {Object.entries(catItems).map(([id, qty]) => {
                                const product = getProduct(id);
                                return (
                                  <div key={id} className="flex items-center gap-1 bg-white px-2 py-1 rounded-full border text-sm">
                                    <span className="font-medium">{product?.name || id}</span>
                                    <span className="text-blue-600">Ã—{qty}</span>
                                    {product?.price && <span className="text-gray-400 text-xs">(${product.price * qty})</span>}
                                    <button onClick={() => handleItemDecrease(id, catId)} className="ml-1 w-5 h-5 bg-gray-200 hover:bg-red-200 rounded-full text-xs font-bold">âˆ’</button>
                                  </div>
                                );
                              })}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                    <div className="mt-2 pt-2 border-t text-center text-sm text-gray-600">{t.total} {totalQuantity}{t.items}</div>
                  </div>
                )}

                {/* ë©”ëª¨ */}
                <div className="mb-4">
                  <input type="text" value={saleMemo} onChange={e => saleDispatch({ type: 'SET_MEMO', value: e.target.value })} placeholder={`ğŸ“ ${t.memo}`} className="w-full p-2 border rounded-lg text-sm"/>
                </div>

                {/* ê²°ì œ ë°©ì‹ */}
                <div className="mb-4">
                  <label className="text-xs text-gray-500 mb-2 block">{t.paymentMethod}</label>
                  <div className="grid grid-cols-2 gap-2">
                    <button onClick={() => saleDispatch({ type: 'SET_PAYMENT_METHOD', value: 'cash' })} className={`p-3 rounded-lg border-2 flex items-center justify-center gap-2 ${paymentMethod === 'cash' ? 'border-green-500 bg-green-50' : 'border-gray-200'}`}>ğŸ’µ {t.cash}</button>
                    <button onClick={() => saleDispatch({ type: 'SET_PAYMENT_METHOD', value: 'card' })} className={`p-3 rounded-lg border-2 flex items-center justify-center gap-2 ${paymentMethod === 'card' ? 'border-purple-500 bg-purple-50' : 'border-gray-200'}`}>ğŸ’³ {t.card}</button>
                  </div>
                  {paymentMethod === 'card' && (
                    <div className="mt-2 grid grid-cols-3 gap-2">
                      {CARD_OPTIONS.map(opt => (
                        <button key={opt.id} onClick={() => saleDispatch({ type: 'SET_CARD_TYPE', value: opt.id })} className={`p-2 rounded-lg border-2 text-sm flex flex-col items-center ${cardType === opt.id ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}`}>
                          <span>{opt.emoji}</span>
                          <span className="text-xs">{opt.name}</span>
                          {opt.hasTax && <span className="text-[10px] text-orange-500">+{t.tax}</span>}
                        </button>
                      ))}
                    </div>
                  )}
                </div>

                {/* ê°€ê²© í‘œì‹œ */}
                {totalQuantity > 0 && (
                  <div className="mb-4 p-3 bg-gray-50 rounded-lg">
                    <div className="flex justify-between items-center">
                      <span className="text-sm font-medium">{t.total}:</span>
                      <label className="flex items-center gap-2 text-sm">
                        <input type="checkbox" checked={useCustomSalePrice} onChange={e => { 
                          saleDispatch({ type: 'SET_USE_CUSTOM_PRICE', value: e.target.checked }); 
                          if (!e.target.checked) { 
                            saleDispatch({ type: 'SET_CUSTOM_PRICE', value: basePrice }); 
                            saleDispatch({ type: 'SET_ADD_TAX', value: false }); 
                          } 
                        }} className="w-4 h-4"/>
                        {t.customInput}
                      </label>
                    </div>
                    {useCustomSalePrice ? (
                      <div className="mt-2">
                        <div className="flex items-center justify-center gap-2">
                          <span className="text-2xl">$</span>
                          <input type="number" min="0" step="0.01" value={customSalePrice} onChange={e => saleDispatch({ type: 'SET_CUSTOM_PRICE', value: parseFloat(e.target.value) || 0 })} className="w-28 p-2 text-2xl font-bold text-center border rounded-lg"/>
                        </div>
                        <div className="flex justify-center mt-2">
                          <button onClick={() => saleDispatch({ type: 'SET_ADD_TAX', value: !addTaxToCustom })} className={`px-3 py-1 rounded-full text-sm font-medium ${addTaxToCustom ? 'bg-orange-500 text-white' : 'bg-orange-100 text-orange-700'}`}>
                            {addTaxToCustom ? `âœ“ ${t.tax} ${taxRate}%` : t.addTax}
                          </button>
                        </div>
                        {addTaxToCustom && paymentMethod === 'card' && cardType === 'square' && (
                          <div className="text-center mt-2">
                            <span className="text-lg font-bold text-green-600">{formatCurrency(customSalePrice + customSalePrice * (taxRate / 100))}</span>
                            <div className="text-xs text-orange-500">{t.tax} {formatCurrency(customSalePrice * (taxRate / 100))} {lang === 'ko' ? 'í¬í•¨' : 'incl.'}</div>
                          </div>
                        )}
                        {addTaxToCustom && !(paymentMethod === 'card' && cardType === 'square') && (
                          <div className="text-center mt-2 text-xs text-gray-500">
                            {lang === 'ko' ? 'Square ì¹´ë“œ ê²°ì œ ì‹œì—ë§Œ ì„¸ê¸ˆì´ ì ìš©ë©ë‹ˆë‹¤' : 'Tax only applies to Square card payments'}
                          </div>
                        )}
                      </div>
                    ) : (
                      <div className="text-center mt-2">
                        <span className="text-2xl font-bold text-green-600">{formatCurrency(totalPrice)}</span>
                        {currentTax > 0 && <div className="text-xs text-orange-500">{t.tax} {formatCurrency(currentTax)} {lang === 'ko' ? 'í¬í•¨' : 'incl.'}</div>}
                      </div>
                    )}
                  </div>
                )}

                {/* íŒë§¤ ë²„íŠ¼ */}
                <button onClick={handleSale} disabled={totalQuantity === 0} className={`w-full py-4 rounded-xl text-white font-bold text-lg ${totalQuantity === 0 ? 'bg-gray-300' : 'bg-gradient-to-r from-green-500 to-emerald-600 shadow-lg'}`}>
                  {totalQuantity === 0 ? t.selectProduct : formatCurrency(
                    useCustomSalePrice 
                      ? (addTaxToCustom && paymentMethod === 'card' && cardType === 'square' 
                          ? customSalePrice + customSalePrice * (taxRate / 100) 
                          : customSalePrice)
                      : totalPrice
                  ) + ' ' + t.saleComplete + ' âœ“'}
                </button>
              </div>

              {/* íŒë§¤ ê¸°ë¡ í† ê¸€ */}
              <div className="flex gap-2 mb-4">
                <button onClick={() => setShowSalesHistory(!showSalesHistory)} className="flex-1 bg-white rounded-xl p-4 shadow-sm text-left flex justify-between items-center">
                  <span className="text-sm font-semibold text-gray-500">ğŸ“‹ {t.salesHistory} ({sales.length}{t.transactions})</span>
                  <span className="text-gray-400">{showSalesHistory ? 'â–²' : 'â–¼'}</span>
                </button>
                <button onClick={handleApplyTaxRate} className="bg-orange-100 hover:bg-orange-200 text-orange-700 rounded-xl px-4 shadow-sm text-sm font-medium">ğŸ“ {t.applyTax}</button>
              </div>

              {/* íŒë§¤ ê¸°ë¡ ëª©ë¡ */}
              {showSalesHistory && (
                <div className="bg-white rounded-xl p-4 shadow-sm mb-4">
                  {sales.length === 0 ? (
                    <p className="text-gray-500 text-center py-4">{t.noSalesRecord}</p>
                  ) : (
                    <div className="space-y-2 max-h-96 overflow-y-auto">
                      {sales.slice(0, 50).map(sale => {
                        const catInfo = getSaleCategoryInfo(sale);
                        const totalQty = getSaleTotalQty(sale);
                        const itemsList = getSaleItemsList(sale);
                        return (
                          <div key={sale.id} className={`p-3 rounded-lg ${sale.status === 'cancelled' ? 'bg-red-50 opacity-60' : 'bg-gray-50'}`}>
                            <div className="flex justify-between mb-2">
                              <div>
                                <div className="font-medium text-sm">
                                  {getCategoryEmoji(catInfo.id)} {t[catInfo.id] || catInfo.name} Ã—{totalQty}
                                  {sale.status === 'cancelled' && <span className="ml-2 text-xs bg-red-200 text-red-700 px-1 rounded">{t.cancelled}</span>}
                                </div>
                                <div className={`text-xs ${sale.status === 'cancelled' ? 'line-through text-gray-400' : 'text-gray-500'}`}>
                                  {itemsList.map(item => <span key={item.id} className="mr-2">{item.name} Ã—{item.qty}</span>)}
                                </div>
                                <div className="text-xs text-gray-400">{new Date(sale.timestamp).toLocaleString(lang === 'ko' ? 'ko-KR' : 'en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</div>
                                {sale.memo && <div className="text-xs text-blue-600 mt-1">ğŸ“ {sale.memo}</div>}
                              </div>
                              <div className="text-right">
                                <div className={`font-bold ${sale.status === 'cancelled' ? 'line-through text-gray-400' : 'text-green-600'}`}>{formatCurrency(sale.price)}</div>
                                {sale.tax > 0 && <div className="text-[10px] text-orange-500">{t.tax} {formatCurrency(sale.tax)}</div>}
                                <div className="text-xs">{getPaymentLabel(sale)} {getPaymentTypeName(sale)}</div>
                              </div>
                            </div>
                            {sale.status !== 'cancelled' && (
                              <div className="flex gap-2 pt-2 border-t">
                                <button onClick={() => startEditSale(sale)} className="flex-1 text-xs py-1 bg-blue-100 text-blue-700 rounded">âœï¸ {t.edit}</button>
                                <button onClick={() => handleCancelSale(sale)} className="flex-1 text-xs py-1 bg-red-100 text-red-700 rounded">ğŸ—‘ï¸ {t.cancel}</button>
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>
              )}
            </>)}

            {/* ========== ê¸°ë¡ íƒ­ ========== */}
            {activeTab === 'history' && (<>
              <div className="bg-gradient-to-r from-purple-600 to-pink-600 rounded-2xl p-6 text-white mb-4 shadow-lg">
                <h1 className="text-2xl font-bold mb-1">ğŸ“Š {t.history}</h1>
                <p className="text-purple-100 text-sm">{t.dailyRecord}</p>
              </div>

              <div className="grid grid-cols-3 gap-2 mb-4">
                <button onClick={() => setShowStatsModal(true)} className="bg-white rounded-xl p-3 shadow-sm text-center">
                  <span className="text-xl">ğŸ“ˆ</span>
                  <div className="text-xs font-medium text-gray-700 mt-1">{t.popularStats}</div>
                </button>
                <button onClick={exportCSV} className="bg-white rounded-xl p-3 shadow-sm text-center">
                  <span className="text-xl">ğŸ“¥</span>
                  <div className="text-xs font-medium text-gray-700 mt-1">{t.exportCSV}</div>
                </button>
                <button onClick={() => setShowLogsModal(true)} className="bg-white rounded-xl p-3 shadow-sm text-center">
                  <span className="text-xl">ğŸ“œ</span>
                  <div className="text-xs font-medium text-gray-700 mt-1">{t.logs}</div>
                </button>
              </div>

              {dailyRecords.length === 0 ? (
                <div className="bg-white rounded-xl p-8 text-center shadow-sm">
                  <div className="text-4xl mb-4">ğŸ“­</div>
                  <p className="text-gray-500">{t.noClosedRecord}</p>
                </div>
              ) : (
                <div className="space-y-3">
                  {dailyRecords.map(record => (
                    <div key={record.id} className="bg-white rounded-xl p-4 shadow-sm">
                      <div className="flex justify-between mb-3">
                        <div>
                          <div className="font-bold text-lg">{formatDate(record.date, lang)}</div>
                          <div className="text-sm text-gray-500">{record.summary.transactionCount}{t.transactions} / {record.summary.totalItems || 0}{t.items}</div>
                        </div>
                        <div className="text-right">
                          <div className="text-2xl font-bold text-green-600">{formatCurrency(record.summary.totalRevenue)}</div>
                          {record.summary.totalTax > 0 && <div className="text-xs text-orange-500">{t.tax} {formatCurrency(record.summary.totalTax)}</div>}
                        </div>
                      </div>
                      <div className="grid grid-cols-2 gap-2 mb-3">
                        <div className="bg-blue-50 rounded-lg p-2 text-center">
                          <div className="text-xs text-gray-500">ğŸ’µ {t.cash}</div>
                          <div className="font-semibold text-blue-600">{formatCurrency(record.summary.cashRevenue)}</div>
                        </div>
                        <div className="bg-purple-50 rounded-lg p-2 text-center">
                          <div className="text-xs text-gray-500">ğŸ’³ {t.card}</div>
                          <div className="font-semibold text-purple-600">{formatCurrency(record.summary.cardRevenue)}</div>
                        </div>
                      </div>
                      <div className="flex gap-2">
                        <button onClick={() => setViewingRecord(record)} className="flex-1 text-sm py-2 bg-gray-100 rounded-lg">ğŸ“‹ {t.detail}</button>
                        <button onClick={() => handleRestoreSales(record)} className="flex-1 text-sm py-2 bg-orange-100 text-orange-700 rounded-lg">â†©ï¸ {t.restore}</button>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              <div className="mt-8 pt-4 border-t">
                <button onClick={() => setShowResetModal(true)} className="w-full py-3 text-sm text-red-500 hover:bg-red-50 rounded-lg">ğŸ—‘ï¸ {t.resetAll}</button>
              </div>
            </>)}
          </div></div>

          {/* ========== ëª¨ë‹¬ë“¤ ========== */}
          
          {/* í†µê³„ ëª¨ë‹¬ */}
          {showStatsModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 w-full max-w-md max-h-[85vh] overflow-y-auto">
                <div className="flex justify-between items-center mb-4">
                  <h3 className="text-lg font-bold">ğŸ“ˆ {t.popularStats}</h3>
                  <button onClick={() => setShowStatsModal(false)} className="text-gray-400 text-xl">Ã—</button>
                </div>
                <div className="mb-4">
                  <div className="flex gap-2 mb-2">
                    <button onClick={() => setStatsPeriod('week')} className={`flex-1 p-2 rounded-lg border-2 text-sm ${statsPeriod === 'week' ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}`}>{t.week}</button>
                    <button onClick={() => setStatsPeriod('month')} className={`flex-1 p-2 rounded-lg border-2 text-sm ${statsPeriod === 'month' ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}`}>{t.month}</button>
                    <button onClick={() => setStatsPeriod('custom')} className={`flex-1 p-2 rounded-lg border-2 text-sm ${statsPeriod === 'custom' ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}`}>{t.custom}</button>
                  </div>
                  {statsPeriod === 'custom' && (
                    <div className="flex gap-2">
                      <input type="date" value={customStartDate} onChange={e => setCustomStartDate(e.target.value)} className="flex-1 p-2 border rounded-lg text-sm"/>
                      <span className="self-center">~</span>
                      <input type="date" value={customEndDate} onChange={e => setCustomEndDate(e.target.value)} className="flex-1 p-2 border rounded-lg text-sm"/>
                    </div>
                  )}
                </div>
                {(() => {
                  const stats = getStatsData();
                  return (<>
                    <div className="bg-gradient-to-r from-green-100 to-blue-100 rounded-xl p-4 mb-4">
                      <div className="text-xs text-gray-500 mb-1">{formatDateShort(stats.startDate, lang)} ~ {formatDateShort(stats.endDate, lang)}</div>
                      <div className="grid grid-cols-3 gap-2 text-center">
                        <div><div className="text-xl font-bold text-green-600">{formatCurrency(stats.totalRevenue)}</div><div className="text-xs text-gray-500">{t.totalRevenue}</div></div>
                        <div><div className="text-xl font-bold text-blue-600">{stats.totalQty}{t.items}</div><div className="text-xs text-gray-500">{t.soldCount}</div></div>
                        <div><div className="text-xl font-bold text-purple-600">{stats.salesCount}{t.transactions}</div><div className="text-xs text-gray-500">{t.transaction}</div></div>
                      </div>
                    </div>
                    <div className="space-y-2">
                      {stats.items.length === 0 ? (
                        <p className="text-gray-500 text-center py-4">{t.noDataPeriod}</p>
                      ) : stats.items.slice(0, 20).map((item, idx) => (
                        <div key={item.id} className="flex items-center gap-3 p-2 bg-gray-50 rounded-lg">
                          <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-white ${idx === 0 ? 'bg-yellow-500' : idx === 1 ? 'bg-gray-400' : idx === 2 ? 'bg-orange-400' : 'bg-gray-300'}`}>{idx + 1}</div>
                          <div className="flex-1">
                            <div className="font-medium text-sm">{item.name}</div>
                            <div className="text-xs text-gray-500">{item.qty}{t.items} {lang === 'ko' ? 'íŒë§¤' : 'sold'}</div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </>);
                })()}
                <button onClick={() => setShowStatsModal(false)} className="w-full mt-4 py-3 bg-gray-200 rounded-xl font-medium">{t.close}</button>
              </div>
            </div>
          )}

          {/* ì„¸ê¸ˆ ì„¤ì • ëª¨ë‹¬ */}
          {showTaxModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 w-full max-w-sm">
                <h3 className="text-lg font-bold mb-4">âš™ï¸ {t.taxSetting}</h3>
                <p className="text-sm text-gray-500 mb-4">{t.taxForSquare}</p>
                <div className="flex items-center justify-center gap-2 mb-4">
                  <input type="number" min="0" max="20" step="0.1" value={tempTaxRate} onChange={e => setTempTaxRate(parseFloat(e.target.value) || 0)} className="w-24 p-3 text-xl font-bold text-center border rounded-lg"/>
                  <span className="text-xl font-bold">%</span>
                </div>
                <div className="flex gap-2">
                  <button onClick={() => setShowTaxModal(false)} className="flex-1 py-3 rounded-xl bg-gray-200 font-medium">{t.cancel}</button>
                  <button onClick={() => { saveTaxRate(tempTaxRate); setShowTaxModal(false); }} className="flex-1 py-3 rounded-xl bg-blue-600 text-white font-medium">{t.save}</button>
                </div>
              </div>
            </div>
          )}

          {/* ìƒí’ˆ ê´€ë¦¬ ëª¨ë‹¬ */}
          {showProductModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 w-full max-w-md max-h-[80vh] overflow-y-auto">
                <div className="flex justify-between items-center mb-4">
                  <h3 className="text-lg font-bold">âœï¸ {t.productManagement}</h3>
                  <button onClick={() => setShowProductModal(false)} className="text-gray-400 text-xl">Ã—</button>
                </div>

                {/* ì¹´í…Œê³ ë¦¬ ì„ íƒ */}
                <div className="grid grid-cols-4 gap-1 mb-4">
                  {CATEGORIES.map(cat => (
                    <button key={cat.id} onClick={() => setSelectedCategory(cat.id)} className={`p-2 rounded-lg border-2 text-xs ${selectedCategory === cat.id ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}`}>
                      {cat.emoji} {t[cat.id]}
                    </button>
                  ))}
                </div>

                {/* ìƒˆ ìƒí’ˆ ì¶”ê°€ */}
                <div className="flex gap-2 mb-4">
                  <input type="text" value={newProductName} onChange={e => setNewProductName(e.target.value)} placeholder={t.newProduct} className="flex-1 p-2 border rounded-lg text-sm"/>
                  {selectedCategory !== 'clicker' && (
                    <input type="number" value={newProductPrice} onChange={e => setNewProductPrice(parseFloat(e.target.value) || 0)} placeholder="$" className="w-16 p-2 border rounded-lg text-sm text-center"/>
                  )}
                  <button onClick={handleAddProduct} disabled={!newProductName.trim()} className="px-4 py-2 bg-green-500 text-white rounded-lg text-sm font-medium disabled:bg-gray-300">+</button>
                </div>

                {/* ìƒí’ˆ ëª©ë¡ */}
                <div className="space-y-2">
                  {currentProducts.map(product => (
                    <div key={product.id} className="flex items-center gap-2 p-2 bg-gray-50 rounded-lg">
                      {editingProduct?.id === product.id ? (
                        <>
                          <input type="text" defaultValue={product.name} autoFocus id={`edit-name-${product.id}`} className="flex-1 p-1 border rounded text-sm"/>
                          {product.price !== undefined && (
                            <input type="number" defaultValue={product.price} id={`edit-price-${product.id}`} className="w-16 p-1 border rounded text-sm text-center"/>
                          )}
                          <input type="number" defaultValue={product.stock} id={`edit-stock-${product.id}`} className="w-16 p-1 border rounded text-sm text-center"/>
                          <button onClick={() => {
                            const name = document.getElementById(`edit-name-${product.id}`).value;
                            const price = document.getElementById(`edit-price-${product.id}`)?.value;
                            const stock = document.getElementById(`edit-stock-${product.id}`).value;
                            const updated = products.map(p => {
                              if (p.id === product.id) {
                                const result = { ...p, name, stock: parseInt(stock) || 0 };
                                if (price !== undefined) result.price = parseFloat(price) || 0;
                                return result;
                              }
                              return p;
                            });
                            saveProducts(updated);
                            setEditingProduct(null);
                          }} className="p-1 text-green-500">âœ“</button>
                          <button onClick={() => setEditingProduct(null)} className="p-1 text-gray-500">âœ•</button>
                        </>
                      ) : (
                        <>
                          <span className="flex-1 text-sm font-medium">{product.name}</span>
                          {product.price !== undefined && <span className="text-sm text-green-600 font-medium">${product.price}</span>}
                          <span className="text-sm text-blue-600">{product.stock}</span>
                          <button onClick={() => setEditingProduct(product)} className="p-1 text-blue-500">âœï¸</button>
                          <button onClick={() => handleDeleteProduct(product)} className="p-1 text-red-500">ğŸ—‘ï¸</button>
                        </>
                      )}
                    </div>
                  ))}
                </div>

                <button onClick={() => setShowProductModal(false)} className="w-full mt-4 py-3 bg-gray-200 rounded-xl font-medium">{t.close}</button>
              </div>
            </div>
          )}

          {/* íŒë§¤ ìˆ˜ì • ëª¨ë‹¬ */}
          {editingSale && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 w-full max-w-md max-h-[80vh] overflow-y-auto">
                <h3 className="text-lg font-bold mb-4">âœï¸ {t.editSale}</h3>
                <div className="mb-4 space-y-2">
                  {Object.entries(editItems).map(([id, qty]) => (
                    <div key={id} className="flex items-center justify-between p-2 bg-gray-50 rounded">
                      <span className="font-medium">{getProductName(id)}</span>
                      <div className="flex items-center gap-2">
                        <button onClick={() => handleEditItemChange(id, -1)} className="w-8 h-8 bg-gray-200 rounded-full font-bold">âˆ’</button>
                        <span className="w-8 text-center font-bold">{qty}</span>
                        <button onClick={() => handleEditItemChange(id, 1)} className="w-8 h-8 bg-gray-200 rounded-full font-bold">+</button>
                      </div>
                    </div>
                  ))}
                </div>
                <div className="mb-4">
                  <input type="text" value={editMemo} onChange={e => editDispatch({ type: 'SET_MEMO', value: e.target.value })} placeholder={`ğŸ“ ${t.memo}`} className="w-full p-2 border rounded-lg text-sm"/>
                </div>
                <div className="mb-4 p-3 bg-blue-50 rounded-lg">
                  <div className="flex justify-between mb-2">
                    <span className="text-sm">{t.amount}:</span>
                    <label className="flex items-center gap-2 text-xs">
                      <input type="checkbox" checked={useCustomPrice} onChange={e => editDispatch({ type: 'SET_USE_CUSTOM_PRICE', value: e.target.checked })}/>
                      {t.customInput}
                    </label>
                  </div>
                  {useCustomPrice ? (
                    <div className="flex items-center justify-center gap-2">
                      <span className="text-xl">$</span>
                      <input type="number" min="0" value={editPrice} onChange={e => editDispatch({ type: 'SET_PRICE', value: parseFloat(e.target.value) || 0 })} className="w-24 p-2 text-xl font-bold text-center border rounded-lg"/>
                    </div>
                  ) : (
                    <div className="text-center">
                      <span className="text-xl font-bold text-green-600">{formatCurrency(editPrice)}</span>
                    </div>
                  )}
                </div>
                <div className="mb-4">
                  <label className="text-xs text-gray-500 mb-2 block">{t.paymentMethod}</label>
                  <div className="grid grid-cols-2 gap-2 mb-2">
                    <button onClick={() => editDispatch({ type: 'SET_PAYMENT_METHOD', value: 'cash' })} className={`p-2 rounded-lg border-2 ${editPaymentMethod === 'cash' ? 'border-green-500 bg-green-50' : 'border-gray-200'}`}>ğŸ’µ {t.cash}</button>
                    <button onClick={() => editDispatch({ type: 'SET_PAYMENT_METHOD', value: 'card' })} className={`p-2 rounded-lg border-2 ${editPaymentMethod === 'card' ? 'border-purple-500 bg-purple-50' : 'border-gray-200'}`}>ğŸ’³ {t.card}</button>
                  </div>
                  {editPaymentMethod === 'card' && (
                    <div className="grid grid-cols-3 gap-2">
                      {CARD_OPTIONS.map(opt => (
                        <button key={opt.id} onClick={() => editDispatch({ type: 'SET_CARD_TYPE', value: opt.id })} className={`p-2 rounded-lg border-2 text-sm ${editCardType === opt.id ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}`}>
                          {opt.emoji} {opt.name}
                        </button>
                      ))}
                    </div>
                  )}
                </div>
                <div className="flex gap-2">
                  <button onClick={() => editDispatch({ type: 'CLOSE_EDIT' })} className="flex-1 py-3 rounded-xl bg-gray-200 font-medium">{t.cancel}</button>
                  <button onClick={handleSaveEdit} disabled={Object.keys(editItems).length === 0} className={`flex-1 py-3 rounded-xl font-medium ${Object.keys(editItems).length === 0 ? 'bg-gray-300' : 'bg-blue-600 text-white'}`}>{t.save}</button>
                </div>
              </div>
            </div>
          )}

          {/* ë§ˆê° í™•ì¸ ëª¨ë‹¬ */}
          {showCloseModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 w-full max-w-sm">
                <h3 className="text-lg font-bold mb-2">ğŸŒ™ {t.closeDay}</h3>
                <p className="text-gray-600 text-sm mb-4">{t.closeDayConfirm}</p>
                <div className="bg-gray-50 rounded-lg p-3 mb-4">
                  <div className="flex justify-between text-sm mb-1"><span>{t.totalSales}</span><span className="font-bold text-green-600">{formatCurrency(currentStats.totalRevenue)}</span></div>
                  {currentStats.totalTax > 0 && <div className="flex justify-between text-sm mb-1"><span>{t.tax}</span><span className="text-orange-500">{formatCurrency(currentStats.totalTax)}</span></div>}
                  <div className="flex justify-between text-sm mb-1"><span>ğŸ’µ {t.cash}</span><span>{formatCurrency(currentStats.cashRevenue)}</span></div>
                  <div className="flex justify-between text-sm"><span>ğŸ’³ {t.card}</span><span>{formatCurrency(currentStats.cardRevenue)}</span></div>
                </div>
                <div className="flex gap-2">
                  <button onClick={() => setShowCloseModal(false)} className="flex-1 py-3 rounded-xl bg-gray-200 font-medium">{t.cancel}</button>
                  <button onClick={handleDayClose} className="flex-1 py-3 rounded-xl bg-orange-500 text-white font-medium">{t.finalize}</button>
                </div>
              </div>
            </div>
          )}

          {/* ìƒì„¸ ê¸°ë¡ ëª¨ë‹¬ */}
          {viewingRecord && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 w-full max-w-md max-h-[80vh] overflow-y-auto">
                <div className="flex justify-between items-start mb-4">
                  <div>
                    <h3 className="text-lg font-bold">{formatDate(viewingRecord.date, lang)}</h3>
                    <p className="text-sm text-gray-500">{t.detailRecord}</p>
                  </div>
                  <button onClick={() => setViewingRecord(null)} className="text-gray-400 text-xl">Ã—</button>
                </div>
                <div className="bg-green-50 rounded-lg p-3 mb-4 text-center">
                  <div className="text-2xl font-bold text-green-600">{formatCurrency(viewingRecord.summary.totalRevenue)}</div>
                  {viewingRecord.summary.totalTax > 0 && <div className="text-xs text-orange-500">{t.tax} {formatCurrency(viewingRecord.summary.totalTax)}</div>}
                  <div className="text-sm text-gray-500">{viewingRecord.summary.transactionCount}{t.transactions} / {viewingRecord.summary.totalItems || 0}{t.items}</div>
                </div>
                <div className="space-y-2 mb-4">
                  {viewingRecord.sales.map(sale => {
                    const catInfo = getSaleCategoryInfo(sale);
                    const totalQty = getSaleTotalQty(sale);
                    const itemsList = getSaleItemsList(sale);
                    return (
                      <div key={sale.id} className={`p-3 rounded-lg ${sale.status === 'cancelled' ? 'bg-red-50 opacity-60' : 'bg-gray-50'}`}>
                        <div className="flex justify-between">
                          <div>
                            <div className="font-medium text-sm">
                              {getCategoryEmoji(catInfo.id)} {t[catInfo.id] || catInfo.name} Ã—{totalQty}
                              {sale.status === 'cancelled' && <span className="ml-2 text-xs bg-red-200 text-red-700 px-1 rounded">{t.cancelled}</span>}
                            </div>
                            <div className="text-xs text-gray-500">
                              {itemsList.map(item => <span key={item.id} className="mr-2">{item.name} Ã—{item.qty}</span>)}
                            </div>
                            {sale.memo && <div className="text-xs text-blue-600 mt-1">ğŸ“ {sale.memo}</div>}
                          </div>
                          <div className="text-right">
                            <div className={`font-bold ${sale.status === 'cancelled' ? 'line-through text-gray-400' : 'text-green-600'}`}>{formatCurrency(sale.price)}</div>
                            {sale.tax > 0 && <div className="text-[10px] text-orange-500">{t.tax} {formatCurrency(sale.tax)}</div>}
                            <div className="text-xs">{getPaymentLabel(sale)} {getPaymentTypeName(sale)}</div>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
                <button onClick={() => handleRestoreSales(viewingRecord)} className="w-full py-3 bg-orange-100 text-orange-700 rounded-xl font-medium">â†©ï¸ {t.restore}</button>
              </div>
            </div>
          )}

          {/* ë¦¬ì…‹ í™•ì¸ ëª¨ë‹¬ */}
          {showResetModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 w-full max-w-sm">
                <h3 className="text-lg font-bold mb-2 text-red-600">âš ï¸ {t.resetAll}</h3>
                <p className="text-gray-600 text-sm mb-4">{t.resetConfirm}</p>
                <div className="bg-red-50 rounded-lg p-3 mb-4 text-sm text-red-700">
                  <div>â€¢ {t.resetWarning1}</div>
                  <div>â€¢ {t.resetWarning2}</div>
                  <div>â€¢ {t.resetWarning3}</div>
                  <div>â€¢ {t.resetWarning4}</div>
                </div>
                <div className="flex gap-2">
                  <button onClick={() => setShowResetModal(false)} className="flex-1 py-3 rounded-xl bg-gray-200 font-medium">{t.cancel}</button>
                  <button onClick={handleResetAllData} className="flex-1 py-3 rounded-xl bg-red-500 text-white font-medium">{t.reset}</button>
                </div>
              </div>
            </div>
          )}

          {/* ë¡œê·¸ ëª¨ë‹¬ */}
          {showLogsModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-2xl p-6 w-full max-w-md max-h-[85vh] overflow-y-auto">
                <div className="flex justify-between items-center mb-4">
                  <h3 className="text-lg font-bold">ğŸ“œ {t.logs}</h3>
                  <button onClick={() => setShowLogsModal(false)} className="text-gray-400 text-xl">Ã—</button>
                </div>
                {logs.length === 0 ? (
                  <p className="text-gray-500 text-center py-8">{t.noLogs}</p>
                ) : (
                  <div className="space-y-2">
                    {logs.slice(0, 100).map(log => {
                      const time = new Date(log.timestamp).toLocaleString(lang === 'ko' ? 'ko-KR' : 'en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                      let icon, label, details, bgColor;
                      switch(log.action) {
                        case 'sale_created': icon = 'ğŸ’°'; label = t.saleCreated; details = formatCurrency(log.price); bgColor = 'bg-green-50'; break;
                        case 'sale_cancelled': icon = 'ğŸ—‘ï¸'; label = t.saleCancelled; details = formatCurrency(log.price); bgColor = 'bg-red-50'; break;
                        case 'sale_edited': icon = 'âœï¸'; label = t.saleEdited; details = `${formatCurrency(log.before?.price || 0)} â†’ ${formatCurrency(log.after?.price || 0)}`; bgColor = 'bg-blue-50'; break;
                        case 'inventory_changed': icon = 'ğŸ“¦'; label = t.inventoryChanged; details = ''; bgColor = 'bg-yellow-50'; break;
                        default: icon = 'ğŸ“'; label = log.action; details = ''; bgColor = 'bg-gray-50';
                      }
                      return (
                        <div key={log.id} className={`p-3 rounded-lg ${bgColor}`}>
                          <div className="flex justify-between items-start">
                            <div>
                              <div className="font-medium text-sm">{icon} {label}</div>
                              {details && <div className="text-xs text-gray-600">{details}</div>}
                              {log.items && (
                                <div className="text-xs text-gray-500">
                                  {Object.entries(log.items).map(([id, qty]) => <span key={id} className="mr-2">{getProductName(id)} Ã—{qty}</span>)}
                                </div>
                              )}
                            </div>
                            <div className="text-xs text-gray-400">{time}</div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                )}
                <button onClick={() => setShowLogsModal(false)} className="w-full mt-4 py-3 bg-gray-200 rounded-xl font-medium">{t.close}</button>
              </div>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>
